<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test — QDTU LMS</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#7c3aed; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --shadow: 0 18px 50px rgba(2,6,23,.10);
      --ring: 0 0 0 4px rgba(37,99,235,.18);
      --grid: rgba(15,23,42,.06);
    }
    .dark{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#223047;
      --shadow: 0 20px 70px rgba(0,0,0,.45);
      --grid: rgba(148,163,184,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    a{color:inherit}
    .bg{
      position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(1100px 500px at 10% 10%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(900px 500px at 92% 18%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 600px at 50% 92%, rgba(16,185,129,.14), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }
    .gridbg{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image: linear-gradient(to right, var(--grid) 1px, transparent 1px),
                        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 72px 72px;
      mask-image: radial-gradient(closest-side at 50% 35%, black 0%, transparent 72%);
      opacity:.85;
    }

    header{
      position:sticky; top:0; z-index:50;
      padding:14px 16px;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 72%, transparent);
      border-bottom:1px solid color-mix(in oklab, var(--border) 70%, transparent);
    }
    .nav{
      max-width:1100px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: var(--shadow);
    }
    .pills{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid color-mix(in oklab, var(--border) 80%, transparent); background: color-mix(in oklab, var(--card) 85%, transparent)}
    .badge{font-weight:900; letter-spacing:.6px}
    .badge.student{color:var(--ok)}
    .badge.teacher{color:color-mix(in oklab, var(--primary) 88%, white)}
    .badge.admin{color:var(--warn)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text);
      padding:10px 12px; border-radius:12px; text-decoration:none; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      transition: transform .08s ease, filter .12s ease, background .12s ease;
      user-select:none;
      font-weight:650;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, var(--primary), var(--primary2)); color:#fff; border-color:transparent}
    .btn.danger{background: linear-gradient(135deg, #ef4444, #fb7185); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px; border-radius:11px; font-size:13px; font-weight:800}

    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{
      background: color-mix(in oklab, var(--card) 96%, transparent);
      border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
      border-radius:16px; padding:16px;
      box-shadow: 0 8px 28px rgba(2,6,23,.06);
    }
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-4{grid-column:span 4}
    @media (max-width:980px){ .col-8,.col-4{grid-column:span 12} }

    .muted{color:var(--muted);font-size:13px;line-height:1.55}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .divider{height:1px;background:color-mix(in oklab, var(--border) 85%, transparent); margin:12px 0}
    .tiny{font-size:12px;color:var(--muted)}
    footer{padding:18px 16px;color:var(--muted);text-align:center}

    .err,.ok{
      border-radius:14px; padding:12px 14px; margin:14px 0; display:none;
      border:1px solid transparent;
    }
    .err{background: color-mix(in oklab, #ffedd5 65%, var(--card)); border-color:#fed7aa; color:#9a3412}
    .ok{background: color-mix(in oklab, #dcfce7 50%, var(--card)); border-color:#86efac; color:#065f46}

    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{flex:1; min-width:160px; padding:12px; border-radius:16px; border:1px dashed color-mix(in oklab, var(--border) 85%, transparent); background: color-mix(in oklab, var(--card) 92%, transparent)}
    .kpi .val{font-size:20px; font-weight:950; margin-top:4px}
    .kpi .label{font-size:12px;color:var(--muted)}

    .bar{height:12px;border-radius:999px;background:color-mix(in oklab, var(--border) 85%, transparent); overflow:hidden}
    .bar > div{height:100%; width:0%; background: linear-gradient(135deg, var(--primary), var(--primary2)); transition: width .25s ease}

    .qcard{border:1px solid color-mix(in oklab, var(--border) 85%, transparent); border-radius:16px; padding:14px; background: color-mix(in oklab, var(--card) 96%, transparent)}
    .qtitle{font-weight:950}
    .opt{display:flex; gap:10px; align-items:flex-start; padding:10px 10px; border-radius:14px; border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
      background: color-mix(in oklab, var(--card) 92%, transparent); cursor:pointer; transition: transform .08s ease, filter .12s ease}
    .opt:hover{filter:brightness(1.01)}
    .opt:active{transform:translateY(1px)}
    .opt input{margin-top:3px}
    .opt.sel{outline: 4px solid rgba(37,99,235,.18); border-color:transparent}
    .warnBox{border:1px solid #fde68a; background: color-mix(in oklab, #fef9c3 45%, var(--card)); color:#854d0e; border-radius:14px; padding:12px; display:none}
    code{background:color-mix(in oklab, var(--card) 92%, transparent);border:1px solid color-mix(in oklab, var(--border) 85%, transparent);border-radius:10px;padding:2px 7px}
  </style>
  <script>
    (function(){
      const key="theme";
      const saved=localStorage.getItem(key);
      const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode=saved || (prefersDark ? "dark" : "light");
      if(mode==="dark") document.documentElement.classList.add("dark");
    })();
  </script>
  <link rel="stylesheet" href="/ui-glass-theme.css" />
</head>
<body>
  <div class="bg"></div><div class="gridbg"></div>

  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="pills">
          <span id="roleBadge" class="pill badge student">STUDENT</span>
          <span id="mePill" class="pill" style="display:none"></span>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost small" id="themeBtn">🌓 Tema</button>
        <a class="btn ghost small" href="/tests.html">Testlar</a>
        <a class="btn ghost small" href="/courses.html">Kurslar</a>
        <a class="btn ghost small" id="dashLink" href="/student-dashboard.html">Dashboard</a>
        <button class="btn danger small" id="logoutBtn">Chiqish</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="errBox" class="err"></div>
    <div id="okBox" class="ok"></div>

    <div class="grid">
      <div class="card col-8">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <h2 id="title" style="margin:0;font-size:20px">Yuklanmoqda...</h2>
            <div class="muted" id="desc" style="margin-top:6px">—</div>
            <div class="tiny" style="margin-top:8px">Course: <code id="courseIdTxt">—</code></div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn small" id="startBtn">Boshlash</button>
            <button class="btn small danger" id="finishBtn" style="display:none">Yakunlash</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="box">
            <div class="label">Timer</div>
            <div class="val" id="timerTxt">—</div>
          </div>
          <div class="box">
            <div class="label">Progress</div>
            <div class="val"><span id="progressTxt">0/0</span></div>
          </div>
          <div class="box">
            <div class="label">Passing %</div>
            <div class="val" id="passTxt">—</div>
          </div>
          <div class="box">
            <div class="label">Qoidalar</div>
            <div class="val" style="font-size:13px">Focus</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="warnBox" id="warnBox">Diqqat: sahifani tark etsangiz yoki ko‘p marta “blur” bo‘lsa, test bekor qilinishi mumkin.</div>

        <div class="divider"></div>

        <div id="qArea" class="qcard" style="display:none">
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div>
              <div class="tiny" id="qIdxTxt">Savol —</div>
              <div class="qtitle" id="qTxt" style="margin-top:6px">—</div>
            </div>
            <div class="tiny" id="qMeta">—</div>
          </div>

          <div class="divider"></div>

          <div id="opts" style="display:flex; flex-direction:column; gap:10px"></div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <button class="btn small" id="prevBtn">← Oldingi</button>
            <button class="btn small primary" id="nextBtn">Keyingi →</button>
          </div>
        </div>

        <div class="muted" id="preHint">Testni boshlash uchun “Boshlash” tugmasini bosing.</div>
      </div>

      <div class="card col-4">
        <h3 style="margin:0 0 10px 0">Natija</h3>
        <div class="muted">Test tugagandan so‘ng natija shu yerda ko‘rinadi.</div>
        <div class="divider"></div>
        <div id="resultBox" class="muted">—</div>
        <div class="divider"></div>
        <div class="tiny">
          Test yakunlanganda natija avtomatik saqlanadi va kurs progressiga bog‘lanadi.
        </div>
      </div>
    </div>
  </div>

  <footer>QDTU LMS — Test Engine (Timer + Anti-cheat)</footer>

<script>
  const API_BASE = "";
  const $ = (id)=> document.getElementById(id);
  function qs(name){ return new URLSearchParams(location.search).get(name); }
  function getToken(){ return localStorage.getItem("token") || ""; }

  function setErr(msg){ $("errBox").textContent=msg; $("errBox").style.display="block"; $("okBox").style.display="none"; }
  function setOk(msg){ $("okBox").textContent=msg; $("okBox").style.display="block"; $("errBox").style.display="none"; }
  function clearMsg(){ $("errBox").style.display="none"; $("okBox").style.display="none"; }

  async function apiFetch(url, opts={}){
    const token = getToken();
    const headers = Object.assign({}, opts.headers || {});
    if(token) headers["Authorization"] = "Bearer " + token;
    const res = await fetch(API_BASE + url, Object.assign({}, opts, { headers }));
    let data = null;
    const ct = res.headers.get("content-type") || "";
    if(ct.includes("application/json")){
      try{ data = await res.json(); }catch{ data = null; }
    }else{
      try{ data = await res.text(); }catch{ data = null; }
    }
    if(!res.ok){
      const msg = (data && data.error) ? data.error : ("So'rov xatosi: " + res.status);
      const err = new Error(msg);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  // theme
  $("themeBtn").addEventListener("click", ()=>{
    document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
  });

  $("logoutBtn").addEventListener("click", ()=>{
    localStorage.removeItem("token");
    location.href="/login.html";
  });

  async function apiMe(){
    const token = getToken();
    if(!token){ location.href="/login.html"; return null; }
    try{ return await apiFetch("/api/me"); }
    catch(e){ localStorage.removeItem("token"); location.href="/login.html"; return null; }
  }

  // demo storage
  function demoKey(){ return "demoTests_v2"; }
  function readDemo(){ try{ return JSON.parse(localStorage.getItem(demoKey()) || "[]"); }catch{ return []; } }
  function seedDemo(){
    const cur = readDemo();
    if(cur.length) return;
    const seed = [
      {
        id:"t1",
        title:"Energetika — 1-mavzu",
        description:"Nazariy savollar.",
        status:"published",
        courseId:"c1",
        timeMin:10,
        passPct:60,
        teacherName:"Teacher Demo",
        createdAt: Date.now() - 86400000,
        questions:[
          { q:"Energiya nimaga teng?", a:"Ish", b:"Kuch", c:"Bosim", d:"Tezlik", correct:"A" },
          { q:"Quvvat birligi?", a:"Vatt", b:"Nyuton", c:"Paskal", d:"Joul", correct:"A" }
        ]
      }
    ];
    localStorage.setItem(demoKey(), JSON.stringify(seed));
  }

  function normalizeTest(raw){
    const incomingQuestions = Array.isArray(raw.questions) ? raw.questions : (Array.isArray(raw.items) ? raw.items : []);
    const questions = incomingQuestions.map((q)=> {
      const options = Array.isArray(q.options) ? q.options : [];
      const pick = (k) => {
        const f = options.find((o)=> String(o.key || "").toUpperCase() === k);
        return String(f?.text || q[k.toLowerCase()] || "");
      };
      return {
        q: q.q || q.text || q.question || "",
        a: q.a || pick("A"),
        b: q.b || pick("B"),
        c: q.c || pick("C"),
        d: q.d || pick("D"),
        correct: (q.correct || q.answerKey || q.ans || "").toUpperCase()
      };
    }).filter((q)=> q.q && q.a && q.b && q.c && q.d);

    return {
      id: raw._id || raw.id || raw.testId,
      title: raw.title || raw.name || "Nomsiz test",
      description: raw.description || raw.desc || "",
      status: raw.status || (raw.published ? "published" : "draft"),
      courseId: raw.courseId || raw.course?._id || raw.course || "",
      timeMin: Number(raw.timeMin || raw.durationMin || 10),
      passPct: Number(raw.passPct || raw.passingPercent || 60),
      teacherName: raw.teacherName || raw.teacher?.fullname || raw.teacher?.name || raw.ownerName || "",
      questions
    };
  }

  async function fetchTest(id){
    // API direct
    try{
      const data = await apiFetch("/api/tests/" + encodeURIComponent(id));
      return normalizeTest(data.test || data);
    }catch(e){
      // API list fallback
      try{
        const data = await apiFetch("/api/tests");
        const list = Array.isArray(data) ? data : (data.tests || []);
        const t = list.map(normalizeTest).find(x=>String(x.id)===String(id));
        if(t) return t;
      }catch(_){}
      // demo
      seedDemo();
      const t = readDemo().map(normalizeTest).find(x=>String(x.id)===String(id));
      if(!t) throw new Error("Test topilmadi.");
      return t;
    }
  }

  // anti-cheat (soft)
  let blurCount = 0;
  function antiCheatEnable(){
    $("warnBox").style.display="block";
    window.addEventListener("blur", ()=>{
      blurCount++;
      if(blurCount >= 3){
        setErr("Siz sahifani ko‘p marta tark etdingiz (blur). Test yakunlandi.");
        finishTest(true);
      }else{
        $("warnBox").textContent = `Diqqat: sahifani tark etdingiz. Blur count: ${blurCount}/3`;
      }
    });
    document.addEventListener("copy", (e)=> e.preventDefault());
    document.addEventListener("cut", (e)=> e.preventDefault());
    document.addEventListener("paste", (e)=> e.preventDefault());
    document.addEventListener("contextmenu", (e)=> e.preventDefault());
  }

  // state
  let state = {
    me:null,
    test:null,
    idx:0,
    answers:{}, // qIndex -> "A"/"B"/"C"/"D"
    started:false,
    startMs:0,
    endMs:0,
    timer:null,
    remainingSec:0
  };

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function updateKpi(){
    const total = state.test?.questions?.length || 0;
    const answered = Object.keys(state.answers).length;
    $("progressTxt").textContent = `${answered}/${total}`;
    $("timerTxt").textContent = state.started ? fmtTime(state.remainingSec) : "—";
    $("passTxt").textContent = String(state.test?.passPct || 60) + "%";
  }

  function renderQuestion(){
    const t = state.test;
    const total = t.questions.length;
    state.idx = Math.min(Math.max(state.idx, 0), total-1);
    const q = t.questions[state.idx];

    $("qArea").style.display="block";
    $("preHint").style.display="none";
    $("finishBtn").style.display="inline-flex";
    $("startBtn").style.display="none";

    $("qIdxTxt").textContent = `Savol ${state.idx+1} / ${total}`;
    $("qTxt").textContent = q.q || "(savol matni yo‘q)";
    $("qMeta").textContent = `Time: ${Number(t.timeMin||10)} min • Pass: ${Number(t.passPct||60)}%`;

    const opts = $("opts");
    opts.innerHTML = "";
    const variants = [
      ["A", q.a],
      ["B", q.b],
      ["C", q.c],
      ["D", q.d]
    ];

    const chosen = state.answers[String(state.idx)] || "";
    variants.forEach(([key, text])=>{
      const div = document.createElement("div");
      div.className = "opt" + (chosen===key ? " sel" : "");
      div.innerHTML = `
        <input type="radio" name="opt" ${chosen===key?"checked":""}/>
        <div>
          <div style="font-weight:950">${key})</div>
          <div class="muted" style="margin-top:2px">${text || "-"}</div>
        </div>
      `;
      div.addEventListener("click", ()=>{
        state.answers[String(state.idx)] = key;
        renderQuestion();
        updateKpi();
      });
      opts.appendChild(div);
    });

    $("prevBtn").disabled = state.idx===0;
    $("nextBtn").textContent = (state.idx===total-1) ? "Yakunlash →" : "Keyingi →";
  }

  function calcScore(){
    const qs = state.test.questions || [];
    let correct = 0;
    qs.forEach((q,i)=>{
      const a = state.answers[String(i)] || "";
      if(String(a).toUpperCase() === String(q.correct || "").toUpperCase()) correct++;
    });
    const total = qs.length || 0;
    const pct = total ? Math.round((correct/total)*100) : 0;
    return { correct, total, pct };
  }

  async function submitToAPI(payload){
    // preferred: /api/tests/:id/submit
    try{
      const data = await apiFetch("/api/tests/" + encodeURIComponent(state.test.id) + "/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      return { ok:true, data };
    }catch(e){
      // fallback: /api/test/submit
      try{
        const data = await apiFetch("/api/test/submit", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ testId: state.test.id, ...payload })
        });
        return { ok:true, data };
      }catch(err){
        return { ok:false, error: err };
      }
    }
  }

  function demoStoreResult(uid, testId, result){
    const key = `test_result_${uid || "anon"}_${testId}`;
    localStorage.setItem(key, JSON.stringify(result));
  }

  async function finishTest(forced=false){
    if(!state.started) return;
    clearMsg();
    state.started = false;
    if(state.timer){ clearInterval(state.timer); state.timer=null; }

    const { correct, total, pct } = calcScore();
    const pass = pct >= Number(state.test.passPct||60);

    $("resultBox").innerHTML = `
      <div style="font-weight:950">Natija:</div>
      <div class="tiny" style="margin-top:6px">To‘g‘ri: <b>${correct}</b> / ${total}</div>
      <div class="tiny">Ball: <b>${pct}%</b></div>
      <div class="tiny">Holat: <b style="color:${pass ? "var(--ok)" : "var(--danger)"}">${pass ? "PASSED" : "FAILED"}</b></div>
      ${forced ? `<div class="tiny" style="margin-top:6px">Sabab: anti-cheat (blur) yoki vaqt tugadi.</div>` : ``}
    `;

    // send to server if possible
    const payload = {
      answers: state.answers,
      startedAt: state.startMs,
      finishedAt: Date.now(),
      durationSec: Math.max(0, (Date.now()-state.startMs)/1000),
      forced: !!forced
    };

    const res = await submitToAPI(payload);
    if(res.ok){
      setOk("Test natijasi serverga yuborildi.");
    }else{
      // demo store
      const uid = state.me?._id || state.me?.id || state.me?.username;
      demoStoreResult(uid, state.test.id, { correct, total, pct, pass, at: Date.now(), forced: !!forced });
      setErr("Server bilan vaqtincha aloqa bo‘lmadi. Natija qurilmada saqlandi.");
    }

    // UI post-finish
    $("finishBtn").style.display="none";
    $("qArea").style.display="none";
    $("preHint").style.display="block";
    $("preHint").textContent = "Test yakunlandi. Istasangiz tests.html ga qayting.";

    // if pass and courseId present, suggest continuing
    if(pass && state.test.courseId){
      $("preHint").innerHTML = `Test yakunlandi. <a href="/joinedcourse.html?id=${encodeURIComponent(state.test.courseId)}"><b>Kursga qaytish</b></a> yoki <a href="/certificate.html?type=course&sourceId=${encodeURIComponent(state.test.courseId)}"><b>Sertifikat</b></a>.`;
    }
  }

  function startTimer(){
    const limitSec = Number(state.test.timeMin||10)*60;
    state.remainingSec = limitSec;
    updateKpi();

    state.timer = setInterval(()=>{
      state.remainingSec--;
      updateKpi();
      if(state.remainingSec <= 0){
        setErr("Vaqt tugadi. Test yakunlanadi.");
        finishTest(true);
      }
    }, 1000);
  }

  async function startTest(){
    clearMsg();
    const role = String(state.me?.role || "student").toLowerCase();
    if(role === "teacher" || role === "admin"){
      setErr("Teacher/Admin test ishlamaydi. Student akkaunt bilan kiring.");
      return;
    }
    if(state.test.status !== "published"){
      setErr("Bu test draft holatda. Studentlar uchun yopiq.");
      return;
    }
    state.started = true;
    state.startMs = Date.now();
    antiCheatEnable();
    startTimer();
    renderQuestion();
    updateKpi();
  }

  $("startBtn").addEventListener("click", startTest);
  $("finishBtn").addEventListener("click", ()=> finishTest(false));
  $("prevBtn").addEventListener("click", ()=>{ state.idx--; renderQuestion(); updateKpi(); });
  $("nextBtn").addEventListener("click", ()=>{
    const total = state.test.questions.length;
    if(state.idx === total-1){ finishTest(false); return; }
    state.idx++; renderQuestion(); updateKpi();
  });

  // prevent accidental close
  window.addEventListener("beforeunload", (e)=>{
    if(state.started){
      e.preventDefault();
      e.returnValue = "";
    }
  });

  async function init(){
    const id = qs("id");
    if(!id){ setErr("Test ID topilmadi. tests.html dan kiriting."); return; }

    const me = await apiMe();
    if(!me) return;
    state.me = me;

    const role = String(me.role || "student").toLowerCase();
    const badge = $("roleBadge");
    badge.classList.remove("student","teacher","admin");
    badge.classList.add(role==="teacher" ? "teacher" : role==="admin" ? "admin" : "student");
    badge.textContent = role.toUpperCase();

    const name = me.fullname || me.name || me.username || "—";
    $("mePill").textContent = name;
    $("mePill").style.display = "inline-flex";

    $("dashLink").href = role==="teacher" ? "/teacher-dashboard.html" : role==="admin" ? "/admin-dashboard.html" : "/student-dashboard.html";

    const t = await fetchTest(id);
    state.test = t;

    $("title").textContent = t.title;
    $("desc").textContent = t.description || "—";
    $("courseIdTxt").textContent = t.courseId || "-";

    updateKpi();
  }

  init().catch(e=> setErr(e?.message || "Xatolik yuz berdi."));
</script>
  <script src="/ui-actions-menu.js" defer></script>
</body>
</html>

