<!doctype html>
<html lang="uz" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Teacher Dashboard — QDTU Edu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .glass{background:rgba(255,255,255,.6);border:1px solid rgba(148,163,184,.22);backdrop-filter: blur(14px)}
    .dark .glass{background:rgba(2,6,23,.6);border-color:rgba(148,163,184,.18)}
    .muted{color:rgba(15,23,42,.70)}
    .dark .muted{color:rgba(226,232,240,.70)}
    .kbd{border:1px solid rgba(148,163,184,.35);border-bottom-width:2px;border-radius:10px;padding:.12rem .5rem;font-size:.72rem}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <div class="fixed inset-0 -z-10 pointer-events-none">
    <div class="absolute inset-0"
      style="background:
        radial-gradient(1200px 800px at 15% 10%, rgba(99,102,241,.16), transparent 60%),
        radial-gradient(1100px 740px at 85% 12%, rgba(236,72,153,.12), transparent 62%),
        radial-gradient(1000px 700px at 50% 95%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.22));">
    </div>
  </div>

  <header class="px-4 md:px-8 pt-6">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <a href="/index.html" class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl glass grid place-items-center font-black">Q</div>
        <div>
          <div class="font-extrabold leading-tight">QDTU Edu</div>
          <div class="text-xs muted -mt-0.5">Teacher dashboard</div>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <a href="/courses.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold hover:opacity-90">Kurslar</a>
        <a href="/tests.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold hover:opacity-90">Testlar</a>
        <a href="/certificate.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold hover:opacity-90">Sertifikat</a>
        <button id="themeBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold hover:opacity-90">Rejim</button>
        <button id="logoutBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold hover:opacity-90">Chiqish</button>
      </div>
    </div>
  </header>

  <main class="px-4 md:px-8 pb-16">
    <div class="max-w-6xl mx-auto mt-6 grid lg:grid-cols-12 gap-6">
      <!-- left -->
      <section class="lg:col-span-4 glass rounded-3xl p-6">
        <div class="flex items-center gap-4">
          <img id="avatar" class="w-16 h-16 rounded-2xl object-cover border border-slate-200/60 dark:border-slate-700/50" alt="avatar" src=""/>
          <div class="min-w-0">
            <div class="text-lg font-extrabold truncate" id="fullName">—</div>
            <div class="text-sm muted truncate">@<span id="username">—</span></div>
            <div class="mt-1 text-xs muted">Rol: <span class="font-bold">Teacher</span></div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <div class="rounded-2xl border border-slate-200/60 dark:border-slate-700/50 p-4">
            <div class="text-xs muted">Coin (menda)</div>
            <div class="text-2xl font-black" id="coins">0</div>
          </div>
          <div class="rounded-2xl border border-slate-200/60 dark:border-slate-700/50 p-4">
            <div class="text-xs muted">Teacher balans</div>
            <div class="text-2xl font-black" id="teacherBalance">0</div>
          </div>
        </div>

        <div class="mt-5 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 p-4">
          <div class="text-xs muted">Tezkor yo‘llar</div>
          <div class="mt-3 grid gap-2">
            <a class="px-3 py-2 rounded-xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-extrabold text-sm" href="#createCourse">+ Kurs yaratish</a>
            <a class="px-3 py-2 rounded-xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold text-sm" href="#createTest">+ Test yaratish</a>
            <a class="px-3 py-2 rounded-xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold text-sm" href="#myCourses">Mening kurslarim</a>
          </div>
          <div class="mt-3 text-xs muted">
            Maslahat: audio autoplay bloklanadi. Kurs ichidagi audio/video play bo‘lishi uchun foydalanuvchi avval sahifada bir marta bosishi kerak.
          </div>
        </div>

        <div class="mt-5 text-xs muted">
          Klaviatura: <span class="kbd">Ctrl</span>+<span class="kbd">K</span> qidiruv (tez orada), <span class="kbd">Esc</span> modal yopish (tez orada)
        </div>
      </section>

      <!-- right -->
      <section class="lg:col-span-8 space-y-6">
        <!-- Create course -->
        <section id="createCourse" class="glass rounded-3xl p-6">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xl font-extrabold">Kurs yaratish</div>
              <div class="text-sm muted mt-1">Bepul/pullik kurs; pullik bo‘lsa, student coin balansidan yechiladi (50% teacher balans, 50% admin).</div>
            </div>
            <div class="text-xs muted text-right">
              Fakultetlar QDTU
              <div class="font-bold">7 ta</div>
            </div>
          </div>

          <form id="courseForm" class="mt-5 grid md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="text-sm font-bold">Kurs nomi</label>
              <input required id="cTitle" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Masalan: Web dasturlash 1"/>
            </div>

            <div>
              <label class="text-sm font-bold">Fakultet</label>
              <select id="cFaculty" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40"></select>
            </div>
            <div>
              <label class="text-sm font-bold">Yo‘nalish / Guruh (cheklov)</label>
              <input id="cGroup" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Masalan: MMT-520-25 (bo‘sh qoldirsa — hammaga)"/>
            </div>

            <div>
              <label class="text-sm font-bold">Turi</label>
              <select id="cType" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40">
                <option value="free">Bepul</option>
                <option value="paid">Pullik</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-bold">Narx (coin)</label>
              <input id="cPrice" type="number" min="0" value="0" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40"/>
              <div class="text-xs muted mt-1">Pullik bo‘lsa: student → yechiladi; 50% teacherBalance, 50% admin.</div>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-bold">Kurs tavsifi</label>
              <textarea id="cDesc" rows="3" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Kurs haqida qisqa ma'lumot"></textarea>
            </div>

            <div class="md:col-span-2 flex flex-wrap items-center gap-3">
              <button class="px-5 py-3 rounded-2xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-extrabold" type="submit">Saqlash</button>
              <button class="px-5 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold" type="button" id="courseReset">Tozalash</button>
              <div class="text-sm muted" id="courseMsg"></div>
            </div>
          </form>
        </section>

        <!-- My courses -->
        <section id="myCourses" class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xl font-extrabold">Mening kurslarim</div>
              <div class="text-sm muted mt-1">Kurs ichiga dars (YouTube preview, matn, PDF preview) qo‘shish: kurs kartasida “Dars qo‘shish”.</div>
            </div>
            <button id="refreshCourses" class="px-4 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold text-sm">Yangilash</button>
          </div>

          <div class="mt-4 grid md:grid-cols-2 gap-4" id="coursesGrid"></div>

          <template id="courseCardTpl">
            <div class="rounded-3xl border border-slate-200/60 dark:border-slate-700/50 p-5 bg-white/50 dark:bg-slate-950/20">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="font-extrabold text-lg truncate" data-k="title"></div>
                  <div class="text-xs muted mt-1" data-k="meta"></div>
                </div>
                <span class="text-xs font-extrabold px-3 py-1 rounded-full border border-slate-200/60 dark:border-slate-700/50" data-k="badge"></span>
              </div>
              <div class="text-sm muted mt-3 line-clamp-3" data-k="desc"></div>

              <div class="mt-4 flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-extrabold text-sm" data-act="addLesson">Dars qo‘shish</button>
                <a class="px-3 py-2 rounded-xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold text-sm" data-act="open" href="#">Ochish</a>
                <button class="px-3 py-2 rounded-xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold text-sm" data-act="delete">O‘chirish</button>
              </div>

              <div class="mt-4 hidden" data-k="lessonBox">
                <div class="text-sm font-extrabold">Yangi dars</div>
                <div class="grid gap-2 mt-2">
                  <input class="w-full px-4 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Dars sarlavhasi" data-k="lTitle"/>
                  <input class="w-full px-4 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="YouTube link (ixtiyoriy)" data-k="lYoutube"/>
                  <textarea rows="3" class="w-full px-4 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Matn (ixtiyoriy)" data-k="lText"></textarea>
                  <input class="w-full px-4 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="PDF URL (ixtiyoriy)" data-k="lPdf"/>
                </div>
                <div class="mt-3 flex gap-2">
                  <button class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-extrabold text-sm" data-act="saveLesson">Saqlash</button>
                  <button class="px-4 py-2 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold text-sm" data-act="cancelLesson">Bekor</button>
                </div>
                <div class="text-xs muted mt-2" data-k="lessonMsg"></div>
              </div>
            </div>
          </template>
        </section>

        <!-- Create test -->
        <section id="createTest" class="glass rounded-3xl p-6">
          <div class="text-xl font-extrabold">Test yaratish (soddalashtirilgan)</div>
          <div class="text-sm muted mt-1">Keyingi bosqichda: savollar bazasi, vaqt limiti, random, natija, sertifikat sharti.</div>

          <form id="testForm" class="mt-5 grid md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="text-sm font-bold">Test nomi</label>
              <input required id="tTitle" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Masalan: 1-mavzu bo‘yicha test"/>
            </div>
            <div>
              <label class="text-sm font-bold">Fakultet</label>
              <select id="tFaculty" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40"></select>
            </div>
            <div>
              <label class="text-sm font-bold">Guruh (cheklov)</label>
              <input id="tGroup" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40" placeholder="Masalan: MMT-520-25"/>
            </div>

            <div class="md:col-span-2">
              <label class="text-sm font-bold">Savollar (JSON)</label>
              <textarea id="tJson" rows="6" class="mt-1 w-full px-4 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 bg-white/70 dark:bg-slate-950/40"
                placeholder='Misol:
[
  {"q":"HTML nima?","a":["Til","Brauzer","OS","Disk"],"c":0},
  {"q":"CSS nima?","a":["Stil","DB","CPU","IDE"],"c":0}
]'></textarea>
              <div class="text-xs muted mt-1">Har bir savol: q (matn), a (variantlar), c (to‘g‘ri javob indeksi).</div>
            </div>

            <div class="md:col-span-2 flex flex-wrap items-center gap-3">
              <button class="px-5 py-3 rounded-2xl bg-slate-900 text-white dark:bg-white dark:text-slate-900 font-extrabold" type="submit">Saqlash</button>
              <button class="px-5 py-3 rounded-2xl border border-slate-200/60 dark:border-slate-700/50 font-extrabold" type="button" id="testReset">Tozalash</button>
              <div class="text-sm muted" id="testMsg"></div>
            </div>
          </form>
        </section>
      </section>
    </div>
  </main>

<script>
  // ===================== Config =====================
  const FACULTIES = [
    "Neft-gaz va geologiya fakulteti",
    "Iqtisodiyot va boshqaruv fakulteti",
    "Energetika muhandisligi fakulteti",
    "Transport va qurilish muhandisligi fakulteti",
    "Raqamli texnologiyalar va sun'iy intellekt fakulteti",
    "Shahrisabz oziq-ovqat muhandisligi fakulteti",
    "Irrigatsiya muhandisligi fakulteti"
  ];

  const LS = {
    myCourses: 'edu.teacher.courses',
    myTests: 'edu.teacher.tests',
    teacherBalance: 'edu.teacher.balance'
  };

  // ===================== Theme =====================
  const themeBtn = document.getElementById('themeBtn');
  function applyTheme(mode){
    if(mode === 'dark') document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    localStorage.setItem('theme', mode);
  }
  applyTheme(localStorage.getItem('theme') || 'light');
  themeBtn.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));

  // ===================== Auth helpers =====================
  function getToken(){
    return localStorage.getItem('token') || '';
  }
  async function api(path, opts={}){
    const headers = Object.assign({'Content-Type':'application/json'}, opts.headers || {});
    const t = getToken();
    if(t) headers.Authorization = 'Bearer ' + t;
    const res = await fetch(path, {...opts, headers});
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw Object.assign(new Error(data.error || ('HTTP ' + res.status)), {status: res.status, data});
    return data;
  }

  // ===================== Load user =====================
  async function loadMe(){
    try{
      const r = await api('/api/me');
      const u = r.user || {};
      document.getElementById('fullName').textContent = u.fullName || u.nickname || '—';
      document.getElementById('username').textContent = u.username || '—';
      document.getElementById('avatar').src = u.avatar || '';
      document.getElementById('coins').textContent = (u.coins ?? 0);

      const tb = Number(localStorage.getItem(LS.teacherBalance) || u.teacherBalance || 0);
      document.getElementById('teacherBalance').textContent = tb;
    }catch(e){
      // If not logged in, redirect to login
      console.warn('me error', e);
    }
  }

  // ===================== Faculty selects =====================
  function fillFaculty(selectId){
    const s = document.getElementById(selectId);
    s.innerHTML = FACULTIES.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join('');
  }
  fillFaculty('cFaculty');
  fillFaculty('tFaculty');

  // ===================== Local storage data =====================
  function readJson(key, fallback){
    try{ return JSON.parse(localStorage.getItem(key) || '') ?? fallback; }catch(_){ return fallback; }
  }
  function writeJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  // ===================== Course CRUD (API-first; LS fallback) =====================
  async function createCourse(course){
    // If backend endpoints exist later, this will use them automatically.
    // Expected future: POST /api/edu/courses
    try{
      const r = await api('/api/edu/courses', {method:'POST', body: JSON.stringify(course)});
      return r.course;
    }catch(_){
      const list = readJson(LS.myCourses, []);
      list.unshift(course);
      writeJson(LS.myCourses, list);
      return course;
    }
  }
  async function listMyCourses(){
    try{
      const r = await api('/api/edu/courses?mine=1');
      return r.courses || [];
    }catch(_){
      return readJson(LS.myCourses, []);
    }
  }
  async function deleteCourse(courseId){
    try{
      await api('/api/edu/courses/' + encodeURIComponent(courseId), {method:'DELETE'});
      return true;
    }catch(_){
      const list = readJson(LS.myCourses, []);
      writeJson(LS.myCourses, list.filter(x => x.id !== courseId));
      return true;
    }
  }
  async function addLesson(courseId, lesson){
    try{
      const r = await api(`/api/edu/courses/${encodeURIComponent(courseId)}/lessons`, {method:'POST', body: JSON.stringify(lesson)});
      return r.lesson;
    }catch(_){
      const list = readJson(LS.myCourses, []);
      const c = list.find(x => x.id === courseId);
      if(!c) throw new Error('Kurs topilmadi');
      c.lessons = c.lessons || [];
      c.lessons.push(lesson);
      writeJson(LS.myCourses, list);
      return lesson;
    }
  }

  // ===================== UI: Create course =====================
  const courseForm = document.getElementById('courseForm');
  const courseMsg = document.getElementById('courseMsg');
  document.getElementById('courseReset').addEventListener('click', () => courseForm.reset());

  courseForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    courseMsg.textContent = 'Saqlanmoqda...';
    courseMsg.className = 'text-sm muted';

    const type = document.getElementById('cType').value;
    const price = Number(document.getElementById('cPrice').value || 0);
    const now = Date.now();
    const course = {
      id: 'c_' + now,
      title: document.getElementById('cTitle').value.trim(),
      desc: document.getElementById('cDesc').value.trim(),
      faculty: document.getElementById('cFaculty').value,
      group: document.getElementById('cGroup').value.trim(),
      type,
      price: type === 'paid' ? Math.max(0, price) : 0,
      createdAt: new Date(now).toISOString(),
      lessons: [],
      teacherSharePct: 50,
      adminSharePct: 50
    };

    try{
      await createCourse(course);
      courseMsg.textContent = '✅ Kurs saqlandi.';
      courseMsg.className = 'text-sm text-emerald-600 font-bold';
      courseForm.reset();
      await renderMyCourses();
    }catch(err){
      courseMsg.textContent = '❌ Xatolik: ' + (err?.message || err);
      courseMsg.className = 'text-sm text-rose-600 font-bold';
    }
  });

  // ===================== UI: My courses =====================
  const coursesGrid = document.getElementById('coursesGrid');
  const tpl = document.getElementById('courseCardTpl');

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function badgeText(c){
    if(c.type === 'paid') return `Pullik • ${c.price || 0} coin`;
    return 'Bepul';
  }

  async function renderMyCourses(){
    const list = await listMyCourses();
    coursesGrid.innerHTML = '';
    if(!list.length){
      coursesGrid.innerHTML = `<div class="md:col-span-2 rounded-3xl border border-slate-200/60 dark:border-slate-700/50 p-6 text-sm muted">
        Hozircha kurs yo‘q. Yuqoridan <b>“Kurs yaratish”</b> orqali qo‘shing.
      </div>`;
      return;
    }

    for(const c of list){
      const node = tpl.content.cloneNode(true);
      node.querySelector('[data-k="title"]').textContent = c.title || '—';
      node.querySelector('[data-k="meta"]').textContent =
        `${c.faculty || '—'} • ${c.group ? ('Guruh: ' + c.group) : 'Hammaga'} • Darslar: ${(c.lessons||[]).length}`;
      node.querySelector('[data-k="badge"]').textContent = badgeText(c);
      node.querySelector('[data-k="desc"]').textContent = c.desc || '';

      const root = node.querySelector('div');
      const openA = root.querySelector('[data-act="open"]');
      openA.href = `/course.html?id=${encodeURIComponent(c.id)}`;

      const lessonBox = root.querySelector('[data-k="lessonBox"]');
      const lessonMsg = root.querySelector('[data-k="lessonMsg"]');

      root.querySelector('[data-act="addLesson"]').addEventListener('click', () => {
        lessonBox.classList.toggle('hidden');
        lessonMsg.textContent = '';
      });

      root.querySelector('[data-act="cancelLesson"]').addEventListener('click', () => {
        lessonBox.classList.add('hidden');
      });

      root.querySelector('[data-act="saveLesson"]').addEventListener('click', async () => {
        lessonMsg.textContent = 'Saqlanmoqda...';
        const lTitle = root.querySelector('[data-k="lTitle"]').value.trim();
        const lYoutube = root.querySelector('[data-k="lYoutube"]').value.trim();
        const lText = root.querySelector('[data-k="lText"]').value.trim();
        const lPdf = root.querySelector('[data-k="lPdf"]').value.trim();
        if(!lTitle){
          lessonMsg.textContent = 'Dars sarlavhasi shart.';
          return;
        }
        const lesson = { id:'l_'+Date.now(), title:lTitle, youtube:lYoutube, text:lText, pdf:lPdf, createdAt:new Date().toISOString() };
        try{
          await addLesson(c.id, lesson);
          lessonMsg.textContent = '✅ Dars qo‘shildi.';
          lessonBox.classList.add('hidden');
          await renderMyCourses();
        }catch(err){
          lessonMsg.textContent = '❌ ' + (err?.message || err);
        }
      });

      root.querySelector('[data-act="delete"]').addEventListener('click', async () => {
        if(!confirm('Kurs o‘chirilsinmi?')) return;
        await deleteCourse(c.id);
        await renderMyCourses();
      });

      coursesGrid.appendChild(node);
    }
  }
  document.getElementById('refreshCourses').addEventListener('click', renderMyCourses);

  // ===================== Tests (LS fallback) =====================
  const testForm = document.getElementById('testForm');
  const testMsg = document.getElementById('testMsg');
  document.getElementById('testReset').addEventListener('click', () => testForm.reset());

  function saveTestLocal(test){
    const list = readJson(LS.myTests, []);
    list.unshift(test);
    writeJson(LS.myTests, list);
  }

  testForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    testMsg.textContent = 'Saqlanmoqda...';
    testMsg.className = 'text-sm muted';

    let questions = [];
    try{
      questions = JSON.parse(document.getElementById('tJson').value || '[]');
      if(!Array.isArray(questions)) throw new Error('JSON massiv bo‘lishi kerak');
    }catch(err){
      testMsg.textContent = '❌ Savollar JSON xato: ' + (err?.message || err);
      testMsg.className = 'text-sm text-rose-600 font-bold';
      return;
    }

    const test = {
      id: 't_' + Date.now(),
      title: document.getElementById('tTitle').value.trim(),
      faculty: document.getElementById('tFaculty').value,
      group: document.getElementById('tGroup').value.trim(),
      questions,
      createdAt: new Date().toISOString()
    };

    try{
      // future: POST /api/edu/tests
      await api('/api/edu/tests', {method:'POST', body: JSON.stringify(test)});
      testMsg.textContent = '✅ Test saqlandi (API).';
      testMsg.className = 'text-sm text-emerald-600 font-bold';
    }catch(_){
      saveTestLocal(test);
      testMsg.textContent = '✅ Test saqlandi (local).';
      testMsg.className = 'text-sm text-emerald-600 font-bold';
    }
    testForm.reset();
  });

  // ===================== Logout =====================
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try{ await api('/api/logout', {method:'POST'}); }catch(_){}
    localStorage.removeItem('token');
    location.href = '/login.html';
  });

  // Init
  loadMe();
  renderMyCourses();
</script>
</body>
</html>