<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sertifikat</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{background:#111827;color:#fff;padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
    header .left{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header .badge{background:#10b981;padding:6px 10px;border-radius:999px;font-size:12px}
    header .badge.teacher{background:#2563eb}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:12px;background:rgba(255,255,255,.08)}
    .container{max-width:1200px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .card h2{margin:0 0 10px 0;font-size:20px}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .muted{color:#6b7280;font-size:13px;line-height:1.45}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{display:inline-block;border:1px solid #d1d5db;background:#fff;color:#111827;padding:10px 12px;border-radius:10px;text-decoration:none;font-size:14px;cursor:pointer}
    .btn.primary{background:#2563eb;border-color:#2563eb;color:#fff}
    .btn.danger{background:#ef4444;border-color:#ef4444;color:#fff}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.25);color:#fff}
    .input, select{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:14px;box-sizing:border-box;background:#fff}
    .col-12{grid-column:span 12}
    .col-7{grid-column:span 7}
    .col-5{grid-column:span 5}
    @media (max-width:980px){
      .col-7,.col-5{grid-column:span 12}
    }
    .err{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:12px 14px;border-radius:12px;margin:14px 0;display:none}
    .ok{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:12px 14px;border-radius:12px;margin:14px 0;display:none}
    .canvasWrap{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff}
    canvas{width:100%;height:auto;display:block}
    .tiny{font-size:12px;color:#6b7280}
    footer{padding:20px 16px;color:#6b7280;text-align:center}
    code{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:2px 6px}
  </style>
  <link rel="stylesheet" href="/ui-glass-theme.css" />
</head>
<body>
  <header>
    <div class="left">
      <div style="font-weight:700">QDTU LMS</div>
      <div id="roleBadge" class="badge">Student</div>
      <div id="mePill" class="pill" style="display:none"></div>
    </div>
    <div class="row">
      <a class="btn ghost" href="/student-dashboard.html" id="dashLink">Dashboard</a>
      <a class="btn ghost" href="/courses.html">Kurslar</a>
      <a class="btn ghost" href="/tests.html">Testlar</a>
      <button class="btn danger" id="logoutBtn">Chiqish</button>
    </div>
  </header>

  <div class="container">
    <div id="errBox" class="err"></div>
    <div id="okBox" class="ok"></div>

    <div class="grid">
      <div class="card col-5">
        <h2>Sertifikat generator</h2>
        <div class="muted">
          Sertifikat canvas’da chiziladi va PDF ko‘rinishida yuklab olinadi.
          Ism-familiya va guruh avtomatik olinadi.
        </div>

        <div style="margin-top:12px" class="grid">
          <div class="col-12">
            <div class="muted">Tur</div>
            <select id="typeSel" class="input">
              <option value="course">Course</option>
              <option value="test">Test</option>
            </select>
          </div>
          <div class="col-12">
            <div class="muted">Manba ID (courseId yoki testId)</div>
            <input id="sourceId" class="input" placeholder="ID..." />
          </div>
          <div class="col-12">
            <div class="muted">Natija (test uchun %)</div>
            <input id="scoreInp" class="input" type="number" min="0" max="100" placeholder="Masalan: 80" />
          </div>
          <div class="col-12">
            <div class="muted">Sana</div>
            <input id="dateInp" class="input" />
          </div>
          <div class="col-12">
            <button class="btn primary" id="renderBtn">Sertifikatni chizish</button>
            <button class="btn" id="downloadBtn">PDF yuklab olish</button>
          </div>
        </div>

        <div class="tiny" style="margin-top:12px">
          PDF export uchun CDN kutubxonalar ishlatiladi: <code>jspdf</code>. Agar CDN blok bo‘lsa — brauzerning Print-to-PDF funksiyasidan foydalaning.
        </div>
      </div>

      <div class="card col-7">
        <h3>Preview</h3>
        <div class="canvasWrap">
          <canvas id="certCanvas" width="1600" height="1131"></canvas>
        </div>
      </div>
    </div>
  </div>

  <footer>Qarshi Davlat Texnika Universiteti — LMS (Certificate)</footer>

  <!-- jsPDF (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const API_BASE = "";
  function getToken(){ return localStorage.getItem("token") || ""; }
  function qs(name){ return new URLSearchParams(location.search).get(name); }

  function setErr(msg){
    const box = document.getElementById("errBox");
    box.textContent = msg; box.style.display = "block";
    document.getElementById("okBox").style.display = "none";
  }
  function setOk(msg){
    const box = document.getElementById("okBox");
    box.textContent = msg; box.style.display = "block";
    document.getElementById("errBox").style.display = "none";
  }

  function escapeText(str){ return String(str||""); }

  async function apiMe(){
    const token = getToken();
    if(!token){ location.href="/login.html"; return null; }
    const res = await fetch(API_BASE + "/api/me", { headers:{ "Authorization":"Bearer " + token } });
    if(!res.ok){
      localStorage.removeItem("token");
      location.href="/login.html";
      return null;
    }
    return await res.json();
  }

  function demoCoursesKey(){ return "demoCourses_v1"; }
  function demoTestsKey(){ return "demoTests_v1"; }
  function readDemo(key){
    try { return JSON.parse(localStorage.getItem(key) || "[]"); } catch { return []; }
  }
  function normalizeCourse(raw){
    return {
      id: raw._id || raw.id || raw.courseId,
      title: raw.title || raw.name || "Nomsiz kurs",
      faculty: raw.faculty || raw.facultyName || "",
      teacherName: raw.teacherName || raw.teacher?.fullname || raw.teacher?.name || raw.ownerName || ""
    };
  }
  function normalizeTest(raw){
    return {
      id: raw._id || raw.id || raw.testId,
      title: raw.title || raw.name || "Nomsiz test",
      subject: raw.subject || raw.course || raw.fan || "",
      faculty: raw.faculty || raw.facultyName || "",
      teacherName: raw.teacherName || raw.teacher?.fullname || raw.teacher?.name || raw.ownerName || ""
    };
  }

  async function fetchCourseTitle(id){
    const token = getToken();
    try{
      let res = await fetch(API_BASE + "/api/courses/" + encodeURIComponent(id), { headers:{ "Authorization":"Bearer " + token } });
      if(res.ok){
        const data = await res.json();
        const c = normalizeCourse(data.course || data);
        return c;
      }
      res = await fetch(API_BASE + "/api/courses", { headers:{ "Authorization":"Bearer " + token } });
      if(res.ok){
        const data = await res.json();
        const list = (Array.isArray(data) ? data : (data.courses||[])).map(normalizeCourse);
        const c = list.find(x=>String(x.id)===String(id));
        if(c) return c;
      }
    }catch(e){}
    // demo fallback
    const list = readDemo(demoCoursesKey()).map(normalizeCourse);
    return list.find(x=>String(x.id)===String(id)) || { id, title:"Kurs", faculty:"", teacherName:"" };
  }

  async function fetchTestTitle(id){
    const token = getToken();
    try{
      let res = await fetch(API_BASE + "/api/tests/" + encodeURIComponent(id), { headers:{ "Authorization":"Bearer " + token } });
      if(res.ok){
        const data = await res.json();
        const t = normalizeTest(data.test || data);
        return t;
      }
      res = await fetch(API_BASE + "/api/tests", { headers:{ "Authorization":"Bearer " + token } });
      if(res.ok){
        const data = await res.json();
        const list = (Array.isArray(data) ? data : (data.tests||[])).map(normalizeTest);
        const t = list.find(x=>String(x.id)===String(id));
        if(t) return t;
      }
    }catch(e){}
    // demo fallback
    const list = readDemo(demoTestsKey()).map(normalizeTest);
    return list.find(x=>String(x.id)===String(id)) || { id, title:"Test", subject:"", faculty:"", teacherName:"" };
  }

  // Certificate canvas drawing
  function drawCertificate(ctx, data){
    const W = ctx.canvas.width, H = ctx.canvas.height;
    ctx.clearRect(0,0,W,H);

    // Background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    // Decorative border
    ctx.lineWidth = 18;
    ctx.strokeStyle = "#111827";
    ctx.strokeRect(40,40,W-80,H-80);

    ctx.lineWidth = 4;
    ctx.strokeStyle = "#2563eb";
    ctx.strokeRect(78,78,W-156,H-156);

    // Header band
    ctx.fillStyle = "#111827";
    ctx.fillRect(78,78,W-156,150);

    // University title
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 46px Arial";
    ctx.textAlign = "center";
    ctx.fillText("QARSHI DAVLAT TEXNIKA UNIVERSITETI", W/2, 150);

    ctx.font = "24px Arial";
    ctx.fillText("O'quv platformasi (LMS)", W/2, 195);

    // Certificate title
    ctx.fillStyle = "#111827";
    ctx.font = "bold 72px Arial";
    ctx.fillText("SERTIFIKAT", W/2, 330);

    // Subtitle
    ctx.font = "28px Arial";
    ctx.fillStyle = "#374151";
    ctx.fillText("Ushbu sertifikat quyidagi shaxsga taqdim etiladi:", W/2, 390);

    // Name
    ctx.font = "bold 64px Arial";
    ctx.fillStyle = "#111827";
    ctx.fillText(data.fullname || "F.I.SH", W/2, 500);

    // Group & faculty
    ctx.font = "28px Arial";
    ctx.fillStyle = "#374151";
    ctx.fillText("Guruh: " + (data.group || "-") + "    •    Fakultet: " + (data.faculty || "-"), W/2, 565);

    // Achievement line
    ctx.font = "30px Arial";
    ctx.fillStyle = "#111827";

    let ach = "";
    if(data.type === "test"){
      ach = "Testdan muvaffaqiyatli o'tganligi uchun";
    }else{
      ach = "Kursni muvaffaqiyatli yakunlaganligi uchun";
    }
    ctx.fillText(ach, W/2, 640);

    // Course/Test title
    ctx.font = "bold 38px Arial";
    ctx.fillStyle = "#2563eb";
    const title = data.itemTitle || (data.type==="test" ? "Test" : "Kurs");
    wrapText(ctx, title, W/2, 710, W-260, 46);

    // Score for test
    if(data.type === "test"){
      ctx.font = "28px Arial";
      ctx.fillStyle = "#111827";
      ctx.fillText("Natija: " + (data.score ?? "-") + "%", W/2, 830);
    }

    // Date + serial
    ctx.font = "22px Arial";
    ctx.fillStyle = "#374151";
    ctx.textAlign = "left";
    ctx.fillText("Sana: " + (data.dateStr || "-"), 120, H-210);

    ctx.textAlign = "right";
    ctx.fillText("Sertifikat ID: " + (data.serial || "-"), W-120, H-210);

    // Signature lines
    ctx.textAlign = "left";
    ctx.strokeStyle = "#9ca3af";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(120, H-140);
    ctx.lineTo(520, H-140);
    ctx.stroke();
    ctx.fillStyle = "#374151";
    ctx.font = "20px Arial";
    ctx.fillText("Mas'ul shaxs imzosi", 120, H-110);

    ctx.textAlign = "right";
    ctx.beginPath();
    ctx.moveTo(W-520, H-140);
    ctx.lineTo(W-120, H-140);
    ctx.stroke();
    ctx.fillText("Universitet muhri", W-120, H-110);

    ctx.textAlign = "center";
    ctx.fillStyle = "#6b7280";
    ctx.font = "18px Arial";
    ctx.fillText("QDTU LMS • Onlayn ta'lim platformasi", W/2, H-70);
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    // center aligned wrap
    const words = String(text||"").split(" ");
    let line = "";
    const lines = [];
    for(const w of words){
      const testLine = line ? line + " " + w : w;
      const metrics = ctx.measureText(testLine);
      if(metrics.width > maxWidth && line){
        lines.push(line);
        line = w;
      }else{
        line = testLine;
      }
    }
    if(line) lines.push(line);

    ctx.textAlign = "center";
    lines.slice(0,2).forEach((ln,i)=>{
      ctx.fillText(ln, x, y + i*lineHeight);
    });
  }

  function makeSerial(type, sourceId){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const rnd = Math.random().toString(16).slice(2,8).toUpperCase();
    return `${type.toUpperCase()}-${y}${m}${day}-${String(sourceId||"X").slice(0,6)}-${rnd}`;
  }

  async function renderNow(){
    const type = document.getElementById("typeSel").value;
    const sourceId = (document.getElementById("sourceId").value||"").trim();
    const score = Number(document.getElementById("scoreInp").value||0);

    if(!sourceId){
      setErr("Manba ID (courseId/testId) majburiy.");
      return;
    }

    const me = window.ME;
    if(!me) return;

    let item = null;
    if(type==="test"){
      item = await fetchTestTitle(sourceId);
    }else{
      item = await fetchCourseTitle(sourceId);
    }

    const dateStr = (document.getElementById("dateInp").value||"").trim();
    const serial = makeSerial(type, sourceId);

    const data = {
      type,
      sourceId,
      itemTitle: type==="test" ? (item.title + (item.subject ? " ("+item.subject+")" : "")) : item.title,
      score: type==="test" ? (isNaN(score)?0:score) : null,
      fullname: (me.fullname || me.name || me.username || "").trim(),
      group: me.group || "-",
      faculty: me.faculty || item.faculty || "-",
      dateStr: dateStr || new Date().toISOString().slice(0,10),
      serial
    };

    const c = document.getElementById("certCanvas");
    const ctx = c.getContext("2d");
    drawCertificate(ctx, data);

    // Save a minimal record (demo)
    try{
      const key = "certRecords_v1_" + (me._id || me.id || me.username || "anon");
      const list = JSON.parse(localStorage.getItem(key) || "[]");
      list.unshift({ ...data, at: Date.now() });
      localStorage.setItem(key, JSON.stringify(list.slice(0,50)));
    }catch(e){}

    setOk("Sertifikat chizildi. PDF yuklab olish mumkin.");
  }

  async function downloadPDF(){
    const canvas = document.getElementById("certCanvas");
    const imgData = canvas.toDataURL("image/png", 1.0);

    // Prefer jsPDF
    try{
      if(!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF not loaded");
      const { jsPDF } = window.jspdf;
      // A4 landscape: 297x210 mm
      const doc = new jsPDF({ orientation:"landscape", unit:"mm", format:"a4" });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      // Maintain aspect ratio
      const imgW = pageWidth;
      const imgH = pageWidth * (canvas.height / canvas.width);
      const y = (pageHeight - imgH) / 2;
      doc.addImage(imgData, "PNG", 0, y, imgW, imgH, undefined, "FAST");
      const fileName = "certificate_" + (Date.now()) + ".pdf";
      doc.save(fileName);
      setOk("PDF yuklab olindi.");
      return;
    }catch(e){
      // Fallback: open image in new tab and print to PDF
      const win = window.open("");
      if(!win){
        setErr("Popup bloklangan. Brauzer ruxsat bering yoki Print-to-PDF ishlating.");
        return;
      }
      win.document.write("<title>Sertifikat</title>");
      win.document.write("<img style='width:100%' src='" + imgData + "'/>");
      win.document.close();
      win.focus();
      setOk("PDF uchun: yangi oynada Print (Ctrl+P) → Save as PDF.");
    }
  }

  async function init(){
    window.ME = await apiMe();
    if(!window.ME) return;

    const role = (window.ME.role||"student").toLowerCase();
    const badge = document.getElementById("roleBadge");
    badge.textContent = role==="teacher" ? "Teacher" : role==="admin" ? "Admin" : "Student";
    badge.classList.toggle("teacher", role==="teacher");
    badge.style.background = role==="teacher" ? "#2563eb" : (role==="admin" ? "#f59e0b" : "#10b981");

    const mePill = document.getElementById("mePill");
    mePill.textContent = (window.ME.fullname||window.ME.name||window.ME.username||"") + " • " + (window.ME.group || "Guruh yo‘q");
    mePill.style.display = "inline-block";

    document.getElementById("dashLink").href = role==="teacher" ? "/teacher-dashboard.html" : role==="admin" ? "/admin-dashboard.html" : "/student-dashboard.html";

    // Prefill from query params
    const type = (qs("type") || "course").toLowerCase();
    const id = qs("id") || "";
    const score = qs("score") || "";
    document.getElementById("typeSel").value = (type==="test" ? "test" : "course");
    document.getElementById("sourceId").value = id;
    document.getElementById("scoreInp").value = score;

    // date default (local)
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    document.getElementById("dateInp").value = `${yyyy}-${mm}-${dd}`;

    // Auto-render if id exists
    if(id){
      await renderNow();
    }else{
      // draw placeholder
      const ctx = document.getElementById("certCanvas").getContext("2d");
      drawCertificate(ctx, {
        type: "course",
        itemTitle: "Kurs/Test nomi",
        fullname: (window.ME.fullname||window.ME.name||window.ME.username||""),
        group: window.ME.group || "-",
        faculty: window.ME.faculty || "-",
        dateStr: document.getElementById("dateInp").value,
        serial: makeSerial("course", "X")
      });
    }
  }

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    localStorage.removeItem("token");
    location.href="/login.html";
  });

  document.getElementById("renderBtn").addEventListener("click", renderNow);
  document.getElementById("downloadBtn").addEventListener("click", downloadPDF);

  // Type change: score enable/disable
  document.getElementById("typeSel").addEventListener("change", ()=>{
    const t = document.getElementById("typeSel").value;
    document.getElementById("scoreInp").disabled = (t !== "test");
  });

  init().catch(()=> setErr("Server bilan ulanishda xatolik. Keyinroq urinib ko‘ring."));
</script>
  <script src="/ui-actions-menu.js" defer></script>
</body>
</html>

