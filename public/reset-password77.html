<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Parolni tiklash</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100 flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur">
    <h1 class="text-xl font-extrabold mb-2">Parolni tiklash</h1>
    <p class="text-sm text-slate-300 mb-4">Token va yangi parolni kiriting.</p>

    <form id="rpForm" class="space-y-3">
      <input name="token" id="token" class="w-full rounded-xl bg-black/30 border border-white/10 px-4 py-3 text-sm" placeholder="Token" required />
      <input name="newPassword" id="newPassword" type="password" class="w-full rounded-xl bg-black/30 border border-white/10 px-4 py-3 text-sm" placeholder="Yangi parol (min 6)" required />
      <input name="confirm" id="confirm" type="password" class="w-full rounded-xl bg-black/30 border border-white/10 px-4 py-3 text-sm" placeholder="Yangi parol (takror)" required />
      <button id="btn" class="w-full rounded-xl bg-indigo-500/90 hover:bg-indigo-500 px-4 py-3 text-sm font-bold">Saqlash</button>
    </form>

    <div id="msg" class="mt-4 text-sm text-slate-200 hidden"></div>
  </div>

<script>
(function(){
  const form = document.getElementById('rpForm');
  const btn = document.getElementById('btn');
  const msg = document.getElementById('msg');
  const tokenInput = document.getElementById('token');

  // preload token from localStorage if available
  const saved = localStorage.getItem('resetToken');
  if(saved && !tokenInput.value) tokenInput.value = saved;

  const show = (t)=>{ msg.textContent=t; msg.classList.remove('hidden'); };

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const token = String(tokenInput.value||'').trim();
    const np = String(document.getElementById('newPassword').value||'');
    const cp = String(document.getElementById('confirm').value||'');
    if(np.length < 6) return show('❌ Parol kamida 6 ta bo‘lsin');
    if(np !== cp) return show('❌ Parollar mos emas');

    btn.disabled = true;
    const old = btn.textContent;
    btn.textContent = 'Saqlanmoqda...';

    try{
      const r = await fetch('/api/auth/reset-password', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token, newPassword: np })
      });
      const j = await r.json().catch(()=>null);
      if(r.ok && j && j.success){
        localStorage.removeItem('resetToken');
        show('✅ Parol yangilandi. Endi login qiling.');
      }else{
        show('❌ ' + ((j && (j.error||j.message)) || 'Xatolik'));
      }
    }catch(err){
      show('❌ Tarmoq xatoligi');
    }finally{
      btn.disabled = false;
      btn.textContent = old;
    }
  });
})();
</script>
</body>
</html>
