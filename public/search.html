<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - UniConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .search-result:hover {
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white h-16">
        <div class="container mx-auto px-4 h-full flex items-center justify-between">
            <a href="/messages.html" class="flex items-center space-x-2">
                <i class="fas fa-arrow-left"></i>
                <span class="font-semibold">Back to Messages</span>
            </a>
            <div class="flex items-center space-x-4">
                <a href="/profile.html" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-user"></i>
                </a>
                <a href="#" onclick="logout()" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Search Container -->
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Search Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Search Everything</h1>
            <p class="text-gray-600">Find users, messages, groups, and channels</p>
        </div>
        
        <!-- Search Input -->
        <div class="relative mb-8">
            <i class="fas fa-search absolute left-4 top-4 text-gray-400 text-lg"></i>
            <input type="text" id="searchInput" 
                   class="w-full pl-12 pr-4 py-4 text-lg border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                   placeholder="Type to search users, messages, groups, channels..."
                   onkeyup="performSearch(this.value)">
            <button onclick="clearSearch()" 
                    class="absolute right-4 top-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
            <button onclick="switchTab('users')" 
                    class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-users mr-2"></i> Users
            </button>
            <button onclick="switchTab('messages')" 
                    class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-comments mr-2"></i> Messages
            </button>
            <button onclick="switchTab('groups')" 
                    class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-user-friends mr-2"></i> Groups
            </button>
            <button onclick="switchTab('channels')" 
                    class="tab-btn px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-broadcast-tower mr-2"></i> Channels
            </button>
        </div>
        
        <!-- Results Area -->
        <div id="searchResults">
            <!-- Initial State -->
            <div class="text-center py-12">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-500">Start Searching</h3>
                <p class="text-gray-400">Type in the search box to find content</p>
            </div>
        </div>
        
        <!-- Search Tips -->
        <div class="mt-12 bg-gray-50 border border-gray-200 rounded-xl p-6">
            <h3 class="font-bold text-gray-800 mb-4">Search Tips:</h3>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-gray-700">User Search</h4>
                        <p class="text-sm text-gray-600">Search by username, nickname, or university</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-gray-700">Message Search</h4>
                        <p class="text-sm text-gray-600">Find text in your conversation history</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-gray-700">Group Search</h4>
                        <p class="text-sm text-gray-600">Find study groups by name or description</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <h4 class="font-medium text-gray-700">Channel Search</h4>
                        <p class="text-sm text-gray-600">Discover campus channels and announcements</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'users';
        let searchTimeout = null;
        
        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const response = await fetch('/api/me', {
                    headers: { 'Authorization': token }
                });
                if (!response.ok) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                window.location.href = '/login.html';
            }
        }
        
        // Switch tabs
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active', 'text-white');
                btn.classList.add('text-gray-600', 'hover:text-purple-600');
            });
            
            // Active current tab
            const activeTab = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600', 'hover:text-purple-600');
                activeTab.classList.add('tab-active', 'text-white');
            }
            
            // Perform search again with current query
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value) {
                performSearch(searchInput.value);
            } else {
                showEmptyState();
            }
        }
        
        // Perform search with debounce
        function performSearch(query) {
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (!query.trim()) {
                showEmptyState();
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const token = localStorage.getItem('token');
                    
                    // Show loading
                    document.getElementById('searchResults').innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-spinner fa-spin text-3xl text-purple-600 mb-4"></i>
                            <p class="text-gray-600">Searching...</p>
                        </div>
                    `;
                    
                    let endpoint = '';
                    switch (currentTab) {
                        case 'users':
                            endpoint = `/api/search/users?query=${encodeURIComponent(query)}`;
                            break;
                        case 'messages':
                            endpoint = `/api/search/messages?query=${encodeURIComponent(query)}`;
                            break;
                        case 'groups':
                            endpoint = `/api/search/groups?query=${encodeURIComponent(query)}`;
                            break;
                        case 'channels':
                            endpoint = `/api/search/channels?query=${encodeURIComponent(query)}`;
                            break;
                    }
                    
                    const response = await fetch(endpoint, {
                        headers: { 'Authorization': token }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        renderResults(data);
                    } else {
                        showError(data.error);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    showError('Search failed. Please try again.');
                }
            }, 300);
        }
        
        // Render search results
        function renderResults(data) {
            const container = document.getElementById('searchResults');
            
            if (!data[currentTab] || data[currentTab].length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search-minus text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-500">No results found</h3>
                        <p class="text-gray-400">Try different keywords or check spelling</p>
                    </div>
                `;
                return;
            }
            
            switch (currentTab) {
                case 'users':
                    container.innerHTML = renderUserResults(data.users);
                    break;
                case 'messages':
                    container.innerHTML = renderMessageResults(data.messages);
                    break;
                case 'groups':
                    container.innerHTML = renderGroupResults(data.groups);
                    break;
                case 'channels':
                    container.innerHTML = renderChannelResults(data.channels);
                    break;
            }
        }
        
        // Render user results
        function renderUserResults(users) {
            return `
                <div class="space-y-4">
                    ${users.map(user => `
                        <div class="search-result bg-white border border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition"
                             onclick="openUserProfile('${user._id}')">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img src="${user.avatar}" class="w-12 h-12 rounded-full">
                                    ${user.isOnline ? 
                                        '<div class="w-3 h-3 bg-green-500 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>' : 
                                        '<div class="w-3 h-3 bg-gray-400 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>'
                                    }
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-bold text-gray-800">${user.nickname}</h4>
                                            <p class="text-sm text-gray-600">@${user.username}</p>
                                        </div>
                                        <button onclick="startChatWithUser('${user._id}', event)" 
                                                class="text-purple-600 hover:text-purple-800 px-3 py-1 text-sm">
                                            <i class="fas fa-comment mr-1"></i> Chat
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">
                                        <i class="fas fa-university mr-1"></i> ${user.university}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Render message results
        function renderMessageResults(messages) {
            return `
                <div class="space-y-4">
                    ${messages.map(msg => `
                        <div class="search-result bg-white border border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition"
                             onclick="openChatFromMessage('${msg.senderId._id}', '${msg._id}')">
                            <div class="flex items-start space-x-3">
                                <img src="${msg.senderId.avatar}" class="w-10 h-10 rounded-full">
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-bold text-gray-800">${msg.senderId.nickname}</h4>
                                        <span class="text-xs text-gray-500">${formatTime(msg.createdAt)}</span>
                                    </div>
                                    <p class="text-gray-700 mt-1">${msg.text}</p>
                                    ${msg.mediaUrl ? `
                                        <div class="mt-2 text-sm text-gray-500">
                                            <i class="fas fa-file-${msg.mediaType} mr-1"></i> ${msg.mediaType}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Render group results
        function renderGroupResults(groups) {
            return `
                <div class="grid md:grid-cols-2 gap-4">
                    ${groups.map(group => `
                        <div class="search-result bg-white border border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition"
                             onclick="openGroup('${group._id}')">
                            <div class="flex items-start space-x-3">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-purple-600"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${group.name}</h4>
                                    <p class="text-sm text-gray-600">@${group.username}</p>
                                    <p class="text-gray-700 text-sm mt-2">${group.description}</p>
                                    <div class="flex items-center justify-between mt-3">
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-user mr-1"></i> ${group.members?.length || 0} members
                                        </span>
                                        <button onclick="joinGroup('${group._id}', event)" 
                                                class="text-purple-600 hover:text-purple-800 px-3 py-1 text-xs font-medium">
                                            Join Group
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Render channel results
        function renderChannelResults(channels) {
            return `
                <div class="grid md:grid-cols-2 gap-4">
                    ${channels.map(channel => `
                        <div class="search-result bg-white border border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition"
                             onclick="openChannel('${channel._id}')">
                            <div class="flex items-start space-x-3">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-broadcast-tower text-blue-600"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-800">${channel.name}</h4>
                                    <p class="text-sm text-gray-600">@${channel.username}</p>
                                    <p class="text-gray-700 text-sm mt-2">${channel.description}</p>
                                    <div class="flex items-center justify-between mt-3">
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-users mr-1"></i> ${channel.subscribers?.length || 0} subscribers
                                        </span>
                                        <button onclick="subscribeToChannel('${channel._id}', event)" 
                                                class="text-blue-600 hover:text-blue-800 px-3 py-1 text-xs font-medium">
                                            Subscribe
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Show empty state
        function showEmptyState() {
            document.getElementById('searchResults').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-500">Start Searching</h3>
                    <p class="text-gray-400">Type in the search box to find content</p>
                </div>
            `;
        }
        
        // Show error
        function showError(message) {
            document.getElementById('searchResults').innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-red-500">Search Error</h3>
                    <p class="text-red-400">${message}</p>
                </div>
            `;
        }
        
        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            showEmptyState();
        }
        
        // Open user profile
        function openUserProfile(userId) {
            window.location.href = `/profile.html?user=${userId}`;
        }
        
        // Start chat with user
        async function startChatWithUser(userId, event) {
            event.stopPropagation();
            
            try {
                const token = localStorage.getItem('token');
                // Check if conversation exists or create new
                window.location.href = `/chat.html?user=${userId}`;
            } catch (error) {
                console.error('Failed to start chat:', error);
            }
        }
        
        // Open chat from message
        function openChatFromMessage(userId, messageId) {
            window.location.href = `/chat.html?user=${userId}&message=${messageId}`;
        }
        
        // Open group
        function openGroup(groupId) {
            window.location.href = `/group.html?id=${groupId}`;
        }
        
        // Join group
        async function joinGroup(groupId, event) {
            event.stopPropagation();
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/groups/${groupId}/join`, {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Successfully joined the group!');
                    // Refresh search results
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput.value) {
                        performSearch(searchInput.value);
                    }
                } else {
                    alert(data.error || 'Failed to join group');
                }
            } catch (error) {
                console.error('Join group error:', error);
                alert('Failed to join group');
            }
        }
        
        // Open channel
        function openChannel(channelId) {
            window.location.href = `/channel.html?id=${channelId}`;
        }
        
        // Subscribe to channel
        async function subscribeToChannel(channelId, event) {
            event.stopPropagation();
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/channels/${channelId}/subscribe`, {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Successfully subscribed to channel!');
                    // Refresh search results
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput.value) {
                        performSearch(searchInput.value);
                    }
                } else {
                    alert(data.error || 'Failed to subscribe');
                }
            } catch (error) {
                console.error('Subscribe error:', error);
                alert('Failed to subscribe');
            }
        }
        
        // Format time
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString();
        }
        
        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Authorization': localStorage.getItem('token') }
                });
            } catch (error) {
                // Ignore errors
            }
            
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            // Set first tab as active
            switchTab('users');
        });
    </script>
</body>
</html>