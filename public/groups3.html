<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups - UniConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .group-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white h-16">
        <div class="container mx-auto px-4 h-full flex items-center justify-between">
            <a href="/messages.html" class="flex items-center space-x-2">
                <i class="fas fa-arrow-left"></i>
                <span class="font-semibold">Back to Messages</span>
            </a>
            <div class="flex items-center space-x-4">
                <a href="/search.html" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-search"></i>
                </a>
                <a href="/profile.html" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-user"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 gradient-bg rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-users text-white text-3xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800">Study Groups</h1>
            <p class="text-gray-600">Join or create study groups with classmates</p>
        </div>
        
        <!-- Create Group Button -->
        <div class="flex justify-center mb-8">
            <button onclick="openCreateModal()" 
                    class="gradient-bg text-white px-6 py-3 rounded-full font-semibold hover:opacity-90 transition flex items-center">
                <i class="fas fa-plus mr-2"></i> Create New Group
            </button>
        </div>
        
        <!-- Groups Tabs -->
        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
            <button onclick="switchGroupTab('my')" 
                    class="group-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-user-friends mr-2"></i> My Groups
            </button>
            <button onclick="switchGroupTab('joined')" 
                    class="group-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-users mr-2"></i> Joined Groups
            </button>
            <button onclick="switchGroupTab('all')" 
                    class="group-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
                <i class="fas fa-globe mr-2"></i> All Groups
            </button>
        </div>
        
        <!-- Groups Grid -->
        <div id="groupsContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Groups will be loaded here -->
            <div class="text-center py-12 col-span-full">
                <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-500">No groups yet</h3>
                <p class="text-gray-400">Create or join a group to get started</p>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="mt-12 bg-white rounded-xl shadow p-6">
            <h3 class="font-bold text-gray-800 mb-4">Group Statistics</h3>
            <div class="grid md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="totalGroups">0</div>
                    <div class="text-sm text-gray-600">Total Groups</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="myGroups">0</div>
                    <div class="text-sm text-gray-600">My Groups</div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600" id="joinedGroups">0</div>
                    <div class="text-sm text-gray-600">Joined</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600" id="totalMembers">0</div>
                    <div class="text-sm text-gray-600">Total Members</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Create New Group</h3>
                    <button onclick="closeCreateModal()" class="p-2 hover:bg-gray-100 rounded-full">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="createGroupForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group Name *</label>
                        <input type="text" name="name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="e.g., Computer Science Study Group">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group Username *</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-400">@</span>
                            <input type="text" name="username" required 
                                   class="w-full pl-8 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="e.g., cs-study-group">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" rows="3" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="What is this group about?"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">University</label>
                        <select name="university" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">All Universities</option>
                            <option value="Harvard University">Harvard University</option>
                            <option value="Stanford University">Stanford University</option>
                            <option value="MIT">MIT</option>
                            <option value="Cambridge University">Cambridge University</option>
                            <option value="Oxford University">Oxford University</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="isPrivate" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-600">Private Group (Invite only)</span>
                        </label>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" 
                                class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                            Create Group
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentGroupTab = 'my';
        
        // Check authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const response = await fetch('/api/me', {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    console.warn('Auth check returned non-ok status:', response.status);
                } else {
                    const data = await response.json();
                    if (!data.success) {
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
                if (error.name === 'TypeError' || error.message.includes('Failed to fetch')) {
                    console.error('Network error during auth check');
                } else {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            }
        }
        
        // Load groups
        async function loadGroups() {
            try {
                const token = localStorage.getItem('token');
                const endpoint = currentGroupTab === 'my' ? '/api/groups/my' : 
                                currentGroupTab === 'joined' ? '/api/groups/joined' : 
                                '/api/groups/all';
                
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderGroups(data.groups);
                    updateStats(data.stats);
                }
            } catch (error) {
                console.error('Failed to load groups:', error);
                showError('Failed to load groups');
            }
        }
        
        // Render groups
        function renderGroups(groups) {
            const container = document.getElementById('groupsContainer');
            
            if (!groups || groups.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 col-span-full">
                        <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-500">No groups found</h3>
                        <p class="text-gray-400">${currentGroupTab === 'my' ? 'Create your first group!' : 
                            currentGroupTab === 'joined' ? 'Join some groups to see them here!' : 
                            'No public groups available'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = groups.map(group => `
                <div class="group-card bg-white rounded-xl shadow overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 gradient-bg rounded-lg flex items-center justify-center">
                                <i class="fas fa-users text-white"></i>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${group.isPrivate ? 
                                    '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Private</span>' : 
                                    '<span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">Public</span>'
                                }
                                ${currentGroupTab === 'my' ? 
                                    '<span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">Admin</span>' : ''
                                }
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 text-lg mb-2">${group.name}</h3>
                        <p class="text-gray-600 text-sm mb-3">@${group.username}</p>
                        
                        <p class="text-gray-700 mb-4">${group.description || 'No description provided.'}</p>
                        
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-university mr-1"></i>
                                <span>${group.university || 'All Universities'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users mr-1"></i>
                                <span>${group.memberCount || group.members?.length || 0} members</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="openGroup('${group._id}')" 
                                    class="flex-1 gradient-bg text-white py-2 rounded-lg font-medium hover:opacity-90 transition">
                                <i class="fas fa-door-open mr-2"></i> Open
                            </button>
                            
                            ${currentGroupTab === 'my' ? `
                                <button onclick="manageGroup('${group._id}')" 
                                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                    <i class="fas fa-cog"></i>
                                </button>
                            ` : `
                                <button onclick="leaveGroup('${group._id}', event)" 
                                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            `}
                        </div>
                    </div>
                    
                    <!-- Members Preview -->
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Members</span>
                            <span class="text-xs text-gray-500">${group.members?.length || 0} members</span>
                        </div>
                        <div class="flex -space-x-2">
                            ${(group.members || []).slice(0, 5).map(member => `
                                <img src="${member.avatar}" 
                                     class="w-8 h-8 rounded-full border-2 border-white" 
                                     title="${member.nickname}">
                            `).join('')}
                            ${(group.members || []).length > 5 ? `
                                <div class="w-8 h-8 rounded-full border-2 border-white bg-gray-200 flex items-center justify-center text-xs">
                                    +${(group.members || []).length - 5}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update statistics
        function updateStats(stats) {
            if (stats) {
                document.getElementById('totalGroups').textContent = stats.totalGroups || 0;
                document.getElementById('myGroups').textContent = stats.myGroups || 0;
                document.getElementById('joinedGroups').textContent = stats.joinedGroups || 0;
                document.getElementById('totalMembers').textContent = stats.totalMembers || 0;
            }
        }
        
        // Show error
        function showError(message) {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = `
                <div class="text-center py-12 col-span-full">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-red-500">Error Loading Groups</h3>
                    <p class="text-red-400">${message}</p>
                    <button onclick="loadGroups()" 
                            class="mt-4 px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                        Try Again
                    </button>
                </div>
            `;
        }
        
        // Switch group tab
        function switchGroupTab(tab) {
            currentGroupTab = tab;
            
            // Update tab styles
            document.querySelectorAll('.group-tab').forEach(btn => {
                btn.classList.remove('text-purple-600', 'border-b-2', 'border-purple-600');
                btn.classList.add('text-gray-600', 'hover:text-purple-600');
            });
            
            // Active current tab
            const activeTab = document.querySelector(`[onclick="switchGroupTab('${tab}')"]`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600', 'hover:text-purple-600');
                activeTab.classList.add('text-purple-600', 'border-b-2', 'border-purple-600');
            }
            
            loadGroups();
        }
        
        // Open group
        function openGroup(groupId) {
            window.location.href = `/group.html?id=${groupId}`;
        }
        
        // Manage group
        function manageGroup(groupId) {
            alert(`Manage group ${groupId} - This would open group management interface`);
        }
        
        // Leave group
        async function leaveGroup(groupId, event) {
            event.stopPropagation();
            
            if (!confirm('Are you sure you want to leave this group?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/groups/${groupId}/leave`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadGroups();
                } else {
                    alert(data.error || 'Failed to leave group');
                }
            } catch (error) {
                console.error('Leave group error:', error);
                alert('Failed to leave group');
            }
        }
        
        // Open create modal
        function openCreateModal() {
            document.getElementById('createModal').classList.remove('hidden');
        }
        
        // Close create modal
        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
        }
        
        // Create group form submission
        document.getElementById('createGroupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // FIX: backend expects "Bearer <token>"
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Group created successfully!');
                    closeCreateModal();
                    loadGroups();
                } else {
                    alert(result.error || 'Failed to create group');
                }
            } catch (error) {
                console.error('Create group error:', error);
                alert('Failed to create group');
            }
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadGroups();
            // Set first tab as active
            switchGroupTab('my');
        });
    </script>
</body>
</html>