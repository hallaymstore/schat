<!doctype html>
<html lang="uz" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profil — SChat</title>
  <meta name="description" content="Profil: shaxsiy ma’lumotlar, coin balans, robotcha (pet) va inventar."/>
  <script>
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {
          fontFamily: { inter: ['Inter','ui-sans-serif','system-ui'] },
          boxShadow: { glass: '0 20px 60px rgba(0,0,0,.18)' },
          keyframes: {
            floaty: { '0%,100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-10px)' } },
            shimmer: { '0%': { backgroundPosition: '0% 50%' }, '100%': { backgroundPosition: '100% 50%' } },
            pop: { '0%': { transform: 'scale(.98)', opacity: .0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
            pulseSoft: { '0%,100%': { transform: 'scale(1)', opacity: .95 }, '50%': { transform: 'scale(1.04)', opacity: 1 } }
          },
          animation: {
            floaty: 'floaty 7s ease-in-out infinite',
            shimmer: 'shimmer 6s ease-in-out infinite',
            pop: 'pop .45s ease-out both',
            pulseSoft: 'pulseSoft 2.5s ease-in-out infinite'
          }
        }}
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --glass-bg: rgba(255,255,255,.58);
      --glass-brd: rgba(255,255,255,.36);
      --muted: rgba(15,23,42,.72);
      --muted2: rgba(15,23,42,.55);
      --grid: rgba(15,23,42,.06);
      --ring: rgba(99,102,241,.45);
      --ok: rgba(34,197,94,.18);
      --bad: rgba(239,68,68,.18);
    }
    .dark{
      --glass-bg: rgba(2,6,23,.58);
      --glass-brd: rgba(148,163,184,.16);
      --muted: rgba(226,232,240,.78);
      --muted2: rgba(226,232,240,.55);
      --grid: rgba(148,163,184,.08);
      --ring: rgba(236,72,153,.35);
      --ok: rgba(34,197,94,.14);
      --bad: rgba(239,68,68,.14);
    }
    body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .glass{
      background: var(--glass-bg);
      border: 1px solid var(--glass-brd);
      box-shadow: 0 20px 60px rgba(0,0,0,.18);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .btn-primary{ background: linear-gradient(135deg, rgba(99,102,241,1), rgba(236,72,153,1)); }
    .btn-primary:hover{ filter: brightness(1.05); }
    .btn-ghost:hover{ background: rgba(148,163,184,.12); }
    .glow-ring:focus{ outline:none; box-shadow: 0 0 0 5px var(--ring); }
    .u-anim{
      background: linear-gradient(90deg, rgba(99,102,241,1), rgba(236,72,153,1));
      background-size: 200% 200%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: shimmer 6s ease-in-out infinite;
    }
    .bg-orbs{
      position: fixed; inset: 0; z-index: -2; overflow: hidden;
      background:
        radial-gradient(1200px 600px at 12% 12%, rgba(99,102,241,.38), transparent 60%),
        radial-gradient(900px 520px at 88% 18%, rgba(236,72,153,.28), transparent 60%),
        radial-gradient(1000px 700px at 50% 92%, rgba(34,197,94,.22), transparent 60%),
        linear-gradient(180deg, rgba(248,250,252,1), rgba(241,245,249,1));
    }
    .dark .bg-orbs{
      background:
        radial-gradient(1200px 600px at 12% 12%, rgba(99,102,241,.24), transparent 60%),
        radial-gradient(900px 520px at 88% 18%, rgba(236,72,153,.19), transparent 60%),
        radial-gradient(1000px 700px at 50% 92%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(15,23,42,1));
    }
    .bg-grid{
      position: fixed; inset: 0; z-index: -1; pointer-events: none;
      background-image: linear-gradient(to right, var(--grid) 1px, transparent 1px),
                        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 70px 70px;
      mask-image: radial-gradient(closest-side at 50% 35%, black 0%, transparent 70%);
      opacity: .85;
    }
    .g-border{ position: relative; }
    .g-border:before{
      content:"";
      position:absolute; inset:-1px; border-radius: 1.5rem;
      background: linear-gradient(135deg, rgba(99,102,241,.55), rgba(236,72,153,.45), rgba(34,197,94,.35));
      z-index:-1;
    }
    /* progress */
    .bar{ height: 10px; border-radius: 999px; background: rgba(148,163,184,.18); overflow:hidden; }
    .bar > i{ display:block; height:100%; border-radius:999px; background: linear-gradient(90deg, rgba(34,197,94,1), rgba(99,102,241,1), rgba(236,72,153,1)); width: 50%; }
  </style>

  <script>
    (function(){
      const key='theme';
      const saved=localStorage.getItem(key);
      const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode=saved || (prefersDark?'dark':'light');
      if(mode==='dark') document.documentElement.classList.add('dark');
    })();
  </script>
</head>

<body class="min-h-screen text-slate-900 dark:text-slate-100">
  <div class="bg-orbs"></div>
  <div class="bg-grid"></div>

  <header class="sticky top-0 z-50">
    <div class="mx-auto max-w-6xl px-4 py-4">
      <div class="glass rounded-3xl px-4 py-3 flex items-center justify-between">
        <a href="/messages.html" class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl btn-primary flex items-center justify-center text-white shadow-glass">
            <i class="fa-solid fa-user-astronaut"></i>
          </div>
          <div class="leading-tight">
            <div class="font-extrabold tracking-tight">Profil</div>
            <div class="text-xs muted">Robotcha • Coin • Inventar</div>
          </div>
        </a>

        <div class="flex items-center gap-2">
          <a href="/petmarket.html" class="glass rounded-xl px-3 py-2 text-sm font-extrabold btn-ghost glow-ring" title="Pet Market">
            <i class="fa-solid fa-store"></i><span class="ml-2 hidden sm:inline">Pet Market</span>
          </a>
          <a href="/add-funds.html" class="btn-primary rounded-xl px-3 py-2 text-sm font-extrabold text-white glow-ring" title="Coin to‘ldirish">
            <i class="fa-solid fa-coins"></i><span class="ml-2 hidden sm:inline">Coin to‘ldirish</span>
          </a>
          <button id="themeToggle" class="glass rounded-xl px-3 py-2 text-sm font-extrabold muted btn-ghost glow-ring" title="Tungi/Kunduzgi">
            <i id="themeIcon" class="fa-solid fa-moon"></i><span class="ml-2 hidden sm:inline" id="themeLabel">Tungi</span>
          </button>
          <button id="logoutBtn" class="glass rounded-xl px-3 py-2 text-sm font-extrabold btn-ghost glow-ring" title="Chiqish">
            <i class="fa-solid fa-arrow-right-from-bracket"></i><span class="ml-2 hidden sm:inline">Chiqish</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">
    <div id="toast" class="hidden fixed top-6 left-1/2 -translate-x-1/2 z-[60] glass rounded-2xl px-4 py-3 text-sm font-extrabold"></div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Left: user card -->
      <section class="glass rounded-3xl p-6 g-border animate-pop lg:col-span-1">
        <div class="flex items-center gap-4">
          <img id="avatar" class="w-16 h-16 rounded-2xl object-cover border border-white/30" alt="Avatar"/>
          <div class="min-w-0">
            <div id="nickname" class="text-xl font-black tracking-tight truncate">—</div>
            <div id="username" class="text-sm muted2 truncate">@—</div>
            <div id="university" class="text-xs muted2 mt-1 truncate"><i class="fa-solid fa-building-columns mr-2"></i>—</div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-2 gap-3">
          <div class="glass rounded-2xl p-4">
            <div class="text-xs font-extrabold muted">Coin balans</div>
            <div class="mt-1 text-2xl font-black"><span id="coins">0</span> <span class="text-sm font-extrabold muted2">coin</span></div>
            <div class="mt-2 text-xs muted2">10 coin = 1000 so‘m</div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xs font-extrabold muted">Robotcha</div>
            <div class="mt-1 text-2xl font-black"><span id="petLevel">1</span> <span class="text-sm font-extrabold muted2">level</span></div>
            <div class="mt-2 text-xs muted2">XP va ochlikni boshqaring</div>
          </div>
        </div>

        <div class="mt-4 glass rounded-2xl p-4">
          <div class="text-xs font-extrabold muted">Bio</div>
          <div id="bio" class="mt-1 text-sm muted2 leading-relaxed">—</div>
        </div>

        <div id="adminBox" class="hidden mt-4 glass rounded-2xl p-4">
          <div class="text-xs font-extrabold muted">Admin</div>
          <div class="mt-2 flex items-center gap-2">
            <a href="/admin.html" class="btn-primary rounded-xl px-4 py-2 text-sm font-extrabold text-white glow-ring">
              Admin panelga o‘tish
            </a>
          </div>
          <div class="mt-2 text-xs muted2">Top-up so‘rovlarini tasdiqlash, foydalanuvchi balansini boshqarish.</div>
        </div>
      </section>

      <!-- Center: Robot -->
      <section class="glass rounded-3xl p-6 g-border animate-pop lg:col-span-1">
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="text-sm font-extrabold">Shaxsiy robotcha</div>
            <div class="text-xs muted2 mt-1">Oziqlantiring, rang bering, kiyim kiydiring</div>
          </div>
          <div class="glass rounded-2xl px-3 py-2 text-xs font-extrabold muted">
            <i class="fa-solid fa-hand-pointer mr-2"></i>robotchani bosing
          </div>
        </div>

        <div class="mt-5 flex items-center justify-center">
          <div class="relative">
            <div id="spark" class="absolute -inset-6 rounded-[32px] opacity-0"></div>
            <svg id="robot" viewBox="0 0 260 260" class="w-[240px] max-w-full drop-shadow-2xl select-none cursor-pointer">
              <defs>
                <linearGradient id="rgBody" x1="0" y1="0" x2="1" y2="1">
                  <stop id="b0" offset="0" stop-color="#6366f1"/>
                  <stop id="b1" offset="1" stop-color="#a855f7"/>
                </linearGradient>
                <linearGradient id="rgOutfit" x1="0" y1="0" x2="1" y2="1">
                  <stop id="o0" offset="0" stop-color="#ec4899"/>
                  <stop id="o1" offset="1" stop-color="#f59e0b"/>
                </linearGradient>
              </defs>

              <g id="antenna">
                <path d="M130 20 C112 20 110 46 130 46 C150 46 148 20 130 20Z" fill="url(#rgOutfit)" opacity="0.92"/>
                <path d="M130 46 L130 70" stroke="rgba(148,163,184,.8)" stroke-width="8" stroke-linecap="round"/>
                <circle cx="130" cy="16" r="10" fill="url(#rgOutfit)"/>
              </g>

              <g id="head">
                <rect x="50" y="62" width="160" height="132" rx="42" fill="url(#rgBody)"/>
                <rect x="72" y="96" width="116" height="62" rx="24" fill="rgba(15,23,42,.10)"/>
              </g>

              <g id="eyes" transform="translate(0,0)">
                <g id="eyeL" transform="translate(108 126)">
                  <circle r="14" fill="rgba(2,6,23,.75)"/>
                  <circle r="4" cx="4" cy="-2" fill="rgba(255,255,255,.9)"/>
                  <path id="blinkL" d="M-14 0 Q0 10 14 0" stroke="rgba(2,6,23,.55)" stroke-width="4" stroke-linecap="round" fill="none" opacity="0"/>
                </g>
                <g id="eyeR" transform="translate(152 126)">
                  <circle r="14" fill="rgba(2,6,23,.75)"/>
                  <circle r="4" cx="4" cy="-2" fill="rgba(255,255,255,.9)"/>
                  <path id="blinkR" d="M-14 0 Q0 10 14 0" stroke="rgba(2,6,23,.55)" stroke-width="4" stroke-linecap="round" fill="none" opacity="0"/>
                </g>
              </g>

              <g id="mouthHappy" opacity="1">
                <path d="M106 174 Q130 190 154 174" stroke="rgba(2,6,23,.55)" stroke-width="7" stroke-linecap="round" fill="none"/>
              </g>
              <g id="mouthSad" opacity="0">
                <path d="M106 192 Q130 176 154 192" stroke="rgba(2,6,23,.55)" stroke-width="7" stroke-linecap="round" fill="none"/>
              </g>

              <g id="outfit">
                <path d="M70 204 C90 230 170 230 190 204" stroke="url(#rgOutfit)" stroke-width="18" stroke-linecap="round" fill="none" opacity="0.95"/>
              </g>
            </svg>

            <div class="mt-3 text-center text-xs muted2">
              <span id="robotHint">Holat: yuklanmoqda…</span>
            </div>
          </div>
        </div>

        <div class="mt-5 grid gap-4">
          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs font-extrabold muted">Ochlik (Hunger)</div>
              <div class="text-xs font-extrabold"><span id="hungerVal">0</span>/100</div>
            </div>
            <div class="mt-2 bar"><i id="hungerBar"></i></div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs font-extrabold muted">XP</div>
              <div class="text-xs font-extrabold"><span id="xpVal">0</span>/100</div>
            </div>
            <div class="mt-2 bar"><i id="xpBar"></i></div>
          </div>

          <div class="grid sm:grid-cols-3 gap-3">
            <button id="feedBtn" class="btn-primary rounded-2xl px-4 py-3 text-sm font-extrabold text-white glow-ring">
              <i class="fa-solid fa-burger mr-2"></i>Oziqlantirish
            </button>
            <button id="paintBtn" class="glass rounded-2xl px-4 py-3 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-palette mr-2"></i>Rang berish
            </button>
            <button id="outfitBtn" class="glass rounded-2xl px-4 py-3 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-shirt mr-2"></i>Kiyim
            </button>
          </div>
        </div>
      </section>

      <!-- Right: inventory + history -->
      <section class="glass rounded-3xl p-6 g-border animate-pop lg:col-span-1">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-extrabold">Inventar</div>
            <div class="text-xs muted2 mt-1">Olingan mahsulotlar shu yerda ko‘rinadi</div>
          </div>
          <a href="/petmarket.html" class="glass rounded-xl px-3 py-2 text-xs font-extrabold btn-ghost glow-ring">
            <i class="fa-solid fa-store mr-2"></i>Market
          </a>
        </div>

        <div class="mt-4 space-y-3">
          <div class="glass rounded-2xl p-4">
            <div class="text-xs font-extrabold muted mb-2"><i class="fa-solid fa-burger mr-2"></i>Ovqatlar</div>
            <div id="foods" class="grid gap-2"></div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xs font-extrabold muted mb-2"><i class="fa-solid fa-palette mr-2"></i>Bo‘yoqlar</div>
            <div id="paints" class="grid gap-2"></div>
          </div>
          <div class="glass rounded-2xl p-4">
            <div class="text-xs font-extrabold muted mb-2"><i class="fa-solid fa-shirt mr-2"></i>Kiyimlar</div>
            <div id="outfits" class="grid gap-2"></div>
          </div>
        </div>

        <div class="mt-4 glass rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <div class="text-xs font-extrabold muted">Coin to‘ldirish so‘rovlari</div>
            <a href="/add-funds.html" class="text-xs font-extrabold underline">Yangi so‘rov</a>
          </div>
          <div id="topupList" class="mt-2 space-y-2"></div>
        </div>
      </section>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 z-[70]">
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="absolute inset-0 flex items-end sm:items-center justify-center p-4">
        <div class="glass rounded-3xl w-full max-w-lg p-5 sm:p-6 g-border">
          <div class="flex items-center justify-between">
            <div>
              <div id="modalTitle" class="text-lg font-black">—</div>
              <div id="modalSub" class="text-xs muted2 mt-1">—</div>
            </div>
            <button id="modalClose" class="glass rounded-xl px-3 py-2 btn-ghost glow-ring">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div id="modalBody" class="mt-4"></div>

          <div class="mt-5 flex items-center justify-end gap-2">
            <button id="modalCancel" class="glass rounded-xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">Bekor</button>
            <button id="modalOk" class="btn-primary rounded-xl px-4 py-2 text-sm font-extrabold text-white glow-ring">Qo‘llash</button>
          </div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // Theme toggle
    (function(){
      const key='theme';
      const html=document.documentElement;
      const btn=document.getElementById('themeToggle');
      const icon=document.getElementById('themeIcon');
      const label=document.getElementById('themeLabel');

      function apply(mode){
        if(mode==='dark') html.classList.add('dark'); else html.classList.remove('dark');
        localStorage.setItem(key, mode);
        if(icon) icon.className = mode==='dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        if(label) label.textContent = mode==='dark' ? 'Kunduzgi' : 'Tungi';
      }
      const saved = localStorage.getItem(key);
      if(saved) apply(saved);
      else {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        apply(prefersDark ? 'dark' : 'light');
      }
      btn && btn.addEventListener('click', ()=> apply(html.classList.contains('dark') ? 'light' : 'dark'));
    })();

    // Helpers
    const token = () => localStorage.getItem('token') || '';
    const authHeaders = () => ({ 'Authorization': `Bearer ${token()}`, 'Content-Type': 'application/json' });

    const toast = (text, type='info') => {
      const el = document.getElementById('toast');
      el.textContent = text;
      el.classList.remove('hidden');
      el.style.background = type === 'error' ? 'var(--bad)' : 'var(--ok)';
      el.style.border = '1px solid rgba(148,163,184,.2)';
      el.style.color = type === 'error' ? 'rgba(220,38,38,.95)' : 'rgba(16,185,129,.95)';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.add('hidden'), 4200);
    };

    const fmtDate = (d) => {
      try { return new Date(d).toLocaleString('uz-UZ'); } catch { return ''; }
    };

    // Modal
    const modal = {
      root: document.getElementById('modal'),
      title: document.getElementById('modalTitle'),
      sub: document.getElementById('modalSub'),
      body: document.getElementById('modalBody'),
      ok: document.getElementById('modalOk'),
      cancel: document.getElementById('modalCancel'),
      close: document.getElementById('modalClose'),
      show({title, sub, bodyHTML, onOk}){
        this.title.textContent = title || '';
        this.sub.textContent = sub || '';
        this.body.innerHTML = bodyHTML || '';
        this.root.classList.remove('hidden');
        const handler = async () => {
          this.ok.disabled = true;
          try { await onOk?.(); this.hide(); } finally { this.ok.disabled = false; }
        };
        this.ok.onclick = handler;
      },
      hide(){ this.root.classList.add('hidden'); this.ok.onclick = null; }
    };
    modal.cancel.onclick = () => modal.hide();
    modal.close.onclick = () => modal.hide();
    modal.root.addEventListener('click', (e)=> { if(e.target === modal.root.querySelector('.absolute.inset-0.bg-black\\/40')) modal.hide(); });

    // Robot interactivity
    const eyeGroup = () => document.getElementById('eyes');
    const blinkL = () => document.getElementById('blinkL');
    const blinkR = () => document.getElementById('blinkR');
    const mouthHappy = () => document.getElementById('mouthHappy');
    const mouthSad = () => document.getElementById('mouthSad');
    const hint = () => document.getElementById('robotHint');

    function setMood(ok){
      mouthHappy().style.opacity = ok ? '1' : '0';
      mouthSad().style.opacity = ok ? '0' : '1';
    }
    function blink(){
      blinkL().style.opacity = '1';
      blinkR().style.opacity = '1';
      setTimeout(()=>{ blinkL().style.opacity = '0'; blinkR().style.opacity = '0'; }, 180);
    }
    function lookAt(x,y){
      const g = eyeGroup();
      const r = g.getBoundingClientRect();
      const cx = r.left + r.width/2;
      const cy = r.top + r.height/2;
      const dx = Math.max(-10, Math.min(10, (x - cx)/18));
      const dy = Math.max(-8, Math.min(8, (y - cy)/20));
      g.setAttribute('transform', `translate(${dx},${dy})`);
    }

    document.addEventListener('mousemove', (e)=> lookAt(e.clientX, e.clientY));
    document.getElementById('robot').addEventListener('click', ()=>{
      blink();
      const s = document.getElementById('spark');
      s.style.opacity = '1';
      s.style.background = 'radial-gradient(closest-side, rgba(236,72,153,.32), transparent 65%)';
      s.classList.add('animate-pulseSoft');
      setTimeout(()=>{ s.style.opacity = '0'; s.classList.remove('animate-pulseSoft'); }, 520);
    });
    setInterval(()=>{ if(!document.hidden) blink(); }, 4200);

    // State
    let market = null;
    let petState = null;

    function setRobotColors(bodyColor, outfitColor){
      const b0 = document.getElementById('b0');
      const b1 = document.getElementById('b1');
      const o0 = document.getElementById('o0');
      const o1 = document.getElementById('o1');
      if(b0) b0.setAttribute('stop-color', bodyColor);
      if(b1) b1.setAttribute('stop-color', '#a855f7');
      if(o0) o0.setAttribute('stop-color', outfitColor);
      if(o1) o1.setAttribute('stop-color', '#f59e0b');
    }

    function setBars(hunger, xp){
      const h = Math.max(0, Math.min(100, hunger||0));
      const x = Math.max(0, Math.min(100, xp||0));
      document.getElementById('hungerVal').textContent = h;
      document.getElementById('xpVal').textContent = x;
      document.getElementById('hungerBar').style.width = `${h}%`;
      document.getElementById('xpBar').style.width = `${x}%`;
      setMood(h >= 25);
      hint().textContent = h < 25 ? "Holat: och qoldim… ovqat bering" : "Holat: zo‘r! davom eting";
    }

    function renderInv(list, containerId, btnText, onUse){
      const box = document.getElementById(containerId);
      box.innerHTML = '';
      if(!list || !list.length){
        box.innerHTML = `<div class="text-xs muted2">Hozircha bo‘sh. Marketdan xarid qiling.</div>`;
        return;
      }
      for(const it of list){
        const qty = Number(it.qty||0);
        const disabled = qty<=0;
        const extra = it.color ? `<span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background:${it.color}"></span><span class="muted2">${it.name}</span></span>` : `<span class="muted2">${it.name}</span>`;
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-3 glass rounded-xl px-3 py-2';
        row.innerHTML = `
          <div class="min-w-0">
            <div class="text-xs font-extrabold">${extra}</div>
            <div class="text-[11px] muted2 mt-0.5">Soni: <span class="font-extrabold">${qty}</span></div>
          </div>
          <button ${disabled?'disabled':''} class="px-3 py-2 rounded-xl text-xs font-extrabold glow-ring ${disabled?'opacity-40 cursor-not-allowed':'btn-primary text-white'}">${btnText}</button>
        `;
        row.querySelector('button').onclick = ()=> onUse(it);
        box.appendChild(row);
      }
    }

    function renderTopups(items){
      const box = document.getElementById('topupList');
      box.innerHTML = '';
      if(!items || !items.length){
        box.innerHTML = `<div class="text-xs muted2">Hozircha so‘rov yo‘q.</div>`;
        return;
      }
      for(const r of items.slice(0,6)){
        const st = r.status === 'approved' ? 'Tasdiqlandi' : (r.status === 'rejected' ? 'Rad etildi' : 'Kutilmoqda');
        const badge = r.status === 'approved'
          ? 'bg-emerald-500/15 text-emerald-500'
          : (r.status === 'rejected' ? 'bg-red-500/15 text-red-500' : 'bg-amber-500/15 text-amber-500');
        const row = document.createElement('div');
        row.className = 'glass rounded-xl px-3 py-2 flex items-center justify-between gap-3';
        row.innerHTML = `
          <div class="min-w-0">
            <div class="text-xs font-extrabold">${r.coins} coin <span class="muted2">(${r.amountSom} so‘m)</span></div>
            <div class="text-[11px] muted2 mt-0.5">${fmtDate(r.createdAt)}</div>
          </div>
          <div class="text-[11px] font-extrabold px-2 py-1 rounded-lg ${badge}">${st}</div>
        `;
        box.appendChild(row);
      }
    }

    async function loadProfile(){
      const t = token();
      if(!t){ window.location.href = '/login.html'; return; }

      // /api/me for profile basic
      const meRes = await fetch('/api/me', { headers: { 'Authorization': `Bearer ${t}` } }).catch(()=>null);
      if(!meRes || !meRes.ok){ localStorage.removeItem('token'); window.location.href = '/login.html'; return; }
      const me = await meRes.json().catch(()=>null);

      const u = me && (me.user || me);
      if(u){
        document.getElementById('avatar').src = u.avatar || 'https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png';
        document.getElementById('nickname').textContent = u.nickname || u.fullName || 'Foydalanuvchi';
        document.getElementById('username').textContent = '@' + (u.username || '');
        document.getElementById('university').innerHTML = `<i class="fa-solid fa-building-columns mr-2"></i>${u.university || '—'}`;
        document.getElementById('bio').textContent = u.bio || 'Bio yozilmagan.';
      }

      // /api/pet/me for coins+pet+inv+market
      const pRes = await fetch('/api/pet/me', { headers: { 'Authorization': `Bearer ${t}` } }).catch(()=>null);
      if(!pRes || !pRes.ok){
        const err = await pRes?.json?.().catch(()=>null);
        toast(err?.error || "Pet ma’lumotlarini yuklab bo‘lmadi", 'error');
        return;
      }
      const pdata = await pRes.json();
      market = pdata.market;
      petState = { coins: pdata.coins, pet: pdata.pet, inventory: pdata.inventory, isAdmin: pdata.isAdmin };

      document.getElementById('coins').textContent = petState.coins || 0;
      document.getElementById('petLevel').textContent = petState.pet?.level || 1;
      setRobotColors(petState.pet?.color || '#6366f1', petState.pet?.outfitColor || '#ec4899');
      setBars(petState.pet?.hunger || 0, petState.pet?.xp || 0);

      renderInv(petState.inventory?.foods, 'foods', 'Yedirish', (it)=> openFeed(it.id));
      renderInv(petState.inventory?.paints, 'paints', 'Bo‘yash', (it)=> openPaint(it.id));
      renderInv(petState.inventory?.outfits, 'outfits', 'Kiyish', (it)=> useOutfit(it.id));

      if(petState.isAdmin) document.getElementById('adminBox').classList.remove('hidden');

      // topups list
      const tr = await fetch('/api/wallet/topup-requests', { headers: { 'Authorization': `Bearer ${t}` } }).catch(()=>null);
      if(tr && tr.ok){
        const tj = await tr.json().catch(()=>null);
        renderTopups(tj?.requests || []);
      }
    }

    async function refreshPet(){
      const t = token();
      const pRes = await fetch('/api/pet/me', { headers: { 'Authorization': `Bearer ${t}` } }).catch(()=>null);
      if(!pRes || !pRes.ok) return;
      const pdata = await pRes.json();
      market = pdata.market;
      petState = { coins: pdata.coins, pet: pdata.pet, inventory: pdata.inventory, isAdmin: pdata.isAdmin };
      document.getElementById('coins').textContent = petState.coins || 0;
      document.getElementById('petLevel').textContent = petState.pet?.level || 1;
      setRobotColors(petState.pet?.color || '#6366f1', petState.pet?.outfitColor || '#ec4899');
      setBars(petState.pet?.hunger || 0, petState.pet?.xp || 0);
      renderInv(petState.inventory?.foods, 'foods', 'Yedirish', (it)=> openFeed(it.id));
      renderInv(petState.inventory?.paints, 'paints', 'Bo‘yash', (it)=> openPaint(it.id));
      renderInv(petState.inventory?.outfits, 'outfits', 'Kiyish', (it)=> useOutfit(it.id));
    }

    // Actions
    function openFeed(defaultFoodId=null){
      const items = petState?.inventory?.foods || [];
      const options = items.filter(x => (x.qty||0)>0).map(x => `<option value="${x.id}" ${x.id===defaultFoodId?'selected':''}>${x.name} (+${x.hungerPlus||10}) — ${x.qty} dona</option>`).join('');
      modal.show({
        title: "Robotchani oziqlantirish",
        sub: "Ovqat tanlang (inventardan sarflanadi)",
        bodyHTML: `
          <label class="text-xs font-extrabold muted">Ovqat</label>
          <select id="foodSel" class="mt-2 w-full glass rounded-2xl px-4 py-3 text-sm glow-ring">${options || '<option disabled>Ovqat yo‘q</option>'}</select>
          <div class="mt-3 text-xs muted2">Marketdan ovqat sotib olishingiz mumkin: <a class="underline font-extrabold" href="/petmarket.html">Pet Market</a></div>
        `,
        onOk: async ()=>{
          const sel = document.getElementById('foodSel');
          const foodId = sel?.value;
          if(!foodId) return toast("Ovqat tanlanmadi", 'error');
          const res = await fetch('/api/pet/feed', { method:'POST', headers: authHeaders(), body: JSON.stringify({ foodId }) });
          const j = await res.json().catch(()=>null);
          if(!res.ok) return toast(j?.error || "Oziqlantirib bo‘lmadi", 'error');
          toast("Robotcha xursand. Yaxshi!", 'success');
          await refreshPet();
        }
      });
    }

    function openPaint(defaultPaintId=null){
      const items = petState?.inventory?.paints || [];
      const options = items.filter(x => (x.qty||0)>0).map(x => `<option value="${x.id}" ${x.id===defaultPaintId?'selected':''}>${x.name} — ${x.qty} dona</option>`).join('');
      modal.show({
        title: "Rang berish",
        sub: "Bo‘yoq tanlang va qaysi qism bo‘yalishini belgilang",
        bodyHTML: `
          <label class="text-xs font-extrabold muted">Bo‘yoq</label>
          <select id="paintSel" class="mt-2 w-full glass rounded-2xl px-4 py-3 text-sm glow-ring">${options || '<option disabled>Bo‘yoq yo‘q</option>'}</select>

          <label class="mt-4 text-xs font-extrabold muted block">Qayerga</label>
          <div class="mt-2 grid grid-cols-2 gap-2">
            <label class="glass rounded-2xl px-4 py-3 text-sm font-extrabold flex items-center gap-2">
              <input type="radio" name="target" value="body" checked> Tana rangi
            </label>
            <label class="glass rounded-2xl px-4 py-3 text-sm font-extrabold flex items-center gap-2">
              <input type="radio" name="target" value="outfit"> Kiyim rangi
            </label>
          </div>

          <div class="mt-3 text-xs muted2">Market: <a class="underline font-extrabold" href="/petmarket.html">Pet Market</a></div>
        `,
        onOk: async ()=>{
          const sel = document.getElementById('paintSel');
          const paintId = sel?.value;
          const target = document.querySelector('input[name="target"]:checked')?.value || 'body';
          if(!paintId) return toast("Bo‘yoq tanlanmadi", 'error');
          const res = await fetch('/api/pet/paint', { method:'POST', headers: authHeaders(), body: JSON.stringify({ paintId, target }) });
          const j = await res.json().catch(()=>null);
          if(!res.ok) return toast(j?.error || "Bo‘yab bo‘lmadi", 'error');
          toast("Rang yangilandi!", 'success');
          await refreshPet();
        }
      });
    }

    async function useOutfit(defaultOutfitId=null){
      const items = petState?.inventory?.outfits || [];
      const opts = items.filter(x => (x.qty||0)>0).map(x => `<option value="${x.id}" ${x.id===defaultOutfitId?'selected':''}>${x.name} — ${x.qty} dona</option>`).join('');
      modal.show({
        title: "Kiyim kiydirish",
        sub: "Kiyim tanlang (inventardan 1 dona sarflanadi)",
        bodyHTML: `
          <label class="text-xs font-extrabold muted">Kiyim</label>
          <select id="outSel" class="mt-2 w-full glass rounded-2xl px-4 py-3 text-sm glow-ring">${opts || '<option disabled>Kiyim yo‘q</option>'}</select>
          <div class="mt-3 text-xs muted2">Market: <a class="underline font-extrabold" href="/petmarket.html">Pet Market</a></div>
        `,
        onOk: async ()=>{
          const outfitId = document.getElementById('outSel')?.value;
          if(!outfitId) return toast("Kiyim tanlanmadi", 'error');
          const res = await fetch('/api/pet/equip', { method:'POST', headers: authHeaders(), body: JSON.stringify({ outfitId }) });
          const j = await res.json().catch(()=>null);
          if(!res.ok) return toast(j?.error || "Kiyim kiydirib bo‘lmadi", 'error');
          toast("Kiyim yangilandi!", 'success');
          await refreshPet();
        }
      });
    }

    // Quick buttons
    document.getElementById('feedBtn').onclick = ()=> openFeed();
    document.getElementById('paintBtn').onclick = ()=> openPaint();
    document.getElementById('outfitBtn').onclick = ()=> useOutfit();

    document.getElementById('logoutBtn').onclick = async ()=>{
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    };

    // Init
    loadProfile().catch(()=> toast("Yuklashda xatolik", 'error'));
  </script>
</body>
</html>
