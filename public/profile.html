<!doctype html>
<html lang="uz" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profil — HALLAYM edu</title>

  <script>
    tailwind = { config: { darkMode:'class', theme:{ extend:{
      fontFamily:{ inter:['Inter','ui-sans-serif','system-ui'] },
      keyframes:{
        floaty:{'0%,100%':{transform:'translateY(0px)'},'50%':{transform:'translateY(-10px)'}},
        shimmer:{'0%':{backgroundPosition:'0% 50%'},'100%':{backgroundPosition:'100% 50%'}},
        pop:{'0%':{transform:'scale(.98)',opacity:'0'},'100%':{transform:'scale(1)',opacity:'1'}},
        blink:{'0%,92%,100%':{transform:'scaleY(1)'},'94%,98%':{transform:'scaleY(.08)'}},
        laser:{'0%':{transform:'scaleX(0)',opacity:'0'},'10%':{opacity:'1'},'55%':{transform:'scaleX(1)',opacity:'1'},'100%':{transform:'scaleX(0)',opacity:'0'}},
        hop:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-14px)'}},
        aura:{'0%':{filter:'hue-rotate(0deg)'},'100%':{filter:'hue-rotate(360deg)'}}
      },
      animation:{
        floaty:'floaty 7s ease-in-out infinite',
        shimmer:'shimmer 7s ease-in-out infinite',
        pop:'pop .45s ease-out both',
        blink:'blink 6s ease-in-out infinite',
        laser:'laser 2.6s ease-in-out infinite',
        hop:'hop 1.6s ease-in-out infinite',
        aura:'aura 8s linear infinite'
      }
    }}}};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,.58);
      --glass-brd: rgba(255,255,255,.32);
      --muted: rgba(15,23,42,.72);
      --muted2: rgba(15,23,42,.55);
      --grid: rgba(15,23,42,.06);
      --ring: rgba(245,158,11,.55);
      --ok: rgba(34,197,94,.18);
      --bad: rgba(239,68,68,.18);
      --shadow: rgba(0,0,0,.22);
    }
    .dark{
      --glass-bg: rgba(2,6,23,.62);
      --glass-brd: rgba(148,163,184,.16);
      --muted: rgba(226,232,240,.78);
      --muted2: rgba(226,232,240,.55);
      --grid: rgba(148,163,184,.08);
      --ring: rgba(236,72,153,.35);
      --ok: rgba(34,197,94,.14);
      --bad: rgba(239,68,68,.14);
      --shadow: rgba(0,0,0,.52);
    }

    body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .glass{
      background: var(--glass-bg);
      border: 1px solid var(--glass-brd);
      box-shadow: 0 20px 60px var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .g-border{
      position:relative;
      overflow:hidden;
    }
    .g-border::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(99,102,241,.9), rgba(236,72,153,.9), rgba(34,197,94,.7));
      filter: blur(14px);
      opacity:.35;
      z-index:0;
    }
    .g-border > *{ position:relative; z-index:1; }

    .btn-primary{ background: linear-gradient(135deg, rgba(16,185,129,1), rgba(245,158,11,1)); }
    .btn-primary:hover{ filter: brightness(1.05); }
    .btn-ghost:hover{ background: rgba(148,163,184,.12); }
    .glow-ring:focus{ outline:none; box-shadow: 0 0 0 5px var(--ring); }
    .chip{ background: rgba(148,163,184,.12); border: 1px solid rgba(148,163,184,.18); }
    .chip.active{ background: rgba(20,184,166,.22); border-color: rgba(99,102,241,.32); }

    /* Robot stage */
    .stage{
      position:relative;
      height: 300px;
      border-radius: 28px;
      overflow:hidden;
      border: 1px solid rgba(148,163,184,.18);
      background:
        radial-gradient(900px 550px at 15% 0%, rgba(20,184,166,.22), transparent 55%),
        radial-gradient(900px 550px at 85% 10%, rgba(245,158,11,.18), transparent 60%),
        radial-gradient(900px 550px at 50% 105%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0));
    }
    .dark .stage{
      background:
        radial-gradient(900px 550px at 15% 0%, rgba(99,102,241,.22), transparent 55%),
        radial-gradient(900px 550px at 85% 10%, rgba(236,72,153,.20), transparent 60%),
        radial-gradient(900px 550px at 50% 105%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(180deg, rgba(15,23,42,.32), rgba(2,6,23,.0));
    }
    .robot-wrap{
      position:absolute;
      left: 50%;
      top: 54%;
      transform: translate(-50%,-50%);
      width: 240px;
      height: 240px;
      pointer-events:none;
      filter: drop-shadow(0 20px 35px rgba(0,0,0,.28));
    }
    .robot-wrap .laser-beam{
      transform-origin: 0% 50%;
    }

    /* Variant visuals by typeId */
    .r-starter .core{ filter: saturate(1.08); }
    .r-pixel .core{ filter: contrast(1.1) saturate(1.3); image-rendering: pixelated; }
    .r-neo .shine{ opacity:.9; }
    .r-astro .stars{ opacity:1; }
    .r-mochi .core{ filter: saturate(1.2); }
    .r-lux .aura{ opacity:1; }
    .r-laser .laser-beam{ opacity:1; }
    .r-shade .glasses{ opacity:1; }
    .r-shade.glasses-off .glasses{ opacity:.08; transform: translateY(10px) rotate(8deg); }
    .r-mochi .squish{ animation: floaty 5.8s ease-in-out infinite; }
    .r-pixel .jitter{ animation: floaty 4.2s ease-in-out infinite; }
    .r-lux .aura{ animation: aura 8s linear infinite; }

    /* Advanced stage/motion modes */
    .stage.theme-night{
      background:
        radial-gradient(900px 550px at 18% 8%, rgba(30,41,59,.48), transparent 58%),
        radial-gradient(900px 550px at 82% 12%, rgba(14,116,144,.30), transparent 62%),
        linear-gradient(180deg, rgba(2,6,23,.44), rgba(15,23,42,.22));
    }
    .stage.theme-sunset{
      background:
        radial-gradient(900px 550px at 18% 8%, rgba(251,146,60,.30), transparent 58%),
        radial-gradient(900px 550px at 82% 12%, rgba(244,63,94,.28), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0));
    }
    .stage.theme-mint{
      background:
        radial-gradient(900px 550px at 18% 8%, rgba(16,185,129,.26), transparent 58%),
        radial-gradient(900px 550px at 82% 12%, rgba(34,211,238,.24), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0));
    }
    .stage.theme-aurora{
      background:
        radial-gradient(900px 550px at 15% 0%, rgba(20,184,166,.22), transparent 55%),
        radial-gradient(900px 550px at 85% 10%, rgba(245,158,11,.18), transparent 60%),
        radial-gradient(900px 550px at 50% 105%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0));
    }
    .dark .stage.theme-aurora{
      background:
        radial-gradient(900px 550px at 15% 0%, rgba(99,102,241,.22), transparent 55%),
        radial-gradient(900px 550px at 85% 10%, rgba(236,72,153,.20), transparent 60%),
        radial-gradient(900px 550px at 50% 105%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(180deg, rgba(15,23,42,.32), rgba(2,6,23,.0));
    }

    @keyframes rDance{
      0%,100%{ transform:translate(-50%,-50%) rotate(-3deg) scale(1); }
      25%{ transform:translate(-50%,-52%) rotate(2deg) scale(1.02); }
      50%{ transform:translate(-50%,-48%) rotate(-1deg) scale(1.01); }
      75%{ transform:translate(-50%,-51%) rotate(2deg) scale(1.02); }
    }
    @keyframes rSpin{
      0%{ transform:translate(-50%,-50%) rotate(0deg); }
      100%{ transform:translate(-50%,-50%) rotate(360deg); }
    }
    @keyframes rGuard{
      0%,100%{ transform:translate(-50%,-50%) translateX(-6px); }
      50%{ transform:translate(-50%,-50%) translateX(6px); }
    }
    @keyframes rHop{
      0%,100%{ transform:translate(-50%,-50%) translateY(0); }
      50%{ transform:translate(-50%,-55%) translateY(-10px); }
    }
    .robot-wrap.motion-float{ animation: floaty 7s ease-in-out infinite; }
    .robot-wrap.motion-dance{ animation: rDance 1.8s ease-in-out infinite; }
    .robot-wrap.motion-spin{ animation: rSpin 4.8s linear infinite; }
    .robot-wrap.motion-guard{ animation: rGuard 2.8s ease-in-out infinite; }
    .robot-wrap.motion-hop{ animation: rHop 1.4s ease-in-out infinite; }
    .robot-wrap.fx-off .aura,
    .robot-wrap.fx-off .stars,
    .robot-wrap.fx-off .shine,
    .robot-wrap.fx-off .laser-beam{ opacity: .05 !important; animation: none !important; }
    .robot-wrap.fx-on .aura{ opacity: 1 !important; }
    .robot-wrap.fx-on .stars{ opacity: 1 !important; }

    @keyframes cOrbit{
      0%{ transform:translate(0,0) rotate(0deg); }
      25%{ transform:translate(-10px,-6px) rotate(5deg); }
      50%{ transform:translate(0,-12px) rotate(0deg); }
      75%{ transform:translate(10px,-6px) rotate(-5deg); }
      100%{ transform:translate(0,0) rotate(0deg); }
    }
    @keyframes cPulse{
      0%,100%{ transform:scale(1); }
      50%{ transform:scale(1.1); }
    }
    .companion.motion-hop{ animation: hop 1.6s ease-in-out infinite; }
    .companion.motion-orbit{ animation: cOrbit 3.8s ease-in-out infinite; }
    .companion.motion-pulse{ animation: cPulse 1.2s ease-in-out infinite; }
    .companion.motion-idle{ animation: none; }

    .scene-chip{
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid rgba(148,163,184,.24);
      background: rgba(148,163,184,.12);
      line-height: 1;
    }
    .scene-chip.active{
      border-color: rgba(16,185,129,.42);
      background: rgba(16,185,129,.18);
      box-shadow: 0 0 0 3px rgba(16,185,129,.12);
    }

    /* Companion bubble */
    .companion{
      position:absolute;
      right: 16px;
      bottom: 14px;
      min-width: 58px;
      height: 58px;
      border-radius: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 30px;
      background: rgba(255,255,255,.56);
      border: 1px solid rgba(255,255,255,.32);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      user-select:none;
    }
    .dark .companion{ background: rgba(2,6,23,.55); border-color: rgba(148,163,184,.16); }
    .companion.hop{ animation: hop 1.6s ease-in-out infinite; }
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 60;
      max-width: 420px;
    }
  
    /* profile mobile drawer */
    .pMobileOnly{display:none}
    .pDesktopOnly{display:flex}
    .pIconBtn{
      width:44px;height:44px;border-radius:16px;
      display:inline-flex;align-items:center;justify-content:center;
      background: var(--glass-bg);
      border: 1px solid var(--glass-brd);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 18px 40px var(--shadow);
      transition: transform .08s ease, filter .12s ease;
    }
    .pIconBtn:active{transform:translateY(1px)}
    .pdrawerBack{position:fixed; inset:0; z-index:80; background:rgba(2,6,23,.55); display:none}
    .pdrawerBack.open{display:block}
    .pdrawer{
      position:absolute; right:12px; top:12px;
      width:min(380px, 92vw);
      border-radius:22px;
      padding:12px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-brd);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 22px 70px var(--shadow);
      transform: translateY(-6px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .pdrawerBack.open .pdrawer{transform: translateY(0); opacity:1}
    .pdrawer a, .pdrawer button{width:100%}
    @media (max-width:640px){
      .pDesktopOnly{display:none}
      .pMobileOnly{display:inline-flex}
    }
    @media (prefers-reduced-motion: reduce){
      .pdrawer, .pIconBtn { transition:none !important; }
    }
  </style>

<style id="hallaymMobileCompact">
  /* ===== HALLAYM Mobile Compact (no overflow) ===== */
  :root{
    --mc-font: 13px;
    --mc-font-sm: 12px;
    --mc-radius: 18px;
    --mc-pad: 10px;
    --mc-gap: 10px;
    --mc-icon: 14px;
    --mc-btn-h: 36px;
  }
  html, body{ max-width:100%; overflow-x:hidden; }
  /* Safe wrapping everywhere */
  *{ min-width: 0; }
  .wrap-anywhere{ overflow-wrap:anywhere; word-break:break-word; }

  /* Scrollbars (thin + glassy) */
  *{ scrollbar-width: thin; scrollbar-color: rgba(148,163,184,.45) transparent; }
  *::-webkit-scrollbar{ width: 10px; height: 10px; }
  *::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.35); border-radius: 999px; border: 2px solid transparent; background-clip: padding-box; }
  *::-webkit-scrollbar-thumb:hover{ background: rgba(148,163,184,.52); }

  /* Compact mode (<= 480px) */
  @media (max-width: 480px){
    body{ font-size: var(--mc-font); }
    .glass{ border-radius: var(--mc-radius) !important; }

    /* Reduce huge headings */
    h1, h2{ font-size: 18px !important; line-height: 1.15 !important; }
    h3{ font-size: 15px !important; line-height: 1.2 !important; }

    /* Buttons/inputs compact */
    button, a, input, textarea, select{
      font-size: var(--mc-font) !important;
    }
    input, textarea{
      padding-top: 10px !important;
      padding-bottom: 10px !important;
    }

    /* Prevent icons from eating space */
    i, svg{ max-width: 100%; }
    .fa-solid, .fas{ font-size: var(--mc-icon) !important; }

    /* Generic padding shrink helpers */
    .p-6{ padding: 12px !important; }
    .p-5{ padding: 12px !important; }
    .p-4{ padding: 10px !important; }
    .px-4{ padding-left: 10px !important; padding-right: 10px !important; }
    .py-3{ padding-top: 10px !important; padding-bottom: 10px !important; }

    /* Gap shrink */
    .gap-6{ gap: 12px !important; }
    .gap-4{ gap: 10px !important; }
    .gap-3{ gap: 8px !important; }
  }
</style>

<style id="hallaymProfileTweaks">
  /* Logo-like teal/gold accents */
  .btn-primary{ background: linear-gradient(135deg, rgba(34,211,238,1), rgba(20,184,166,1), rgba(245,158,11,1)) !important; }
  .g-border::before{
    background: linear-gradient(135deg, rgba(34,211,238,.75), rgba(20,184,166,.65), rgba(245,158,11,.55)) !important;
    opacity:.32 !important;
  }

  /* Ensure cards never overflow */
  .stage{ max-width: 100%; }

  @media (max-width: 480px){
    header{ padding-top: 12px !important; }
    header .max-w-6xl{ gap: 8px !important; }
    header a .w-11, header a .h-11{ width: 40px !important; height: 40px !important; }
    header .font-black{ font-size: 14px !important; }

    main{ padding-bottom: 84px !important; } /* room for mobile nav elsewhere */
    .robot-wrap{ width: 190px !important; height: 190px !important; }
    .stage{ height: 240px !important; border-radius: 22px !important; }
    .text-xl{ font-size: 18px !important; }
    .text-lg{ font-size: 15px !important; }
    .text-sm{ font-size: 13px !important; }
    .text-xs{ font-size: 11.5px !important; }

    /* Chips and tool buttons */
    .chip{ padding: 4px 10px !important; border-radius: 999px !important; }
    #ownerTools a, #ownerTools button, #publicTools a, #publicTools button{
      padding: 10px 12px !important;
      border-radius: 16px !important;
      font-size: 13px !important;
    }

    /* Make grids single column when needed */
    #robotsGrid{ grid-template-columns: 1fr !important; }
    #companionsGrid{ grid-template-columns: 1fr 1fr !important; }
  }
</style>

  <link rel="stylesheet" href="/ui-glass-theme.css" />
</head>

<body class="min-h-screen text-slate-900 dark:text-slate-100">
  <div class="fixed inset-0 -z-10 pointer-events-none">
    <div class="absolute inset-0"
      style="background:
        radial-gradient(1200px 800px at 15% 10%, rgba(20,184,166,.22), transparent 60%),
        radial-gradient(1100px 740px at 85% 12%, rgba(236,72,153,.14), transparent 62%),
        radial-gradient(1000px 700px at 50% 95%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.58), rgba(255,255,255,.18));">
    </div>
    <div class="absolute inset-0 opacity-60"
      style="background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
        background-size: 48px 48px;">
    </div>
  </div>

  <header class="px-4 md:px-8 pt-6">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <a href="/index.html" class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl grid place-items-center">
          <svg viewBox="0 0 120 120" class="w-11 h-11 drop-shadow-[0_10px_22px_rgba(0,0,0,.25)]" aria-hidden="true">
            <defs>
              <linearGradient id="gGold" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#fbbf24"/>
                <stop offset="1" stop-color="#f59e0b"/>
              </linearGradient>
              <linearGradient id="gAqua" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#22d3ee"/>
                <stop offset="1" stop-color="#34d399"/>
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="52" fill="none" stroke="url(#gGold)" stroke-width="8"/>
            <ellipse cx="60" cy="63" rx="44" ry="28" fill="#071a1f" stroke="url(#gGold)" stroke-width="5"/>
            <path d="M23 35 C30 27, 38 24, 45 26" stroke="url(#gGold)" stroke-width="3" fill="none" opacity=".9"/>
            <circle cx="27" cy="37" r="4" fill="url(#gGold)"/>
            <text x="60" y="72" text-anchor="middle" font-size="26" font-weight="900" fill="url(#gAqua)" style="letter-spacing:.5px">hallaym</text>
          </svg>
        </div>
        <div>
          <div class="font-black leading-tight">HALLAYM edu</div>
          <div class="text-xs muted2 -mt-0.5">Profil</div>
        </div>
      </a>

      <div class="flex items-center gap-2 pDesktopOnly">
        <button id="themeBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-moon mr-2"></i>Rejim
        </button>
        <a href="/channels.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden sm:inline-flex">
          <i class="fa-solid fa-hashtag mr-2"></i>Kanallar
        </a>
        <a href="/groups.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden sm:inline-flex">
          <i class="fa-solid fa-users mr-2"></i>Guruhlar
        </a>
        <button id="logoutBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>Chiqish
        </button>
      </div>

      <div class="flex items-center gap-2 pMobileOnly">
        <button id="pMenuBtn" class="pIconBtn glow-ring" aria-label="Menu" aria-haspopup="dialog" aria-expanded="false">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>
    </div>
  </header>

  <div id="pDrawerBack" class="pdrawerBack" role="dialog" aria-modal="true" aria-label="Menu">
    <div class="pdrawer">
      <div class="flex items-center justify-between gap-2">
        <div class="font-black">Menyu</div>
        <button id="pDrawerClose" class="pIconBtn glow-ring" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="mt-3 grid gap-2">
        <button id="pThemeBtn2" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-moon mr-2"></i>Tema
        </button>
        <a href="/channels.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-hashtag mr-2"></i>Kanallar
        </a>
        <a href="/groups.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-users mr-2"></i>Guruhlar
        </a>
        <a href="/index.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-house mr-2"></i>Home
        </a>
        <button id="pLogoutBtn2" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>Chiqish
        </button>
      </div>
      <div class="text-xs muted2 mt-3">ESC yoki tashqarisini bosib yopasiz.</div>
    </div>
  </div>

  <main class="px-4 md:px-8 pb-16">
    <div class="max-w-6xl mx-auto mt-6 grid lg:grid-cols-12 gap-6">
      <!-- Left: Profile card -->
      <section class="lg:col-span-4 glass rounded-3xl p-6 g-border animate-pop">
        <div class="relative rounded-3xl overflow-hidden border border-white/20 dark:border-slate-700/30">
          <div id="cover" class="h-28 bg-gradient-to-r from-indigo-500/30 via-pink-500/25 to-emerald-500/25"></div>
          <div class="absolute -bottom-8 left-5 w-16 h-16 rounded-3xl overflow-hidden border-4 border-white/60 dark:border-slate-900/70 shadow-xl bg-white/30">
            <img id="avatar" alt="avatar" class="w-full h-full object-cover" src=""/>
          </div>
        </div>

        <div class="mt-10">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div id="name" class="text-xl font-black leading-tight">—</div>
              <div class="mt-1 flex flex-wrap items-center gap-2">
                <span id="uname" class="chip rounded-2xl px-3 py-1 text-xs font-extrabold">—</span>
                <span id="uni" class="chip rounded-2xl px-3 py-1 text-xs font-extrabold">—</span>
              </div>
              <div id="bio" class="mt-3 text-sm muted">—</div>
            </div>

            <div class="text-right">
              <div class="text-xs muted2">Holat</div>
              <div id="status" class="mt-1 text-sm font-extrabold">—</div>
              <div class="mt-2 text-xs muted2">Coin</div>
              <div class="text-lg font-black"><span id="coins">0</span> <span class="text-xs muted2 font-extrabold">coin</span></div>
            </div>
          </div>

          <div id="ownerTools" class="mt-5 flex flex-wrap gap-2 hidden">
            <a href="/add-funds.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary glow-ring text-white">
              <i class="fa-solid fa-coins mr-2"></i>Coin to‘ldirish
            </a>
            <a href="/petmarket.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-store mr-2"></i>Pet Market
            </a>

            <button type="button" onclick="openEdit()" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-user-pen mr-2"></i>Profilni tahrirlash
            </button>
          </div>

          <div id="publicTools" class="mt-5 flex flex-wrap gap-2 hidden">
            <a id="dmBtn" href="/messages.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-paper-plane mr-2"></i>Yozish
            </a>
            <button id="pokeBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary glow-ring text-white">
              <i class="fa-solid fa-hand-sparkles mr-2"></i>Salom berish
            </button>
          </div>
        </div>
      </section>

      <!-- Right: Robot stage + collections -->
      <section class="lg:col-span-8 space-y-6">
        <!-- Stage -->
        <div class="glass rounded-3xl p-6 g-border animate-pop">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-black">Asosiy robotcha</div>
              <div id="robotSub" class="text-xs muted2 mt-1">Robotcha turi va animatsiyalari profilga bog‘liq bo‘ladi.</div>
            </div>
            <div class="flex items-center gap-2 pDesktopOnly">
              <button id="playBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden">
                <i class="fa-solid fa-gamepad mr-2"></i>O‘ynash
              </button>
              <button id="toggleGlassesBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden">
                <i class="fa-solid fa-glasses mr-2"></i>Ko‘zoynak
              </button>
            </div>
          </div>

          <div class="mt-4 stage glass">
            <div id="robotWrap" class="robot-wrap r-starter">
              <!-- robot SVG injected -->
            </div>
            <div id="companionBubble" class="companion hidden">🐾</div>
          </div>

          <div id="trialBanner" class="mt-3 hidden"></div>

          <div id="sceneControls" class="mt-4 glass rounded-2xl p-4 hidden">
            <div class="flex items-center justify-between gap-3 flex-wrap">
              <div>
                <div class="text-sm font-black">Robot sahna boshqaruvi</div>
                <div class="text-xs muted2 mt-0.5">Harakat, effekt va sahna fonini tanlab saqlang.</div>
              </div>
              <div class="flex items-center gap-2">
                <button id="sceneResetBtn" class="glass rounded-xl px-3 py-2 text-xs font-extrabold btn-ghost glow-ring">
                  <i class="fa-solid fa-rotate-left mr-1"></i>Reset
                </button>
                <button id="sceneSaveBtn" class="glass rounded-xl px-3 py-2 text-xs font-extrabold btn-primary text-white glow-ring">
                  <i class="fa-solid fa-floppy-disk mr-1"></i>Saqlash
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="text-[11px] muted2 font-extrabold mb-2">Robot harakati</div>
              <div id="robotMotionChips" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="mt-3">
              <div class="text-[11px] muted2 font-extrabold mb-2">Hamroh harakati</div>
              <div id="companionMotionChips" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="mt-3 grid sm:grid-cols-2 gap-3">
              <label class="block">
                <div class="text-[11px] muted2 font-extrabold mb-1">Sahna temasi</div>
                <select id="sceneThemeSel" class="w-full glass rounded-2xl px-3 py-2 text-xs outline-none">
                  <option value="aurora">Aurora</option>
                  <option value="night">Night</option>
                  <option value="sunset">Sunset</option>
                  <option value="mint">Mint</option>
                </select>
              </label>
              <label class="block">
                <div class="text-[11px] muted2 font-extrabold mb-1">Robot effektlari</div>
                <select id="sceneFxSel" class="w-full glass rounded-2xl px-3 py-2 text-xs outline-none">
                  <option value="auto">Auto</option>
                  <option value="on">Doim ON</option>
                  <option value="off">OFF</option>
                </select>
              </label>
            </div>
          </div>

          <div class="mt-4 grid sm:grid-cols-3 gap-3">
            <div class="glass rounded-2xl p-4">
              <div class="text-xs muted2 font-extrabold">Daraja</div>
              <div class="mt-1 text-xl font-black"><span id="level">1</span></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs muted2 font-extrabold">Yoqimtoylik</div>
              <div class="mt-1 text-xl font-black"><span id="cuteness">50</span><span class="text-xs muted2 font-extrabold ml-1">/100</span></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs muted2 font-extrabold">Hamroh</div>
              <div class="mt-1 text-xl font-black"><span id="companionName">—</span></div>
            </div>
          </div>
        </div>

        <!-- Robots collection -->
        <div class="glass rounded-3xl p-6 g-border animate-pop">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-black">Robotlar kolleksiyasi</div>
              <div class="text-xs muted2 mt-1">Asosiy robotchani tanlang yoki yangi robot sotib oling.</div>
            </div>
            <div class="flex items-center gap-2 pDesktopOnly">
              <button id="openShopBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary glow-ring text-white hidden">
                <i class="fa-solid fa-bag-shopping mr-2"></i>Robot do‘koni
              </button>
            </div>
          </div>

          <div id="robotsGrid" class="mt-4 grid md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Companions collection -->
        <div class="glass rounded-3xl p-6 g-border animate-pop">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-black">Hayvonchalar</div>
              <div class="text-xs muted2 mt-1">Pet Market’dan hamroh sotib oling va profilga qo‘ying.</div>
            </div>
            <a href="/petmarket.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-paw mr-2"></i>Pet Market
            </a>
          </div>

          <div id="companionsGrid" class="mt-4 grid md:grid-cols-3 gap-4"></div>
        </div>

        <!-- Robot Studio -->
        <div id="robotStudioCard" class="glass rounded-3xl p-6 g-border animate-pop hidden">
          <div class="text-lg font-black">Robot Studio</div>
          <div class="text-xs muted2 mt-1">Robot va hamroh ko‘rinishini saqlang: nom, rang va aksessuar.</div>

          <div class="mt-4 grid md:grid-cols-2 gap-4">
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Robot nomi</div>
              <input id="studioRobotName" class="w-full glass rounded-2xl px-4 py-2 text-sm outline-none" maxlength="40" placeholder="Masalan: Neon Ustoz"/>
            </label>
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Robot tana rangi</div>
              <input id="studioRobotColor" type="color" class="w-full h-10 glass rounded-2xl px-2 py-1"/>
            </label>
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Robot kiyim rangi</div>
              <input id="studioRobotOutfit" type="color" class="w-full h-10 glass rounded-2xl px-2 py-1"/>
            </label>
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Hamroh nomi</div>
              <input id="studioCompanionName" class="w-full glass rounded-2xl px-4 py-2 text-sm outline-none" maxlength="30" placeholder="Masalan: Fox do‘stim"/>
            </label>
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Hamroh rangi</div>
              <input id="studioCompanionColor" type="color" class="w-full h-10 glass rounded-2xl px-2 py-1"/>
            </label>
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Aksessuar rangi</div>
              <input id="studioCompanionAccessory" type="color" class="w-full h-10 glass rounded-2xl px-2 py-1"/>
            </label>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="studioApplyBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-eye mr-2"></i>Preview
            </button>
            <button id="studioSaveBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary text-white glow-ring">
              <i class="fa-solid fa-floppy-disk mr-2"></i>Saqlash
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast"></div>

<script>
  // ===== Theme =====
  const themeKey = 'theme';
  const root = document.documentElement;
  function setTheme(mode){
    if(mode === 'dark'){ root.classList.add('dark'); localStorage.setItem(themeKey,'dark'); }
    else { root.classList.remove('dark'); localStorage.setItem(themeKey,'light'); }
  }
  setTheme(localStorage.getItem(themeKey) || 'light');
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    setTheme(root.classList.contains('dark') ? 'light' : 'dark');
  });

  
  // ===== Mobile drawer (profile) =====
  const pBack = document.getElementById('pDrawerBack');
  const pBtn = document.getElementById('pMenuBtn');
  const pClose = document.getElementById('pDrawerClose');
  function pOpenDrawer(){ pBack.classList.add('open'); pBtn && pBtn.setAttribute('aria-expanded','true'); }
  function pCloseDrawer(){ pBack.classList.remove('open'); pBtn && pBtn.setAttribute('aria-expanded','false'); }
  if(pBtn) pBtn.addEventListener('click', pOpenDrawer);
  if(pClose) pClose.addEventListener('click', pCloseDrawer);
  if(pBack) pBack.addEventListener('click', (e)=>{ if(e.target===pBack) pCloseDrawer(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') pCloseDrawer(); });

  const pTheme2 = document.getElementById('pThemeBtn2');
  if(pTheme2) pTheme2.addEventListener('click', ()=>{ document.getElementById('themeBtn').click(); });
  const pLogout2 = document.getElementById('pLogoutBtn2');
  if(pLogout2) pLogout2.addEventListener('click', ()=>{ document.getElementById('logoutBtn').click(); });

// ===== Auth helpers =====
  function token(){ return localStorage.getItem('token') || ''; }
  function getToken(){ return token(); }
  function authHeaders(json=true){
    const t = token();
    const h = { 'Authorization': `Bearer ${t}` };
    if(json) h['Content-Type'] = 'application/json';
    return h;
  }
  function goLogin(){ location.href = '/login.html'; }

  // ===== Toast =====
  function toast(msg, type='info'){
    const el = document.getElementById('toast');
    const bg = type==='error' ? 'rgba(239,68,68,.18)' : type==='success' ? 'rgba(34,197,94,.18)' : 'rgba(99,102,241,.14)';
    const br = type==='error' ? 'rgba(239,68,68,.30)' : type==='success' ? 'rgba(34,197,94,.26)' : 'rgba(245,158,11,.22)';
    el.innerHTML = `
      <div class="glass rounded-2xl p-4 g-border" style="background:${bg}; border-color:${br}">
        <div class="text-sm font-extrabold">${escapeHtml(msg)}</div>
      </div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 3200);
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ===== Parse target profile =====
  const qs = new URLSearchParams(location.search);
  const qUserId = (qs.get('user') || qs.get('userId') || '').trim();
  const qUsername = (qs.get('u') || qs.get('username') || '').trim();

  const isValidObjectId = (v)=> /^[a-fA-F0-9]{24}$/.test(v);

  let me = null;
  let viewed = null;
  let isOwner = false;

  // Robot + companion state
  let catalog = [];
  let upgrades = {};
  let glassesOff = false;
  let sceneState = { robotMotion:'float', companionMotion:'hop', stageTheme:'aurora', robotFx:'auto' };
  let stageModeBound = false;
  let studioBound = false;
  let trialState = null;

  const ROBOT_MOTION_OPTS = [
    { id:'float', label:'Float', icon:'fa-water' },
    { id:'dance', label:'Dance', icon:'fa-music' },
    { id:'guard', label:'Guard', icon:'fa-shield-halved' },
    { id:'spin', label:'Spin', icon:'fa-rotate' },
    { id:'hop', label:'Hop', icon:'fa-person-running' }
  ];
  const COMP_MOTION_OPTS = [
    { id:'hop', label:'Hop', icon:'fa-person-running' },
    { id:'orbit', label:'Orbit', icon:'fa-satellite' },
    { id:'pulse', label:'Pulse', icon:'fa-heart-pulse' },
    { id:'idle', label:'Idle', icon:'fa-pause' }
  ];

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('token');
    goLogin();
  });

  async function apiJson(url, opt={}){
    const res = await fetch(url, opt);
    const j = await res.json().catch(()=>null);
    if(!res.ok) throw new Error(j?.error || `Xatolik: ${res.status}`);
    return j;
  }

  function normalizeScene(raw){
    const allowedRobot = new Set(['float','dance','guard','spin','hop']);
    const allowedComp = new Set(['hop','orbit','pulse','idle']);
    const allowedTheme = new Set(['aurora','night','sunset','mint']);
    const allowedFx = new Set(['auto','on','off']);
    const r = String(raw?.robotMotion || '').toLowerCase().trim();
    const c = String(raw?.companionMotion || '').toLowerCase().trim();
    const t = String(raw?.stageTheme || '').toLowerCase().trim();
    const f = String(raw?.robotFx || '').toLowerCase().trim();
    return {
      robotMotion: allowedRobot.has(r) ? r : 'float',
      companionMotion: allowedComp.has(c) ? c : 'hop',
      stageTheme: allowedTheme.has(t) ? t : 'aurora',
      robotFx: allowedFx.has(f) ? f : 'auto'
    };
  }

  function sceneStorageKey(){
    const uid = String(me?._id || viewed?._id || 'me');
    return `schat:scene:${uid}`;
  }
  function readLocalScene(){
    try{
      const raw = localStorage.getItem(sceneStorageKey());
      if(!raw) return null;
      return normalizeScene(JSON.parse(raw));
    }catch(_){ return null; }
  }
  function writeLocalScene(scene){
    try{ localStorage.setItem(sceneStorageKey(), JSON.stringify(normalizeScene(scene))); }catch(_){}
  }

  async function loadSceneState(){
    if(isOwner){
      try{
        const j = await apiJson('/api/pet/scene', { headers: authHeaders(false) });
        sceneState = normalizeScene(j?.scene || me?.petScene || readLocalScene() || {});
        writeLocalScene(sceneState);
        return;
      }catch(_){}
      sceneState = normalizeScene(me?.petScene || readLocalScene() || {});
      return;
    }
    sceneState = normalizeScene(viewed?.petScene || {});
  }

  async function saveSceneState(){
    if(!isOwner) return;
    const body = normalizeScene(sceneState);
    try{
      await apiJson('/api/pet/scene', {
        method:'POST',
        headers: authHeaders(true),
        body: JSON.stringify(body)
      });
      writeLocalScene(body);
      if(me) me.petScene = body;
      if(viewed && String(viewed._id||'') === String(me?._id||'')) viewed.petScene = body;
      toast('Robot sahnasi saqlandi', 'success');
    }catch(e){
      writeLocalScene(body);
      toast('Server saqlamadi, lokal rejimda saqlandi', 'error');
    }
  }

  function loadTrialState(){
    trialState = null;
    try{
      const raw = localStorage.getItem('schat:petmarket-trial');
      if(!raw) return;
      const t = JSON.parse(raw);
      const age = Date.now() - Number(t?.ts || 0);
      if (!t || !t.kind || !t.id || age > (2 * 24 * 60 * 60 * 1000)) {
        localStorage.removeItem('schat:petmarket-trial');
        return;
      }
      trialState = {
        kind: String(t.kind || '').toLowerCase(),
        id: String(t.id || '').trim(),
        name: String(t.name || '').trim(),
        price: Number(t.price || 0),
        emoji: String(t.emoji || ''),
        rarity: String(t.rarity || ''),
        moodBoost: Number(t.moodBoost || 0),
        source: String(t.source || ''),
        ts: Number(t.ts || Date.now())
      };
    }catch(_){
      try{ localStorage.removeItem('schat:petmarket-trial'); }catch(_){}
    }
  }

  function clearTrialState(){
    trialState = null;
    try{ localStorage.removeItem('schat:petmarket-trial'); }catch(_){}
  }

  async function loadMe(){
    const t = token();
    if(!t) return goLogin();
    const j = await apiJson('/api/me', { headers: authHeaders(false) });
    me = j.user;
    return me;
  }

  async function loadViewed(){
    // normalize: ignore null/undefined
    const uid = (qUserId === 'null' || qUserId === 'undefined') ? '' : qUserId;
    const un = (qUsername === 'null' || qUsername === 'undefined') ? '' : qUsername;

    if(un){
      const j = await apiJson('/api/user/by-username/' + encodeURIComponent(un), { headers: authHeaders(false) });
      viewed = j.user;
      return viewed;
    }
    if(uid && isValidObjectId(uid)){
      const j = await apiJson('/api/user/' + encodeURIComponent(uid), { headers: authHeaders(false) });
      viewed = j.user;
      return viewed;
    }
    viewed = me;
    return viewed;
  }

  function setProfileUI(u){
    document.getElementById('avatar').src = u.avatar || 'https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png';
    document.getElementById('cover').style.background = u.coverBanner
      ? `url('${u.coverBanner}') center/cover no-repeat`
      : 'linear-gradient(90deg, rgba(245,158,11,.22), rgba(20,184,166,.20), rgba(34,211,238,.16))';

    document.getElementById('name').textContent = u.fullName || u.nickname || 'Foydalanuvchi';
    document.getElementById('uname').textContent = '@' + (u.username || '');
    document.getElementById('uni').textContent = u.university || 'Universitet';
    document.getElementById('bio').textContent = u.bio || 'Bio yozilmagan.';
    document.getElementById('status').textContent = u.status || (u.isOnline ? 'online' : 'offline');

    // coins only for owner; otherwise hide precise number
    document.getElementById('coins').textContent = isOwner ? (me?.coins || 0) : '—';

    document.getElementById('ownerTools').classList.toggle('hidden', !isOwner);
    document.getElementById('publicTools').classList.toggle('hidden', isOwner);

    if(!isOwner){
      // DM link quick attach
      const dm = document.getElementById('dmBtn');
      dm.href = '/chat.html?u=' + encodeURIComponent(u.username || '');
    }
  }

  function robotSVG({ body='#6366f1', outfit='#ec4899', typeId='starter' }){
    // Layers toggled by CSS classes on wrapper
    return `
    <svg viewBox="0 0 240 240" width="240" height="240" aria-hidden="true">
      <defs>
        <linearGradient id="gBody" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="${body}" stop-opacity=".95"></stop>
          <stop offset="1" stop-color="${body}" stop-opacity=".55"></stop>
        </linearGradient>
        <linearGradient id="gOut" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="${outfit}" stop-opacity=".92"></stop>
          <stop offset="1" stop-color="${outfit}" stop-opacity=".55"></stop>
        </linearGradient>
        <radialGradient id="gShine" cx="30%" cy="25%" r="65%">
          <stop offset="0" stop-color="white" stop-opacity=".60"></stop>
          <stop offset="1" stop-color="white" stop-opacity="0"></stop>
        </radialGradient>
      </defs>

      <!-- Aura (lux) -->
      <g class="aura" opacity="0">
        <circle cx="120" cy="120" r="100" fill="none" stroke="rgba(236,72,153,.35)" stroke-width="10"></circle>
        <circle cx="120" cy="120" r="86" fill="none" stroke="rgba(99,102,241,.30)" stroke-width="8"></circle>
      </g>

      <!-- Stars (astro) -->
      <g class="stars" opacity="0">
        ${Array.from({length: 10}).map((_,i)=> {
          const x = 25 + (i*19)%190;
          const y = 20 + (i*29)%150;
          return `<circle cx="${x}" cy="${y}" r="${(i%3)+1}" fill="rgba(255,255,255,.55)"></circle>`;
        }).join('')}
      </g>

      <!-- Robot body -->
      <g class="core ${typeId==='mochi' ? 'squish':''} ${typeId==='pixel' ? 'jitter':''}">
        <rect x="44" y="58" width="152" height="150" rx="46" fill="url(#gBody)"></rect>
        <rect x="58" y="150" width="124" height="48" rx="24" fill="url(#gOut)"></rect>

        <!-- shine (neo) -->
        <path class="shine" opacity="0" d="M72 72 C120 40, 160 58, 176 98 C150 92, 118 96, 92 120 C76 106, 68 92, 72 72 Z" fill="url(#gShine)"></path>

        <!-- eyes -->
        <g transform="translate(0,0)">
          <rect x="78" y="104" width="34" height="20" rx="10" fill="rgba(2,6,23,.55)"></rect>
          <rect x="128" y="104" width="34" height="20" rx="10" fill="rgba(2,6,23,.55)"></rect>
          <circle class="eye" cx="95" cy="114" r="5" fill="rgba(255,255,255,.9)"></circle>
          <circle class="eye" cx="145" cy="114" r="5" fill="rgba(255,255,255,.9)"></circle>
          <g class="blink" style="transform-origin: 120px 114px" transform="translate(0,0)">
            <rect x="78" y="104" width="34" height="20" rx="10" fill="transparent"></rect>
          </g>
        </g>

        <!-- mouth -->
        <path d="M102 138 Q120 150 138 138" fill="none" stroke="rgba(2,6,23,.45)" stroke-width="6" stroke-linecap="round"></path>

        <!-- glasses (shade) -->
        <g class="glasses" opacity="0">
          <rect x="70" y="100" width="48" height="28" rx="12" fill="rgba(15,23,42,.45)" stroke="rgba(255,255,255,.35)" stroke-width="2"></rect>
          <rect x="122" y="100" width="48" height="28" rx="12" fill="rgba(15,23,42,.45)" stroke="rgba(255,255,255,.35)" stroke-width="2"></rect>
          <rect x="116" y="112" width="8" height="4" rx="2" fill="rgba(255,255,255,.35)"></rect>
        </g>

        <!-- antenna -->
        <circle cx="120" cy="52" r="8" fill="rgba(255,255,255,.55)"></circle>
        <rect x="118" y="52" width="4" height="10" rx="2" fill="rgba(255,255,255,.35)"></rect>
      </g>

      <!-- Laser beams (laser) -->
      <g class="laser-beam" opacity="0">
        <rect x="112" y="112" width="160" height="4" rx="2" fill="rgba(239,68,68,.85)"></rect>
        <rect x="112" y="116" width="160" height="2" rx="1" fill="rgba(255,255,255,.65)"></rect>
      </g>
    </svg>`;
  }

  function applyRobot(wrapper, robot){
    const typeId = robot?.typeId || 'starter';
    const body = robot?.baseColor || '#6366f1';
    const outfit = robot?.outfitColor || '#ec4899';
    const motion = String(sceneState?.robotMotion || 'float');
    const fx = String(sceneState?.robotFx || 'auto');

    wrapper.className = `robot-wrap r-${typeId} motion-${motion} fx-${fx}` + (typeId==='shade' && glassesOff ? ' glasses-off' : '');
    wrapper.innerHTML = robotSVG({ body, outfit, typeId });

    // Laser animation if laser robot
    const beam = wrapper.querySelector('.laser-beam');
    if(beam){
      beam.style.animation = (motion === 'guard' ? 'laser 1.6s ease-in-out infinite' : 'laser 2.6s ease-in-out infinite');
    }
  }

  function applyCompanion(bubble, comp){
    if(!comp){ bubble.classList.add('hidden'); document.getElementById('companionName').textContent='—'; return; }
    bubble.classList.remove('hidden');
    bubble.textContent = comp.emoji || '🐾';
    document.getElementById('companionName').textContent = comp.name || 'Hamroh';
    bubble.classList.remove('hop', 'motion-hop', 'motion-orbit', 'motion-pulse', 'motion-idle');
    const cm = String(sceneState?.companionMotion || ((comp.typeId||'').includes('bunny') ? 'hop' : 'idle'));
    bubble.classList.add('motion-' + cm);
    bubble.style.color = comp.color || '';
    bubble.style.textShadow = comp.accessoryColor ? `0 0 12px ${comp.accessoryColor}` : '';
  }

  function applyStageTheme(){
    const stage = document.querySelector('.stage');
    if(!stage) return;
    stage.classList.remove('theme-aurora','theme-night','theme-sunset','theme-mint');
    stage.classList.add('theme-' + String(sceneState?.stageTheme || 'aurora'));
  }

  function renderSceneChips(){
    const rm = document.getElementById('robotMotionChips');
    const cm = document.getElementById('companionMotionChips');
    if(!rm || !cm) return;
    rm.innerHTML = ROBOT_MOTION_OPTS.map(o => `
      <button type="button" data-rmotion="${o.id}" class="scene-chip ${sceneState.robotMotion===o.id?'active':''}">
        <i class="fa-solid ${o.icon} mr-1"></i>${o.label}
      </button>
    `).join('');
    cm.innerHTML = COMP_MOTION_OPTS.map(o => `
      <button type="button" data-cmotion="${o.id}" class="scene-chip ${sceneState.companionMotion===o.id?'active':''}">
        <i class="fa-solid ${o.icon} mr-1"></i>${o.label}
      </button>
    `).join('');
  }

  function bindSceneControls(){
    if(stageModeBound) return;
    stageModeBound = true;

    document.getElementById('robotMotionChips')?.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-rmotion]');
      if(!b) return;
      sceneState.robotMotion = String(b.getAttribute('data-rmotion') || 'float');
      renderSceneChips();
      paint();
    });
    document.getElementById('companionMotionChips')?.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-cmotion]');
      if(!b) return;
      sceneState.companionMotion = String(b.getAttribute('data-cmotion') || 'hop');
      renderSceneChips();
      paint();
    });

    document.getElementById('sceneThemeSel')?.addEventListener('change', (e)=>{
      sceneState.stageTheme = String(e.target.value || 'aurora');
      paint();
    });
    document.getElementById('sceneFxSel')?.addEventListener('change', (e)=>{
      sceneState.robotFx = String(e.target.value || 'auto');
      paint();
    });
    document.getElementById('sceneSaveBtn')?.addEventListener('click', ()=> saveSceneState());
    document.getElementById('sceneResetBtn')?.addEventListener('click', ()=>{
      sceneState = normalizeScene({});
      paint();
      toast('Sahna default holatga qaytdi', 'success');
    });
  }

  function renderTrialBanner(){
    const box = document.getElementById('trialBanner');
    if(!box) return;
    if(!isOwner || !trialState){
      box.classList.add('hidden');
      box.innerHTML = '';
      return;
    }
    const alreadyOwnedRobot = trialState.kind === 'robot' && (me?.robots||[]).some(r => String(r.typeId||'') === String(trialState.id||''));
    const alreadyOwnedComp = trialState.kind === 'companion' && (me?.companions||[]).some(c => String(c.typeId||'') === String(trialState.id||''));
    const owned = alreadyOwnedRobot || alreadyOwnedComp;
    const title = trialState.kind === 'robot' ? 'Robot trial rejimi' : 'Hayvoncha trial rejimi';
    const subtitle = `${trialState.name || trialState.id} • ${trialState.price || 0} coin`;

    box.classList.remove('hidden');
    box.innerHTML = `
      <div class="glass rounded-2xl p-3 border border-emerald-300/35">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div>
            <div class="text-sm font-black">${escapeHtml(title)}</div>
            <div class="text-xs muted2">${escapeHtml(subtitle)}</div>
          </div>
          <div class="flex items-center gap-2">
            ${owned ? `<span class="scene-chip active">Sizda bor</span>` : `<button id="trialBuyBtn" class="glass rounded-xl px-3 py-2 text-xs font-extrabold btn-primary text-white glow-ring"><i class="fa-solid fa-bag-shopping mr-1"></i>Hozir sotib olish</button>`}
            <button id="trialClearBtn" class="glass rounded-xl px-3 py-2 text-xs font-extrabold btn-ghost glow-ring"><i class="fa-solid fa-xmark mr-1"></i>Yopish</button>
          </div>
        </div>
      </div>
    `;
    const clearBtn = document.getElementById('trialClearBtn');
    if(clearBtn) clearBtn.onclick = ()=>{ clearTrialState(); paint(); };
    const buyBtn = document.getElementById('trialBuyBtn');
    if(buyBtn){
      buyBtn.onclick = async ()=>{
        try{
          if(trialState.kind === 'robot'){
            await apiJson('/api/robots/buy', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotTypeId: trialState.id }) });
            toast('Robot sotib olindi', 'success');
          } else if (trialState.kind === 'companion'){
            await apiJson('/api/shop/buy', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ itemId: trialState.id }) });
            toast('Hayvoncha sotib olindi', 'success');
          }
          clearTrialState();
          await refreshSelfAndRepaint();
        }catch(e){
          toast(e.message || 'Xarid muvaffaqiyatsiz', 'error');
        }
      };
    }
  }

  function renderRobotsGrid(u){
    const grid = document.getElementById('robotsGrid');
    const robots = u.robots || [];
    const activeId = u.activeRobotId || u.activeRobot?._id || '';
    if(robots.length === 0){
      grid.innerHTML = `<div class="glass rounded-2xl p-5 muted">Robot topilmadi.</div>`;
      return;
    }
    grid.innerHTML = robots.map(r => {
      const active = String(r._id) === String(activeId) || !!r.equipped;
      const priceTag = isOwner ? '' : '';
      const btn = isOwner ? `<button data-equip="${r._id}" class="equipBtn glass rounded-2xl px-4 py-2 text-sm font-extrabold ${active?'chip active':'btn-ghost'} glow-ring">${active?'Tanlangan':'Asosiy qilish'}</button>` : '';
      return `
        <div class="glass rounded-3xl p-5 border border-white/10 dark:border-slate-700/25">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black">${escapeHtml(r.name || 'Robotcha')}</div>
              <div class="text-xs muted2 mt-1">Turi: <span class="font-extrabold">${escapeHtml(r.typeId||'starter')}</span> • Daraja: <span class="font-extrabold">${r.level||1}</span></div>
              <div class="text-xs muted2 mt-1">Yoqimtoylik: <span class="font-extrabold">${r.cuteness||50}</span>/100</div>
            </div>
            <span class="chip rounded-2xl px-3 py-1 text-xs font-extrabold ${active?'active':''}">${active?'ACTIVE':'—'}</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${btn}
            ${isOwner ? `<button data-play="${r._id}" class="playBtn glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring"><i class="fa-solid fa-face-laugh-beam mr-2"></i>O‘ynatish</button>` : ''}
          </div>
        </div>
      `;
    }).join('');

    // bind
    grid.querySelectorAll('.equipBtn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const rid = b.getAttribute('data-equip');
        try{
          await apiJson('/api/robots/equip', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotId: rid }) });
          await refreshSelfAndRepaint();
          toast('Asosiy robotcha yangilandi', 'success');
        }catch(e){ toast(e.message, 'error'); }
      });
    });
    grid.querySelectorAll('.playBtn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const rid = b.getAttribute('data-play');
        try{
          await apiJson('/api/robots/play', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotId: rid }) });
          sparkle();
          toast('Robotcha o‘ynadi!', 'success');
        }catch(e){ toast(e.message, 'error'); }
      });
    });
  }

  function renderCompanionsGrid(u){
    const grid = document.getElementById('companionsGrid');
    const comps = u.companions || [];
    const activeCid = u.activeCompanionId || u.activeCompanion?._id || '';
    if(comps.length === 0){
      grid.innerHTML = `<div class="glass rounded-2xl p-5 muted">Hozircha hayvoncha yo‘q. <a class="underline font-extrabold" href="/petmarket.html">Pet Market</a> ga kiring.</div>`;
      return;
    }
    grid.innerHTML = comps.map(c=>{
      const active = String(c._id) === String(activeCid) || !!c.equipped;
      const btn = isOwner ? `<button data-cequip="${c._id}" class="cEquip glass rounded-2xl px-4 py-2 text-sm font-extrabold ${active?'chip active':'btn-ghost'} glow-ring">${active?'Tanlangan':'Hamroh qilish'}</button>` : '';
      return `
        <div class="glass rounded-3xl p-5 border border-white/10 dark:border-slate-700/25">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-2xl glass grid place-items-center text-2xl">${escapeHtml(c.emoji||'🐾')}</div>
              <div>
                <div class="font-black">${escapeHtml(c.name||'Hamroh')}</div>
                <div class="text-xs muted2 mt-0.5">Rarity: <span class="font-extrabold">${escapeHtml(c.rarity||'common')}</span> • Mood +${c.moodBoost||0}</div>
              </div>
            </div>
            <span class="chip rounded-2xl px-3 py-1 text-xs font-extrabold ${active?'active':''}">${active?'ACTIVE':'—'}</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${btn}
            <button class="petPlay glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring" data-petplay="${c.typeId||''}">
              <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>O‘ynash
            </button>
          </div>
        </div>
      `;
    }).join('');

    grid.querySelectorAll('.cEquip').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const cid = b.getAttribute('data-cequip');
        try{
          await apiJson('/api/companions/equip', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ companionId: cid }) });
          await refreshSelfAndRepaint();
          toast('Hamroh yangilandi', 'success');
        }catch(e){ toast(e.message, 'error'); }
      });
    });
    grid.querySelectorAll('.petPlay').forEach(b=>{
      b.addEventListener('click', ()=>{
        const typeId = b.getAttribute('data-petplay') || '';
        // local-only micro animation
        const bubble = document.getElementById('companionBubble');
        bubble.classList.add('motion-pulse');
        setTimeout(()=>{
          bubble.classList.remove('motion-pulse');
          bubble.classList.add('motion-' + String(sceneState?.companionMotion || 'hop'));
        }, 900);
        toast('Hamroh xursand bo‘ldi!', 'success');
      });
    });
  }

  function sparkle(){
    // lightweight stage sparkle
    const stage = document.querySelector('.stage');
    const s = document.createElement('div');
    s.style.position='absolute';
    s.style.inset='0';
    s.style.pointerEvents='none';
    s.style.background='radial-gradient(8px 8px at 20% 30%, rgba(255,255,255,.55), transparent 60%), radial-gradient(8px 8px at 65% 40%, rgba(255,255,255,.45), transparent 60%), radial-gradient(10px 10px at 40% 75%, rgba(255,255,255,.50), transparent 60%)';
    s.style.opacity='0';
    s.style.transition='opacity .25s ease';
    stage.appendChild(s);
    requestAnimationFrame(()=>{ s.style.opacity='1'; });
    setTimeout(()=>{ s.style.opacity='0'; setTimeout(()=>s.remove(), 250); }, 650);
  }

  function setStudioValues(activeRobot, activeCompanion){
    if(!isOwner) return;
    document.getElementById('studioRobotName').value = activeRobot?.name || '';
    document.getElementById('studioRobotColor').value = activeRobot?.baseColor || '#6366f1';
    document.getElementById('studioRobotOutfit').value = activeRobot?.outfitColor || '#ec4899';
    document.getElementById('studioCompanionName').value = activeCompanion?.name || '';
    document.getElementById('studioCompanionColor').value = activeCompanion?.color || '#14b8a6';
    document.getElementById('studioCompanionAccessory').value = activeCompanion?.accessoryColor || '#f59e0b';
  }

  async function saveStudioData(activeRobot, activeCompanion){
    if(!isOwner) return;
    try{
      if(activeRobot?._id){
        await apiJson('/api/robots/customize', {
          method:'POST',
          headers: authHeaders(true),
          body: JSON.stringify({
            robotId: activeRobot._id,
            name: document.getElementById('studioRobotName').value.trim(),
            baseColor: document.getElementById('studioRobotColor').value,
            outfitColor: document.getElementById('studioRobotOutfit').value
          })
        });
      }
      if(activeCompanion?._id){
        await apiJson('/api/companions/customize', {
          method:'POST',
          headers: authHeaders(true),
          body: JSON.stringify({
            companionId: activeCompanion._id,
            name: document.getElementById('studioCompanionName').value.trim(),
            color: document.getElementById('studioCompanionColor').value,
            accessoryColor: document.getElementById('studioCompanionAccessory').value
          })
        });
      }
      toast('Robot Studio saqlandi', 'success');
      await refreshSelfAndRepaint();
    }catch(e){
      toast(e.message || 'Studio saqlanmadi', 'error');
    }
  }

  async function refreshSelfAndRepaint(){
    await loadMe();
    // if viewing self, keep it in sync
    if(isOwner) viewed = me;
    if(isOwner) await loadSceneState();
    paint();
  }

  function getCurrentActiveRobot(){
    const robots = viewed?.robots || [];
    return viewed?.activeRobot || robots.find(r => String(r._id) === String(viewed?.activeRobotId)) || robots.find(r=>r.equipped) || robots[0] || null;
  }
  function getCurrentActiveCompanion(){
    const comps = viewed?.companions || [];
    return viewed?.activeCompanion || comps.find(c => String(c._id)===String(viewed?.activeCompanionId)) || comps.find(c=>c.equipped) || comps[0] || null;
  }

  function paint(){
    setProfileUI(viewed);
    applyStageTheme();

    const ownedRobots = viewed.robots || [];
    const ownedCompanions = viewed.companions || [];
    const activeRobot = getCurrentActiveRobot();
    const activeCompanion = getCurrentActiveCompanion();

    let stageRobot = activeRobot;
    let stageCompanion = activeCompanion;

    if(isOwner && trialState){
      if(trialState.kind === 'robot'){
        const owned = ownedRobots.some(r => String(r.typeId||'') === String(trialState.id||''));
        if(!owned){
          const it = (catalog || []).find(x => String(x.id||'') === String(trialState.id||''));
          if(it){
            stageRobot = {
              _id: `trial_${it.id}`,
              typeId: it.id,
              name: it.name || trialState.name || 'Trial Robot',
              baseColor: '#6366f1',
              outfitColor: '#ec4899',
              level: 1,
              cuteness: it.baseCuteness || 60
            };
          }
        }
      } else if (trialState.kind === 'companion'){
        const owned = ownedCompanions.some(c => String(c.typeId||'') === String(trialState.id||''));
        if(!owned){
          stageCompanion = {
            _id: `trial_${trialState.id}`,
            typeId: trialState.id,
            name: trialState.name || 'Trial Companion',
            emoji: trialState.emoji || '🐾',
            rarity: trialState.rarity || 'trial',
            moodBoost: trialState.moodBoost || 0
          };
        }
      }
    }

    const wrap = document.getElementById('robotWrap');
    if(stageRobot){
      applyRobot(wrap, stageRobot);
      document.getElementById('level').textContent = stageRobot.level || 1;
      document.getElementById('cuteness').textContent = stageRobot.cuteness || 50;
      document.getElementById('robotSub').textContent = `${stageRobot.name || 'Robotcha'} — tur: ${stageRobot.typeId || 'starter'}`;
    } else {
      wrap.innerHTML = '';
    }

    applyCompanion(document.getElementById('companionBubble'), stageCompanion);

    renderRobotsGrid(viewed);
    renderCompanionsGrid(viewed);
    renderTrialBanner();

    const sceneBox = document.getElementById('sceneControls');
    const studioBox = document.getElementById('robotStudioCard');
    sceneBox.classList.toggle('hidden', !isOwner);
    studioBox.classList.toggle('hidden', !isOwner);
    if(isOwner){
      const themeSel = document.getElementById('sceneThemeSel');
      const fxSel = document.getElementById('sceneFxSel');
      if(themeSel) themeSel.value = sceneState.stageTheme || 'aurora';
      if(fxSel) fxSel.value = sceneState.robotFx || 'auto';
      renderSceneChips();
      bindSceneControls();
      setStudioValues(activeRobot, activeCompanion);

      if(!studioBound){
        studioBound = true;
        document.getElementById('studioApplyBtn')?.addEventListener('click', ()=>{
          const curRobot = getCurrentActiveRobot();
          const rn = document.getElementById('studioRobotName').value.trim();
          const rc = document.getElementById('studioRobotColor').value;
          const ro = document.getElementById('studioRobotOutfit').value;
          if(curRobot){
            applyRobot(document.getElementById('robotWrap'), {
              ...curRobot,
              name: rn || curRobot.name,
              baseColor: rc || curRobot.baseColor,
              outfitColor: ro || curRobot.outfitColor
            });
          }
          sparkle();
          toast('Preview yangilandi', 'success');
        });
        document.getElementById('studioSaveBtn')?.addEventListener('click', ()=> saveStudioData(getCurrentActiveRobot(), getCurrentActiveCompanion()));
      }
    }

    // Special buttons
    const playBtn = document.getElementById('playBtn');
    playBtn.classList.toggle('hidden', !isOwner);
    playBtn.onclick = async ()=>{
      try{
        if(!activeRobot?._id) return;
        await apiJson('/api/robots/play', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotId: activeRobot._id }) });
        sparkle();
        toast('Robotcha o‘ynadi!', 'success');
      }catch(e){ toast(e.message,'error'); }
    };

    const gBtn = document.getElementById('toggleGlassesBtn');
    const isShade = (activeRobot?.typeId === 'shade');
    gBtn.classList.toggle('hidden', !(isShade && (isOwner || true)));
    gBtn.onclick = ()=>{
      glassesOff = !glassesOff;
      paint();
    };
  }

  async function loadRobotCatalog(){
    try{
      const j = await apiJson('/api/robots/catalog', { headers: authHeaders(false) });
      catalog = j.catalog || [];
      upgrades = j.upgrades || {};
    }catch(e){
      // ignore for public viewing
    }
  }

  function openRobotShop(){
    // Simple inline shop: replace robotsGrid header portion with catalog cards temporarily
    const grid = document.getElementById('robotsGrid');
    const cards = (catalog||[]).map(it=>{
      const owned = (me?.robots||[]).some(r => r.typeId === it.id);
      const disabled = owned || (me?.coins||0) < (it.price||0);
      return `
        <div class="glass rounded-3xl p-5 border border-white/10 dark:border-slate-700/25">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black">${escapeHtml(it.name)}</div>
              <div class="text-xs muted2 mt-1">${escapeHtml(it.desc||'')}</div>
              <div class="text-xs muted2 mt-2">Rarity: <span class="font-extrabold">${escapeHtml(it.rarity||'common')}</span> • Yoqimtoylik: <span class="font-extrabold">${it.baseCuteness||50}</span></div>
            </div>
            <span class="chip rounded-2xl px-3 py-1 text-xs font-extrabold">${it.price||0} coin</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button data-buyrobot="${it.id}" class="buyRobot glass rounded-2xl px-4 py-2 text-sm font-extrabold ${disabled?'chip':'btn-primary text-white'} glow-ring" ${disabled?'disabled':''}>
              ${owned ? 'Sizda bor' : ((me?.coins||0) < (it.price||0) ? 'Coin yetarli emas' : 'Sotib olish')}
            </button>
          </div>
        </div>
      `;
    }).join('');
    grid.innerHTML = cards + `<div class="md:col-span-2"><button id="closeShop" class="glass rounded-2xl px-5 py-3 text-sm font-extrabold btn-ghost glow-ring w-full"><i class="fa-solid fa-arrow-left mr-2"></i>Kolleksiyaga qaytish</button></div>`;

    grid.querySelectorAll('.buyRobot').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-buyrobot');
        try{
          await apiJson('/api/robots/buy', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ typeId: id }) });
          await refreshSelfAndRepaint();
          toast('Robot sotib olindi!', 'success');
          openRobotShop(); // refresh view
        }catch(e){ toast(e.message,'error'); }
      });
    });
    const close = document.getElementById('closeShop');
    close.onclick = ()=> paint();
  }

  // Public poke interaction (local effect)
  document.getElementById('pokeBtn').addEventListener('click', ()=>{
    sparkle();
    toast('Salom! Robotcha sizni sezdi.', 'success');
  });

  async function init(){
    try{
      await loadMe();
      await loadRobotCatalog();
      await loadViewed();

      isOwner = (viewed?._id && me?._id && String(viewed._id) === String(me._id));
      loadTrialState();
      await loadSceneState();
      // owner tools
      document.getElementById('openShopBtn').classList.toggle('hidden', !isOwner);
      document.getElementById('openShopBtn').onclick = openRobotShop;

      // load accurate coin for owner
      if(isOwner){
        document.getElementById('ownerTools').classList.remove('hidden');
      }

      paint();
    } catch (e){
      console.error(e);
      if(String(e?.message||'').toLowerCase().includes('authentication')) goLogin();
      toast(e.message || 'Profilni yuklab bo‘lmadi', 'error');
    }
  }


  // ===== Profile editing =====
  function openEdit(){
    const u = viewed || {};
    const currentStudyType = (u.studyType || '').trim();
    const currentStudyGroup = (u.studyGroup || u.group || '').trim();
    document.getElementById('editFullName').value = u.fullName || u.fullname || '';
    document.getElementById('editNick').value = u.nickname || '';
    document.getElementById('editBio').value = u.bio || '';
    document.getElementById('editGroup').innerHTML = '<option value="">— Tanlang —</option>';

    // load catalog and select current values
    loadUniversities(u.university || '').then(async () => {
      document.getElementById('editUniversity').value = u.university || '';
      await loadFaculties(u.university || '', u.faculty || '', currentStudyType, currentStudyGroup);
    }).catch(()=>{});

    const msg = document.getElementById('editMsg');
    msg.classList.add('hidden');
    msg.textContent = '';
    document.getElementById('editModal').classList.remove('hidden');
  }
  function closeEdit(){
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editAvatarFile').value = '';
    document.getElementById('editCoverFile').value = '';
  }

  async function loadUniversities(selected){
    const sel = document.getElementById('editUniversity');
    sel.innerHTML = '<option value="">— Tanlang —</option>';
    try{
      const r = await fetch('/api/catalog/universities');
      const j = await r.json();
      (j.universities||[]).forEach(u=>{
        const opt = document.createElement('option');
        opt.value = u.name;
        opt.textContent = u.name;
        if (selected && u.name === selected) opt.selected = true;
        sel.appendChild(opt);
      });
    }catch(e){
      // fallback: keep current text
    }
    sel.onchange = () => loadFaculties(sel.value, '', '', '');
  }

  async function loadFaculties(university, selectedFaculty, selectedStudyType, selectedStudyGroup){
    const facultySel = document.getElementById('editFaculty');
    facultySel.innerHTML = '<option value="">— Tanlang —</option>';
    await loadStudyTypes('', '', '', '');
    if(!university) return;
    try{
      const r = await fetch('/api/catalog/faculties?university='+encodeURIComponent(university));
      const j = await r.json();
      (j.faculties||[]).forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (selectedFaculty && name === selectedFaculty) opt.selected = true;
        facultySel.appendChild(opt);
      });
      if (selectedFaculty) facultySel.value = selectedFaculty;
    }catch(e){}
    facultySel.onchange = () => loadStudyTypes(university, facultySel.value, '', '');
    await loadStudyTypes(university, facultySel.value, selectedStudyType || '', selectedStudyGroup || '');
  }

  async function loadStudyTypes(university, faculty, selectedStudyType, selectedStudyGroup){
    const typeSel = document.getElementById('editStudyType');
    typeSel.innerHTML = '<option value="">— Tanlang —</option>';
    await loadStudyGroups('', '', '', '');
    if(!university || !faculty){
      typeSel.disabled = true;
      return;
    }
    try{
      const r = await fetch('/api/catalog/study-types?university='+encodeURIComponent(university)+'&faculty='+encodeURIComponent(faculty));
      const j = await r.json();
      const list = Array.isArray(j.studyTypes) ? j.studyTypes : [];
      list.forEach(item=>{
        const name = String(item?.name || '').trim();
        if(!name) return;
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if(selectedStudyType && name === selectedStudyType) opt.selected = true;
        typeSel.appendChild(opt);
      });
      if(selectedStudyType) typeSel.value = selectedStudyType;
      typeSel.disabled = list.length === 0;
    }catch(e){
      typeSel.disabled = true;
    }
    typeSel.onchange = () => loadStudyGroups(university, faculty, typeSel.value, '');
    await loadStudyGroups(university, faculty, typeSel.value, selectedStudyGroup || '');
  }

  async function loadStudyGroups(university, faculty, studyType, selectedStudyGroup){
    const groupSel = document.getElementById('editGroup');
    groupSel.innerHTML = '<option value="">— Tanlang —</option>';
    if(!university || !faculty || !studyType){
      groupSel.disabled = true;
      return;
    }
    try{
      const r = await fetch('/api/catalog/study-groups?university='+encodeURIComponent(university)+'&faculty='+encodeURIComponent(faculty)+'&studyType='+encodeURIComponent(studyType));
      const j = await r.json();
      const list = Array.isArray(j.studyGroups) ? j.studyGroups : [];
      list.forEach(item=>{
        const name = String(item?.name || '').trim();
        if(!name) return;
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if(selectedStudyGroup && name === selectedStudyGroup) opt.selected = true;
        groupSel.appendChild(opt);
      });
      if(selectedStudyGroup) groupSel.value = selectedStudyGroup;
      groupSel.disabled = list.length === 0;
    }catch(e){
      groupSel.disabled = true;
    }
  }

  function showEditMsg(text, type){
    const el = document.getElementById('editMsg');
    el.classList.remove('hidden');
    el.textContent = text;
  }

  async function saveProfile(){
    try{
      const token = getToken();
      if(!token) return goLogin();

      const fullName = document.getElementById('editFullName').value.trim();
      const nickname = document.getElementById('editNick').value.trim();
      const bio = document.getElementById('editBio').value.trim();
      const university = document.getElementById('editUniversity').value.trim();
      const faculty = document.getElementById('editFaculty').value.trim();
      const studyType = document.getElementById('editStudyType').value.trim();
      const studyGroup = document.getElementById('editGroup').value.trim();

      if(!university){
        showEditMsg('Universitetni tanlang.');
        return;
      }
      if(!faculty){
        showEditMsg('Fakultetni tanlang.');
        return;
      }
      if(!studyType){
        showEditMsg('O‘quv turini tanlang.');
        return;
      }
      if(!studyGroup){
        showEditMsg('O‘quv guruhini tanlang.');
        return;
      }

      // 1) Upload avatar / cover first if chosen
      const av = document.getElementById('editAvatarFile').files[0];
      if(av) await uploadAvatar(av, token);

      const cv = document.getElementById('editCoverFile').files[0];
      if(cv) await uploadCover(cv, token);

      // 2) Save text fields
      const r = await fetch('/api/profile', {
        method:'PUT',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
        body: JSON.stringify({ fullName, nickname, bio, university, faculty, studyType, studyGroup })
      });

      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(j.error || 'Saqlab bo‘lmadi');

      toast('Profil yangilandi', 'success');
      closeEdit();
      await init(); // reload
    }catch(e){
      console.error(e);
      showEditMsg(e.message || 'Xatolik');
      toast(e.message || 'Xatolik', 'error');
    }
  }

  async function uploadAvatar(file, token){
    const fd = new FormData();
    fd.append('avatar', file);
    const r = await fetch('/api/upload-avatar', { method:'POST', headers:{ 'Authorization':'Bearer '+token }, body: fd });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(j.error || 'Avatar yuklanmadi');
    return j.avatar;
  }
  async function uploadCover(file, token){
    const fd = new FormData();
    fd.append('cover', file);
    const r = await fetch('/api/upload-cover', { method:'POST', headers:{ 'Authorization':'Bearer '+token }, body: fd });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(j.error || 'Cover yuklanmadi');
    return j.coverBanner;
  }

  init();
</script>

  <!-- Edit profile modal -->
  <div id="editModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50" onclick="closeEdit()"></div>
    <div class="absolute inset-0 flex items-end md:items-center justify-center p-4">
      <div class="w-full max-w-xl glass rounded-3xl p-5 md:p-6">
        <div class="flex items-center justify-between">
          <div class="text-lg font-black">Profilni tahrirlash</div>
          <button class="p-2 rounded-xl hover:bg-white/10" onclick="closeEdit()"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="block">
            <div class="text-xs muted2 font-extrabold mb-1">Ism familiya</div>
            <input id="editFullName" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none" placeholder="Ism Familiya"/>
          </label>
          <label class="block">
            <div class="text-xs muted2 font-extrabold mb-1">Nick</div>
            <input id="editNick" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none" placeholder="Nick"/>
          </label>
          <label class="block md:col-span-2">
            <div class="text-xs muted2 font-extrabold mb-1">Bio</div>
            <textarea id="editBio" rows="3" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none" placeholder="O‘zingiz haqingizda"></textarea>
          </label>

          <label class="block">
            <div class="text-xs muted2 font-extrabold mb-1">Universitet</div>
            <select id="editUniversity" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none"></select>
          </label>
          <label class="block">
            <div class="text-xs muted2 font-extrabold mb-1">Fakultet</div>
            <select id="editFaculty" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none"></select>
          </label>
          <label class="block">
            <div class="text-xs muted2 font-extrabold mb-1">O‘quv turi</div>
            <select id="editStudyType" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none"></select>
          </label>

          <label class="block md:col-span-2">
            <div class="text-xs muted2 font-extrabold mb-1">Guruh (yo‘nalish)</div>
            <select id="editGroup" class="w-full glass rounded-2xl px-4 py-3 text-sm outline-none">
              <option value="">— Tanlang —</option>
            </select>
          </label>

          <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Avatar (rasm)</div>
              <input id="editAvatarFile" type="file" accept="image/*" class="w-full"/>
            </label>
            <label class="block">
              <div class="text-xs muted2 font-extrabold mb-1">Cover (banner)</div>
              <input id="editCoverFile" type="file" accept="image/*" class="w-full"/>
            </label>
          </div>
        </div>

        <div id="editMsg" class="mt-3 text-sm muted hidden"></div>

        <div class="mt-5 flex items-center justify-end gap-2">
          <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost" onclick="closeEdit()">Bekor qilish</button>
          <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary text-white glow-ring" onclick="saveProfile()">Saqlash</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/ui-actions-menu.js" defer></script>
</body>
</html>

