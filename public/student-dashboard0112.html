<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard ‚Äî QDTU LMS</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --primary:#2563eb; --primary2:#7c3aed; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --shadow: 0 18px 50px rgba(2,6,23,.10);
      --ring: 0 0 0 4px rgba(37,99,235,.18);
      --grid: rgba(15,23,42,.06);
    }
    .dark{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#223047;
      --shadow: 0 20px 70px rgba(0,0,0,.45);
      --grid: rgba(148,163,184,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    a{color:inherit}
    .bg{
      position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(1100px 500px at 10% 10%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(900px 500px at 92% 18%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 600px at 50% 92%, rgba(16,185,129,.14), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
    }
    .gridbg{
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background-image: linear-gradient(to right, var(--grid) 1px, transparent 1px),
                        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 72px 72px;
      mask-image: radial-gradient(closest-side at 50% 35%, black 0%, transparent 72%);
      opacity:.85;
    }

    header{
      position:sticky; top:0; z-index:50;
      padding:14px 16px;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 72%, transparent);
      border-bottom:1px solid color-mix(in oklab, var(--border) 70%, transparent);
    }
    .nav{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: var(--shadow);
    }
    .pills{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{font-size:12px; padding:7px 10px; border-radius:999px; border:1px solid color-mix(in oklab, var(--border) 80%, transparent); background: color-mix(in oklab, var(--card) 85%, transparent)}
    .badge{font-weight:900; letter-spacing:.6px}
    .badge.student{color:var(--ok)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text);
      padding:10px 12px; border-radius:12px; text-decoration:none; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      transition: transform .08s ease, filter .12s ease, background .12s ease;
      user-select:none;
      font-weight:650;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, var(--primary), var(--primary2)); color:#fff; border-color:transparent}
    .btn.danger{background: linear-gradient(135deg, #ef4444, #fb7185); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px; border-radius:11px; font-size:13px; font-weight:800}

    .container{max-width:1200px;margin:18px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{
      background: color-mix(in oklab, var(--card) 96%, transparent);
      border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
      border-radius:16px; padding:16px;
      box-shadow: 0 8px 28px rgba(2,6,23,.06);
    }
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    @media (max-width:980px){ .col-8,.col-4,.col-6{grid-column:span 12} }

    .muted{color:var(--muted);font-size:13px;line-height:1.55}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .divider{height:1px;background:color-mix(in oklab, var(--border) 85%, transparent); margin:12px 0}
    .tiny{font-size:12px;color:var(--muted)}
    footer{padding:18px 16px;color:var(--muted);text-align:center}

    .err{
      border-radius:14px; padding:12px 14px; margin:14px 0; display:none;
      border:1px solid #fed7aa; background: color-mix(in oklab, #ffedd5 65%, var(--card)); color:#9a3412;
    }

    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .kpi .box{flex:1; min-width:190px; padding:12px; border-radius:16px; border:1px dashed color-mix(in oklab, var(--border) 85%, transparent); background: color-mix(in oklab, var(--card) 92%, transparent)}
    .kpi .val{font-size:20px; font-weight:950; margin-top:4px}
    .kpi .label{font-size:12px;color:var(--muted)}

    .courseItem{
      border:1px solid color-mix(in oklab, var(--border) 85%, transparent);
      border-radius:16px;
      background: color-mix(in oklab, var(--card) 96%, transparent);
      padding:12px;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      transition: transform .08s ease, filter .12s ease;
    }
    .courseItem:hover{filter:brightness(1.01)}
    .courseItem:active{transform:translateY(1px)}
    .courseItem .title{font-weight:950}
    .courseItem .meta{margin-top:4px}
    .progressRow{margin-top:10px}
    .bar{height:12px;border-radius:999px;background:color-mix(in oklab, var(--border) 85%, transparent); overflow:hidden}
    .bar > div{height:100%; width:0%; background: linear-gradient(135deg, var(--primary), var(--primary2)); transition: width .25s ease}
    .tag{display:inline-flex; gap:8px; align-items:center; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid color-mix(in oklab, var(--border) 85%, transparent); background: color-mix(in oklab, var(--card) 92%, transparent); font-weight:900}
    .tag.free{border-color:#86efac; background: color-mix(in oklab, #dcfce7 35%, var(--card))}
    .tag.paid{border-color:#93c5fd; background: color-mix(in oklab, #dbeafe 35%, var(--card))}
    code{background:color-mix(in oklab, var(--card) 92%, transparent);border:1px solid color-mix(in oklab, var(--border) 85%, transparent);border-radius:10px;padding:2px 7px}
  </style>
  <script>
    (function(){
      const key="theme";
      const saved=localStorage.getItem(key);
      const prefersDark=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode=saved || (prefersDark ? "dark" : "light");
      if(mode==="dark") document.documentElement.classList.add("dark");
    })();
  </script>
</head>
<body>
  <div class="bg"></div><div class="gridbg"></div>

  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="pills">
          <span class="pill badge student"><a href="/index.html" class="flex items-center gap-3">STUDENT</a></span>
          <span id="mePill" class="pill" style="display:none"></span>
        </div>
      </div>
      <div class="row">
        <button class="btn ghost small" id="themeBtn">üåì Tema</button>
        <a class="btn ghost small" href="/courses.html">Kurslar</a>
        <a class="btn ghost small" href="/tests.html">Testlar</a>
        <a class="btn ghost small" href="/certificate.html">Sertifikat</a>
        <a class="btn ghost small" href="/profile.html">Profil</a>
        <button class="btn danger small" id="logoutBtn">Chiqish</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="errBox" class="err"></div>

    <div class="grid">
      <div class="card col-12">
        <h2 style="margin:0 0 6px 0;font-size:20px">Student boshqaruv paneli</h2>
        <div class="muted">
          Bu panel ‚ÄúNext action‚Äù falsafasi bilan ishlaydi: kurslar ‚Üí darslar ‚Üí test ‚Üí sertifikat.
        </div>
      </div>

      <div class="card col-8">
        <h3 style="margin:0 0 10px 0">Hisob va KPI</h3>
        <div class="kpi">
          <div class="box">
            <div class="label">Ism</div>
            <div class="val" id="nameVal">‚Äî</div>
          </div>
          <div class="box">
            <div class="label">Fakultet</div>
            <div class="val" style="font-size:14px" id="facultyVal">‚Äî</div>
          </div>
          <div class="box">
            <div class="label">Guruh</div>
            <div class="val" style="font-size:14px" id="groupVal">‚Äî</div>
          </div>
          <div class="box">
            <div class="label">Coin balans</div>
            <div class="val" id="coinsVal">‚Äî</div>
          </div>
          <div class="box">
            <div class="label">Qo‚Äòshilgan kurslar</div>
            <div class="val" id="joinedCount">0</div>
          </div>
          <div class="box">
            <div class="label">Tugallangan kurslar</div>
            <div class="val" id="doneCount">0</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <a class="btn primary" href="/courses.html">+ Kurs tanlash</a>
          <a class="btn" href="/tests.html">Test ishlash</a>
          <a class="btn" href="/certificate.html">Sertifikat</a>
          <button class="btn" id="refreshBtn">Yangilash</button>
        </div>

        <div class="tiny" style="margin-top:10px">
          API bo‚Äòlsa: <code>/api/me</code>, <code>/api/progress</code>, <code>/api/courses</code> dan real ma‚Äôlumotlar chiqadi.
          Aks holda localStorage demo ishlaydi.
        </div>
      </div>

      <div class="card col-4">
        <h3 style="margin:0 0 10px 0">Next action</h3>
        <div class="muted" id="nextActionTxt">‚Äî</div>
        <div class="divider"></div>
        <div class="row">
          <a class="btn primary" id="continueBtn" href="/courses.html">Davom ettirish</a>
          <a class="btn" id="openCourseBtn" href="/courses.html">Kurs ochish</a>
        </div>
        <div class="tiny" style="margin-top:10px">
          Davom ettirish: oxirgi ochilgan dars (lastLessonId) bo‚Äòyicha avtomatik.
        </div>
      </div>

      <div class="card col-12">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h3 style="margin:0">Mening kurslarim</h3>
            <div class="muted">Qo‚Äòshilgan kurslar, progress, ‚ÄúDavom ettirish‚Äù.</div>
          </div>
          <div class="row">
            <span class="tiny" id="modeTxt">‚Äî</span>
          </div>
        </div>

        <div id="myCourses" style="margin-top:12px; display:flex; flex-direction:column; gap:10px">
          <div class="muted">Yuklanmoqda...</div>
        </div>
      </div>
    </div>
  </div>

  <footer>QDTU LMS ‚Äî Student Dashboard</footer>

<script>
  const API_BASE = "";
  const $ = (id)=> document.getElementById(id);
  function getToken(){ return localStorage.getItem("token") || ""; }

  function setErr(msg){ $("errBox").textContent = msg; $("errBox").style.display="block"; }
  function clearErr(){ $("errBox").style.display="none"; }

  async function apiFetch(url, opts={}){
    const token = getToken();
    const headers = Object.assign({}, opts.headers || {});
    if(token) headers["Authorization"] = "Bearer " + token;
    const res = await fetch(API_BASE + url, Object.assign({}, opts, { headers }));
    let data = null;
    const ct = res.headers.get("content-type") || "";
    if(ct.includes("application/json")){
      try{ data = await res.json(); }catch{ data = null; }
    }else{
      try{ data = await res.text(); }catch{ data = null; }
    }
    if(!res.ok){
      const msg = (data && data.error) ? data.error : ("So'rov xatosi: " + res.status);
      const err = new Error(msg);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  $("themeBtn").addEventListener("click", ()=>{
    document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", document.documentElement.classList.contains("dark") ? "dark" : "light");
  });

  $("logoutBtn").addEventListener("click", ()=>{
    localStorage.removeItem("token");
    location.href="/login.html";
  });

  // DEMO storage shared with other pages
  function demoCoursesKey(){ return "demoCourses_v2"; }
  function readDemoCourses(){ try{ return JSON.parse(localStorage.getItem(demoCoursesKey()) || "[]"); }catch{ return []; } }
  function joinedKey(uid){ return "joinedCourses_v1_" + (uid || "anon"); }
  function readJoined(uid){ try{ return JSON.parse(localStorage.getItem(joinedKey(uid)) || "[]"); }catch{ return []; } }
  function progressKey(uid, courseId){ return `progress_v1_${uid || "anon"}_${courseId}`; }
  function readProgress(uid, courseId){ try{ return JSON.parse(localStorage.getItem(progressKey(uid, courseId)) || "{}"); }catch{ return {}; } }

  function normalizeCourse(raw){
    return {
      id: raw._id || raw.id || raw.courseId,
      title: raw.title || raw.name || "Nomsiz kurs",
      description: raw.description || raw.desc || "",
      type: (raw.type || (raw.isPaid ? "paid" : "free") || "free"),
      price: Number(raw.price ?? raw.cost ?? 0),
      status: raw.status || (raw.published ? "published" : "published"),
      faculty: raw.faculty || raw.facultyName || "",
      teacherName: raw.teacherName || raw.teacher?.fullname || raw.teacher?.name || raw.ownerName || "",
      testId: raw.testId || raw.test?._id || raw.test || ""
    };
  }

  async function apiMe(){
    const token = getToken();
    if(!token){ location.href="/login.html"; return null; }
    try{
      return await apiFetch("/api/me");
    }catch(e){
      localStorage.removeItem("token");
      location.href="/login.html";
      return null;
    }
  }

  async function fetchCourses(){
    try{
      const data = await apiFetch("/api/courses");
      const list = Array.isArray(data) ? data : (data.courses || []);
      return { list: list.map(normalizeCourse), mode:"API" };
    }catch(e){
      return { list: readDemoCourses().map(normalizeCourse), mode:"DEMO(localStorage)" };
    }
  }

  async function fetchProgress(courseId){
    try{
      const data = await apiFetch("/api/progress?courseId=" + encodeURIComponent(courseId));
      const done = Array.isArray(data.doneLessonIds) ? data.doneLessonIds : (Array.isArray(data.done) ? data.done : []);
      return { doneLessonIds: done.map(String), lastLessonId: String(data.lastLessonId || ""), totalLessons: Number(data.totalLessons || 0) };
    }catch(e){
      return null;
    }
  }

  function calcPercent(p){
    const total = Number(p.totalLessons || 0);
    const done = Array.isArray(p.doneLessonIds) ? p.doneLessonIds.length : 0;
    const pct = total ? Math.round((done / total) * 100) : 0;
    return { total, done, pct };
  }

  function makeBar(pct){
    return `<div class="bar"><div style="width:${pct}%"></div></div>`;
  }

  function setNextAction(next){
    if(!next){
      $("nextActionTxt").textContent = "Hozircha kurs yo‚Äòq. Kurslar sahifasidan kurs tanlang va qo‚Äòshiling.";
      $("continueBtn").href = "/courses.html";
      $("openCourseBtn").href = "/courses.html";
      return;
    }
    $("nextActionTxt").innerHTML = `Davom ettirish: <b>${next.title}</b> ‚Ä¢ progress: <b>${next.pct}%</b>`;
    $("continueBtn").href = "/joinedcourse.html?id=" + encodeURIComponent(next.courseId);
    $("openCourseBtn").href = "/course.html?id=" + encodeURIComponent(next.courseId);
  }

  async function init(){
    clearErr();
    const me = await apiMe();
    if(!me) return;

    const role = String(me.role || "student").toLowerCase();
    if(role !== "student"){
      location.href = role==="teacher" ? "/teacher-dashboard.html" : "/admin-dashboard.html";
      return;
    }

    const uid = me._id || me.id || me.username;
    const name = me.fullname || me.name || me.username || "‚Äî";
    $("mePill").textContent = `${name} ‚Ä¢ ${me.faculty || "‚Äî"} ‚Ä¢ ${me.group || "‚Äî"}`;
    $("mePill").style.display = "inline-flex";

    $("nameVal").textContent = name;
    $("facultyVal").textContent = me.faculty || "‚Äî";
    $("groupVal").textContent = me.group || "‚Äî";
    $("coinsVal").textContent = String(Number(me.coins ?? me.coin ?? 0));

    const { list: allCourses, mode } = await fetchCourses();
    $("modeTxt").textContent = "Rejim: " + mode;

    const joinedIds = readJoined(uid).map(String);
    const my = allCourses.filter(c=> joinedIds.includes(String(c.id)));
    $("joinedCount").textContent = String(my.length);

    // Render my courses with progress
    const wrap = $("myCourses");
    wrap.innerHTML = "";
    if(!my.length){
      wrap.innerHTML = `<div class="muted">Siz hali kursga qo‚Äòshilmagansiz. <a href="/courses.html"><b>Kurslar</b></a> sahifasiga o‚Äòting.</div>`;
      setNextAction(null);
      $("doneCount").textContent = "0";
      return;
    }

    let doneCount = 0;
    let bestNext = null; // highest priority: not completed + has lastLesson
    for(const c of my){
      // progress: try API; else localStorage
      let p = await fetchProgress(c.id);
      let pct = 0, done = 0, total = 0, lastLessonId = "";
      if(p){
        const calc = calcPercent(p);
        pct = calc.pct; done = calc.done; total = calc.total; lastLessonId = p.lastLessonId;
      }else{
        const lp = readProgress(uid, c.id);
        const doneIds = Array.isArray(lp.doneLessonIds) ? lp.doneLessonIds : [];
        // total unknown => use doneIds as rough, keep pct 0/100 only
        done = doneIds.length;
        total = Math.max(done, Number(lp.totalLessons || 0));
        pct = total ? Math.round((done/total)*100) : (done ? 100 : 0);
        lastLessonId = String(lp.lastLessonId || "");
      }

      if(pct >= 100) doneCount++;

      // next action selection:
      if(!bestNext && pct < 100) bestNext = { courseId:c.id, title:c.title, pct };
      else if(bestNext && bestNext.pct >= 100 && pct < 100) bestNext = { courseId:c.id, title:c.title, pct };

      const item = document.createElement("div");
      item.className = "courseItem";
      item.innerHTML = `
        <div style="flex:1; min-width:240px">
          <div class="title">${c.title}</div>
          <div class="tiny meta">${c.faculty || "‚Äî"} ‚Ä¢ Teacher: ${c.teacherName || "‚Äî"}</div>
          <div class="row" style="margin-top:8px">
            ${c.type==="paid" ? `<span class="tag paid">Pullik ‚Ä¢ ${Number(c.price||0)} coin</span>` : `<span class="tag free">Bepul</span>`}
            <span class="tag">Progress: ${pct}%</span>
          </div>
          <div class="progressRow">${makeBar(pct)}</div>
          <div class="tiny" style="margin-top:8px">Tugagan darslar: <b>${done}</b>${total ? ("/" + total) : ""}</div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <a class="btn small primary" href="/joinedcourse.html?id=${encodeURIComponent(c.id)}">Davom ettirish</a>
          <a class="btn small" href="/course.html?id=${encodeURIComponent(c.id)}">Info</a>
        </div>
      `;
      wrap.appendChild(item);
    }

    $("doneCount").textContent = String(doneCount);
    setNextAction(bestNext);
  }

  $("refreshBtn").addEventListener("click", ()=> init().catch(e=> setErr(e.message || "Xatolik")));
  init().catch(e=> setErr(e.message || "Xatolik"));
</script>
</body>
</html>
