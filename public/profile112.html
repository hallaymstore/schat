<!doctype html>
<html lang="uz" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profil ‚Äî SChat</title>

  <script>
    tailwind = { config: { darkMode:'class', theme:{ extend:{
      fontFamily:{ inter:['Inter','ui-sans-serif','system-ui'] },
      keyframes:{
        floaty:{'0%,100%':{transform:'translateY(0px)'},'50%':{transform:'translateY(-10px)'}},
        shimmer:{'0%':{backgroundPosition:'0% 50%'},'100%':{backgroundPosition:'100% 50%'}},
        pop:{'0%':{transform:'scale(.98)',opacity:'0'},'100%':{transform:'scale(1)',opacity:'1'}},
        blink:{'0%,92%,100%':{transform:'scaleY(1)'},'94%,98%':{transform:'scaleY(.08)'}},
        laser:{'0%':{transform:'scaleX(0)',opacity:'0'},'10%':{opacity:'1'},'55%':{transform:'scaleX(1)',opacity:'1'},'100%':{transform:'scaleX(0)',opacity:'0'}},
        hop:{'0%,100%':{transform:'translateY(0)'},'50%':{transform:'translateY(-14px)'}},
        aura:{'0%':{filter:'hue-rotate(0deg)'},'100%':{filter:'hue-rotate(360deg)'}}
      },
      animation:{
        floaty:'floaty 7s ease-in-out infinite',
        shimmer:'shimmer 7s ease-in-out infinite',
        pop:'pop .45s ease-out both',
        blink:'blink 6s ease-in-out infinite',
        laser:'laser 2.6s ease-in-out infinite',
        hop:'hop 1.6s ease-in-out infinite',
        aura:'aura 8s linear infinite'
      }
    }}}};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,.58);
      --glass-brd: rgba(255,255,255,.32);
      --muted: rgba(15,23,42,.72);
      --muted2: rgba(15,23,42,.55);
      --grid: rgba(15,23,42,.06);
      --ring: rgba(99,102,241,.45);
      --ok: rgba(34,197,94,.18);
      --bad: rgba(239,68,68,.18);
      --shadow: rgba(0,0,0,.22);
    }
    .dark{
      --glass-bg: rgba(2,6,23,.62);
      --glass-brd: rgba(148,163,184,.16);
      --muted: rgba(226,232,240,.78);
      --muted2: rgba(226,232,240,.55);
      --grid: rgba(148,163,184,.08);
      --ring: rgba(236,72,153,.35);
      --ok: rgba(34,197,94,.14);
      --bad: rgba(239,68,68,.14);
      --shadow: rgba(0,0,0,.52);
    }

    body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .glass{
      background: var(--glass-bg);
      border: 1px solid var(--glass-brd);
      box-shadow: 0 20px 60px var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .g-border{
      position:relative;
      overflow:hidden;
    }
    .g-border::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg, rgba(99,102,241,.9), rgba(236,72,153,.9), rgba(34,197,94,.7));
      filter: blur(14px);
      opacity:.35;
      z-index:0;
    }
    .g-border > *{ position:relative; z-index:1; }

    .btn-primary{ background: linear-gradient(135deg, rgba(99,102,241,1), rgba(236,72,153,1)); }
    .btn-primary:hover{ filter: brightness(1.05); }
    .btn-ghost:hover{ background: rgba(148,163,184,.12); }
    .glow-ring:focus{ outline:none; box-shadow: 0 0 0 5px var(--ring); }
    .chip{ background: rgba(148,163,184,.12); border: 1px solid rgba(148,163,184,.18); }
    .chip.active{ background: rgba(99,102,241,.18); border-color: rgba(99,102,241,.32); }

    /* Robot stage */
    .stage{
      position:relative;
      height: 300px;
      border-radius: 28px;
      overflow:hidden;
      border: 1px solid rgba(148,163,184,.18);
      background:
        radial-gradient(900px 550px at 15% 0%, rgba(99,102,241,.18), transparent 55%),
        radial-gradient(900px 550px at 85% 10%, rgba(236,72,153,.16), transparent 60%),
        radial-gradient(900px 550px at 50% 105%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0));
    }
    .dark .stage{
      background:
        radial-gradient(900px 550px at 15% 0%, rgba(99,102,241,.22), transparent 55%),
        radial-gradient(900px 550px at 85% 10%, rgba(236,72,153,.20), transparent 60%),
        radial-gradient(900px 550px at 50% 105%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(180deg, rgba(15,23,42,.32), rgba(2,6,23,.0));
    }
    .robot-wrap{
      position:absolute;
      left: 50%;
      top: 54%;
      transform: translate(-50%,-50%);
      width: 240px;
      height: 240px;
      pointer-events:none;
      filter: drop-shadow(0 20px 35px rgba(0,0,0,.28));
    }
    .robot-wrap .laser-beam{
      transform-origin: 0% 50%;
    }

    /* Variant visuals by typeId */
    .r-starter .core{ filter: saturate(1.08); }
    .r-pixel .core{ filter: contrast(1.1) saturate(1.3); image-rendering: pixelated; }
    .r-neo .shine{ opacity:.9; }
    .r-astro .stars{ opacity:1; }
    .r-mochi .core{ filter: saturate(1.2); }
    .r-lux .aura{ opacity:1; }
    .r-laser .laser-beam{ opacity:1; }
    .r-shade .glasses{ opacity:1; }
    .r-shade.glasses-off .glasses{ opacity:.08; transform: translateY(10px) rotate(8deg); }
    .r-mochi .squish{ animation: floaty 5.8s ease-in-out infinite; }
    .r-pixel .jitter{ animation: floaty 4.2s ease-in-out infinite; }
    .r-lux .aura{ animation: aura 8s linear infinite; }

    /* Companion bubble */
    .companion{
      position:absolute;
      right: 16px;
      bottom: 14px;
      min-width: 58px;
      height: 58px;
      border-radius: 18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 30px;
      background: rgba(255,255,255,.56);
      border: 1px solid rgba(255,255,255,.32);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      user-select:none;
    }
    .dark .companion{ background: rgba(2,6,23,.55); border-color: rgba(148,163,184,.16); }
    .companion.hop{ animation: hop 1.6s ease-in-out infinite; }
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 60;
      max-width: 420px;
    }
  </style>
</head>

<body class="min-h-screen text-slate-900 dark:text-slate-100">
  <div class="fixed inset-0 -z-10 pointer-events-none">
    <div class="absolute inset-0"
      style="background:
        radial-gradient(1200px 800px at 15% 10%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(1100px 740px at 85% 12%, rgba(236,72,153,.14), transparent 62%),
        radial-gradient(1000px 700px at 50% 95%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.58), rgba(255,255,255,.18));">
    </div>
    <div class="absolute inset-0 opacity-60"
      style="background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
        background-size: 48px 48px;">
    </div>
  </div>

  <header class="px-4 md:px-8 pt-6">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-3">
      <a href="/index.html" class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-2xl glass g-border grid place-items-center font-black">S</div>
        <div>
          <div class="font-black leading-tight">SChat</div>
          <div class="text-xs muted2 -mt-0.5">Profil va robotlar</div>
        </div>
      </a>

      <div class="flex items-center gap-2">
        <button id="themeBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-moon mr-2"></i>Rejim
        </button>
        <a href="/channels.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden sm:inline-flex">
          <i class="fa-solid fa-hashtag mr-2"></i>Kanallar
        </a>
        <a href="/groups.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden sm:inline-flex">
          <i class="fa-solid fa-users mr-2"></i>Guruhlar
        </a>
        <button id="logoutBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>Chiqish
        </button>
      </div>
    </div>
  </header>

  <main class="px-4 md:px-8 pb-16">
    <div class="max-w-6xl mx-auto mt-6 grid lg:grid-cols-12 gap-6">
      <!-- Left: Profile card -->
      <section class="lg:col-span-4 glass rounded-3xl p-6 g-border animate-pop">
        <div class="relative rounded-3xl overflow-hidden border border-white/20 dark:border-slate-700/30">
          <div id="cover" class="h-28 bg-gradient-to-r from-indigo-500/30 via-pink-500/25 to-emerald-500/25"></div>
          <div class="absolute -bottom-8 left-5 w-16 h-16 rounded-3xl overflow-hidden border-4 border-white/60 dark:border-slate-900/70 shadow-xl bg-white/30">
            <img id="avatar" alt="avatar" class="w-full h-full object-cover" src=""/>
          </div>
        </div>

        <div class="mt-10">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div id="name" class="text-xl font-black leading-tight">‚Äî</div>
              <div class="mt-1 flex flex-wrap items-center gap-2">
                <span id="uname" class="chip rounded-2xl px-3 py-1 text-xs font-extrabold">‚Äî</span>
                <span id="uni" class="chip rounded-2xl px-3 py-1 text-xs font-extrabold">‚Äî</span>
              </div>
              <div id="bio" class="mt-3 text-sm muted">‚Äî</div>
            </div>

            <div class="text-right">
              <div class="text-xs muted2">Holat</div>
              <div id="status" class="mt-1 text-sm font-extrabold">‚Äî</div>
              <div class="mt-2 text-xs muted2">Coin</div>
              <div class="text-lg font-black"><span id="coins">0</span> <span class="text-xs muted2 font-extrabold">coin</span></div>
            </div>
          </div>

          <div id="ownerTools" class="mt-5 flex flex-wrap gap-2 hidden">
            <a href="/add-funds.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary glow-ring text-white">
              <i class="fa-solid fa-coins mr-2"></i>Coin to‚Äòldirish
            </a>
            <a href="/petmarket.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-store mr-2"></i>Pet Market
            </a>
          </div>

          <div id="publicTools" class="mt-5 flex flex-wrap gap-2 hidden">
            <a id="dmBtn" href="/messages.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-paper-plane mr-2"></i>Yozish
            </a>
            <button id="pokeBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary glow-ring text-white">
              <i class="fa-solid fa-hand-sparkles mr-2"></i>Salom berish
            </button>
          </div>
        </div>
      </section>

      <!-- Right: Robot stage + collections -->
      <section class="lg:col-span-8 space-y-6">
        <!-- Stage -->
        <div class="glass rounded-3xl p-6 g-border animate-pop">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-black">Asosiy robotcha</div>
              <div id="robotSub" class="text-xs muted2 mt-1">Robotcha turi va animatsiyalari profilga bog‚Äòliq bo‚Äòladi.</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="playBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden">
                <i class="fa-solid fa-gamepad mr-2"></i>O‚Äòynash
              </button>
              <button id="toggleGlassesBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring hidden">
                <i class="fa-solid fa-glasses mr-2"></i>Ko‚Äòzoynak
              </button>
            </div>
          </div>

          <div class="mt-4 stage glass">
            <div id="robotWrap" class="robot-wrap r-starter">
              <!-- robot SVG injected -->
            </div>
            <div id="companionBubble" class="companion hidden">üêæ</div>
          </div>

          <div class="mt-4 grid sm:grid-cols-3 gap-3">
            <div class="glass rounded-2xl p-4">
              <div class="text-xs muted2 font-extrabold">Daraja</div>
              <div class="mt-1 text-xl font-black"><span id="level">1</span></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs muted2 font-extrabold">Yoqimtoylik</div>
              <div class="mt-1 text-xl font-black"><span id="cuteness">50</span><span class="text-xs muted2 font-extrabold ml-1">/100</span></div>
            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-xs muted2 font-extrabold">Hamroh</div>
              <div class="mt-1 text-xl font-black"><span id="companionName">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Robots collection -->
        <div class="glass rounded-3xl p-6 g-border animate-pop">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-black">Robotlar kolleksiyasi</div>
              <div class="text-xs muted2 mt-1">Asosiy robotchani tanlang yoki yangi robot sotib oling.</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="openShopBtn" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-primary glow-ring text-white hidden">
                <i class="fa-solid fa-bag-shopping mr-2"></i>Robot do‚Äòkoni
              </button>
            </div>
          </div>

          <div id="robotsGrid" class="mt-4 grid md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Companions collection -->
        <div class="glass rounded-3xl p-6 g-border animate-pop">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
              <div class="text-lg font-black">Hayvonchalar</div>
              <div class="text-xs muted2 mt-1">Pet Market‚Äôdan hamroh sotib oling va profilga qo‚Äòying.</div>
            </div>
            <a href="/petmarket.html" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring">
              <i class="fa-solid fa-paw mr-2"></i>Pet Market
            </a>
          </div>

          <div id="companionsGrid" class="mt-4 grid md:grid-cols-3 gap-4"></div>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast"></div>

<script>
  // ===== Theme =====
  const themeKey = 'theme';
  const root = document.documentElement;
  function setTheme(mode){
    if(mode === 'dark'){ root.classList.add('dark'); localStorage.setItem(themeKey,'dark'); }
    else { root.classList.remove('dark'); localStorage.setItem(themeKey,'light'); }
  }
  setTheme(localStorage.getItem(themeKey) || 'light');
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    setTheme(root.classList.contains('dark') ? 'light' : 'dark');
  });

  // ===== Auth helpers =====
  function token(){ return localStorage.getItem('token') || ''; }
  function authHeaders(json=true){
    const t = token();
    const h = { 'Authorization': `Bearer ${t}` };
    if(json) h['Content-Type'] = 'application/json';
    return h;
  }
  function goLogin(){ location.href = '/login.html'; }

  // ===== Toast =====
  function toast(msg, type='info'){
    const el = document.getElementById('toast');
    const bg = type==='error' ? 'rgba(239,68,68,.18)' : type==='success' ? 'rgba(34,197,94,.18)' : 'rgba(99,102,241,.14)';
    const br = type==='error' ? 'rgba(239,68,68,.30)' : type==='success' ? 'rgba(34,197,94,.26)' : 'rgba(99,102,241,.26)';
    el.innerHTML = `
      <div class="glass rounded-2xl p-4 g-border" style="background:${bg}; border-color:${br}">
        <div class="text-sm font-extrabold">${escapeHtml(msg)}</div>
      </div>`;
    setTimeout(()=>{ el.innerHTML=''; }, 3200);
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ===== Parse target profile =====
  const qs = new URLSearchParams(location.search);
  const qUserId = (qs.get('user') || qs.get('userId') || '').trim();
  const qUsername = (qs.get('u') || qs.get('username') || '').trim();

  const isValidObjectId = (v)=> /^[a-fA-F0-9]{24}$/.test(v);

  let me = null;
  let viewed = null;
  let isOwner = false;

  // Robot + companion state
  let catalog = [];
  let upgrades = {};
  let glassesOff = false;

  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('token');
    goLogin();
  });

  async function apiJson(url, opt={}){
    const res = await fetch(url, opt);
    const j = await res.json().catch(()=>null);
    if(!res.ok) throw new Error(j?.error || `Xatolik: ${res.status}`);
    return j;
  }

  async function loadMe(){
    const t = token();
    if(!t) return goLogin();
    const j = await apiJson('/api/me', { headers: authHeaders(false) });
    me = j.user;
    return me;
  }

  async function loadViewed(){
    // normalize: ignore null/undefined
    const uid = (qUserId === 'null' || qUserId === 'undefined') ? '' : qUserId;
    const un = (qUsername === 'null' || qUsername === 'undefined') ? '' : qUsername;

    if(un){
      const j = await apiJson('/api/user/by-username/' + encodeURIComponent(un), { headers: authHeaders(false) });
      viewed = j.user;
      return viewed;
    }
    if(uid && isValidObjectId(uid)){
      const j = await apiJson('/api/user/' + encodeURIComponent(uid), { headers: authHeaders(false) });
      viewed = j.user;
      return viewed;
    }
    viewed = me;
    return viewed;
  }

  function setProfileUI(u){
    document.getElementById('avatar').src = u.avatar || 'https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png';
    document.getElementById('cover').style.background = u.coverBanner
      ? `url('${u.coverBanner}') center/cover no-repeat`
      : 'linear-gradient(90deg, rgba(99,102,241,.26), rgba(236,72,153,.22), rgba(34,197,94,.20))';

    document.getElementById('name').textContent = u.fullName || u.nickname || 'Foydalanuvchi';
    document.getElementById('uname').textContent = '@' + (u.username || '');
    document.getElementById('uni').textContent = u.university || 'Universitet';
    document.getElementById('bio').textContent = u.bio || 'Bio yozilmagan.';
    document.getElementById('status').textContent = u.status || (u.isOnline ? 'online' : 'offline');

    // coins only for owner; otherwise hide precise number
    document.getElementById('coins').textContent = isOwner ? (me?.coins || 0) : '‚Äî';

    document.getElementById('ownerTools').classList.toggle('hidden', !isOwner);
    document.getElementById('publicTools').classList.toggle('hidden', isOwner);

    if(!isOwner){
      // DM link quick attach
      const dm = document.getElementById('dmBtn');
      dm.href = '/chat.html?u=' + encodeURIComponent(u.username || '');
    }
  }

  function robotSVG({ body='#6366f1', outfit='#ec4899', typeId='starter' }){
    // Layers toggled by CSS classes on wrapper
    return `
    <svg viewBox="0 0 240 240" width="240" height="240" aria-hidden="true">
      <defs>
        <linearGradient id="gBody" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="${body}" stop-opacity=".95"></stop>
          <stop offset="1" stop-color="${body}" stop-opacity=".55"></stop>
        </linearGradient>
        <linearGradient id="gOut" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="${outfit}" stop-opacity=".92"></stop>
          <stop offset="1" stop-color="${outfit}" stop-opacity=".55"></stop>
        </linearGradient>
        <radialGradient id="gShine" cx="30%" cy="25%" r="65%">
          <stop offset="0" stop-color="white" stop-opacity=".60"></stop>
          <stop offset="1" stop-color="white" stop-opacity="0"></stop>
        </radialGradient>
      </defs>

      <!-- Aura (lux) -->
      <g class="aura" opacity="0">
        <circle cx="120" cy="120" r="100" fill="none" stroke="rgba(236,72,153,.35)" stroke-width="10"></circle>
        <circle cx="120" cy="120" r="86" fill="none" stroke="rgba(99,102,241,.30)" stroke-width="8"></circle>
      </g>

      <!-- Stars (astro) -->
      <g class="stars" opacity="0">
        ${Array.from({length: 10}).map((_,i)=> {
          const x = 25 + (i*19)%190;
          const y = 20 + (i*29)%150;
          return `<circle cx="${x}" cy="${y}" r="${(i%3)+1}" fill="rgba(255,255,255,.55)"></circle>`;
        }).join('')}
      </g>

      <!-- Robot body -->
      <g class="core ${typeId==='mochi' ? 'squish':''} ${typeId==='pixel' ? 'jitter':''}">
        <rect x="44" y="58" width="152" height="150" rx="46" fill="url(#gBody)"></rect>
        <rect x="58" y="150" width="124" height="48" rx="24" fill="url(#gOut)"></rect>

        <!-- shine (neo) -->
        <path class="shine" opacity="0" d="M72 72 C120 40, 160 58, 176 98 C150 92, 118 96, 92 120 C76 106, 68 92, 72 72 Z" fill="url(#gShine)"></path>

        <!-- eyes -->
        <g transform="translate(0,0)">
          <rect x="78" y="104" width="34" height="20" rx="10" fill="rgba(2,6,23,.55)"></rect>
          <rect x="128" y="104" width="34" height="20" rx="10" fill="rgba(2,6,23,.55)"></rect>
          <circle class="eye" cx="95" cy="114" r="5" fill="rgba(255,255,255,.9)"></circle>
          <circle class="eye" cx="145" cy="114" r="5" fill="rgba(255,255,255,.9)"></circle>
          <g class="blink" style="transform-origin: 120px 114px" transform="translate(0,0)">
            <rect x="78" y="104" width="34" height="20" rx="10" fill="transparent"></rect>
          </g>
        </g>

        <!-- mouth -->
        <path d="M102 138 Q120 150 138 138" fill="none" stroke="rgba(2,6,23,.45)" stroke-width="6" stroke-linecap="round"></path>

        <!-- glasses (shade) -->
        <g class="glasses" opacity="0">
          <rect x="70" y="100" width="48" height="28" rx="12" fill="rgba(15,23,42,.45)" stroke="rgba(255,255,255,.35)" stroke-width="2"></rect>
          <rect x="122" y="100" width="48" height="28" rx="12" fill="rgba(15,23,42,.45)" stroke="rgba(255,255,255,.35)" stroke-width="2"></rect>
          <rect x="116" y="112" width="8" height="4" rx="2" fill="rgba(255,255,255,.35)"></rect>
        </g>

        <!-- antenna -->
        <circle cx="120" cy="52" r="8" fill="rgba(255,255,255,.55)"></circle>
        <rect x="118" y="52" width="4" height="10" rx="2" fill="rgba(255,255,255,.35)"></rect>
      </g>

      <!-- Laser beams (laser) -->
      <g class="laser-beam" opacity="0">
        <rect x="112" y="112" width="160" height="4" rx="2" fill="rgba(239,68,68,.85)"></rect>
        <rect x="112" y="116" width="160" height="2" rx="1" fill="rgba(255,255,255,.65)"></rect>
      </g>
    </svg>`;
  }

  function applyRobot(wrapper, robot){
    const typeId = robot?.typeId || 'starter';
    const body = robot?.baseColor || '#6366f1';
    const outfit = robot?.outfitColor || '#ec4899';

    wrapper.className = `robot-wrap r-${typeId}` + (typeId==='shade' && glassesOff ? ' glasses-off' : '');
    wrapper.innerHTML = robotSVG({ body, outfit, typeId });

    // Laser animation if laser robot
    const beam = wrapper.querySelector('.laser-beam');
    if(beam){
      beam.style.animation = 'laser 2.6s ease-in-out infinite';
    }
  }

  function applyCompanion(bubble, comp){
    if(!comp){ bubble.classList.add('hidden'); document.getElementById('companionName').textContent='‚Äî'; return; }
    bubble.classList.remove('hidden');
    bubble.textContent = comp.emoji || 'üêæ';
    document.getElementById('companionName').textContent = comp.name || 'Hamroh';
    bubble.classList.toggle('hop', (comp.typeId||'').includes('bunny'));
  }

  function renderRobotsGrid(u){
    const grid = document.getElementById('robotsGrid');
    const robots = u.robots || [];
    const activeId = u.activeRobotId || u.activeRobot?._id || '';
    if(robots.length === 0){
      grid.innerHTML = `<div class="glass rounded-2xl p-5 muted">Robot topilmadi.</div>`;
      return;
    }
    grid.innerHTML = robots.map(r => {
      const active = String(r._id) === String(activeId) || !!r.equipped;
      const priceTag = isOwner ? '' : '';
      const btn = isOwner ? `<button data-equip="${r._id}" class="equipBtn glass rounded-2xl px-4 py-2 text-sm font-extrabold ${active?'chip active':'btn-ghost'} glow-ring">${active?'Tanlangan':'Asosiy qilish'}</button>` : '';
      return `
        <div class="glass rounded-3xl p-5 border border-white/10 dark:border-slate-700/25">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black">${escapeHtml(r.name || 'Robotcha')}</div>
              <div class="text-xs muted2 mt-1">Turi: <span class="font-extrabold">${escapeHtml(r.typeId||'starter')}</span> ‚Ä¢ Daraja: <span class="font-extrabold">${r.level||1}</span></div>
              <div class="text-xs muted2 mt-1">Yoqimtoylik: <span class="font-extrabold">${r.cuteness||50}</span>/100</div>
            </div>
            <span class="chip rounded-2xl px-3 py-1 text-xs font-extrabold ${active?'active':''}">${active?'ACTIVE':'‚Äî'}</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${btn}
            ${isOwner ? `<button data-play="${r._id}" class="playBtn glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring"><i class="fa-solid fa-face-laugh-beam mr-2"></i>O‚Äòynatish</button>` : ''}
          </div>
        </div>
      `;
    }).join('');

    // bind
    grid.querySelectorAll('.equipBtn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const rid = b.getAttribute('data-equip');
        try{
          await apiJson('/api/robots/equip', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotId: rid }) });
          await refreshSelfAndRepaint();
          toast('Asosiy robotcha yangilandi', 'success');
        }catch(e){ toast(e.message, 'error'); }
      });
    });
    grid.querySelectorAll('.playBtn').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const rid = b.getAttribute('data-play');
        try{
          await apiJson('/api/robots/play', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotId: rid }) });
          sparkle();
          toast('Robotcha o‚Äòynadi!', 'success');
        }catch(e){ toast(e.message, 'error'); }
      });
    });
  }

  function renderCompanionsGrid(u){
    const grid = document.getElementById('companionsGrid');
    const comps = u.companions || [];
    const activeCid = u.activeCompanionId || u.activeCompanion?._id || '';
    if(comps.length === 0){
      grid.innerHTML = `<div class="glass rounded-2xl p-5 muted">Hozircha hayvoncha yo‚Äòq. <a class="underline font-extrabold" href="/petmarket.html">Pet Market</a> ga kiring.</div>`;
      return;
    }
    grid.innerHTML = comps.map(c=>{
      const active = String(c._id) === String(activeCid) || !!c.equipped;
      const btn = isOwner ? `<button data-cequip="${c._id}" class="cEquip glass rounded-2xl px-4 py-2 text-sm font-extrabold ${active?'chip active':'btn-ghost'} glow-ring">${active?'Tanlangan':'Hamroh qilish'}</button>` : '';
      return `
        <div class="glass rounded-3xl p-5 border border-white/10 dark:border-slate-700/25">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-2xl glass grid place-items-center text-2xl">${escapeHtml(c.emoji||'üêæ')}</div>
              <div>
                <div class="font-black">${escapeHtml(c.name||'Hamroh')}</div>
                <div class="text-xs muted2 mt-0.5">Rarity: <span class="font-extrabold">${escapeHtml(c.rarity||'common')}</span> ‚Ä¢ Mood +${c.moodBoost||0}</div>
              </div>
            </div>
            <span class="chip rounded-2xl px-3 py-1 text-xs font-extrabold ${active?'active':''}">${active?'ACTIVE':'‚Äî'}</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${btn}
            <button class="petPlay glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow-ring" data-petplay="${c.typeId||''}">
              <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>O‚Äòynash
            </button>
          </div>
        </div>
      `;
    }).join('');

    grid.querySelectorAll('.cEquip').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const cid = b.getAttribute('data-cequip');
        try{
          await apiJson('/api/companions/equip', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ companionId: cid }) });
          await refreshSelfAndRepaint();
          toast('Hamroh yangilandi', 'success');
        }catch(e){ toast(e.message, 'error'); }
      });
    });
    grid.querySelectorAll('.petPlay').forEach(b=>{
      b.addEventListener('click', ()=>{
        const typeId = b.getAttribute('data-petplay') || '';
        // local-only micro animation
        const bubble = document.getElementById('companionBubble');
        bubble.classList.add('hop');
        setTimeout(()=>bubble.classList.remove('hop'), 1800);
        toast('Hamroh xursand bo‚Äòldi!', 'success');
      });
    });
  }

  function sparkle(){
    // lightweight stage sparkle
    const stage = document.querySelector('.stage');
    const s = document.createElement('div');
    s.style.position='absolute';
    s.style.inset='0';
    s.style.pointerEvents='none';
    s.style.background='radial-gradient(8px 8px at 20% 30%, rgba(255,255,255,.55), transparent 60%), radial-gradient(8px 8px at 65% 40%, rgba(255,255,255,.45), transparent 60%), radial-gradient(10px 10px at 40% 75%, rgba(255,255,255,.50), transparent 60%)';
    s.style.opacity='0';
    s.style.transition='opacity .25s ease';
    stage.appendChild(s);
    requestAnimationFrame(()=>{ s.style.opacity='1'; });
    setTimeout(()=>{ s.style.opacity='0'; setTimeout(()=>s.remove(), 250); }, 650);
  }

  async function refreshSelfAndRepaint(){
    await loadMe();
    // if viewing self, keep it in sync
    if(isOwner) viewed = me;
    paint();
  }

  function paint(){
    setProfileUI(viewed);

    const activeRobot = viewed.activeRobot || (viewed.robots||[]).find(r => String(r._id) === String(viewed.activeRobotId)) || (viewed.robots||[]).find(r=>r.equipped) || (viewed.robots||[])[0] || null;
    const wrap = document.getElementById('robotWrap');
    if(activeRobot){
      applyRobot(wrap, activeRobot);
      document.getElementById('level').textContent = activeRobot.level || 1;
      document.getElementById('cuteness').textContent = activeRobot.cuteness || 50;
      document.getElementById('robotSub').textContent = `${activeRobot.name || 'Robotcha'} ‚Äî tur: ${activeRobot.typeId || 'starter'}`;
    } else {
      wrap.innerHTML = '';
    }

    const activeCompanion = viewed.activeCompanion || (viewed.companions||[]).find(c => String(c._id)===String(viewed.activeCompanionId)) || (viewed.companions||[]).find(c=>c.equipped) || (viewed.companions||[])[0] || null;
    applyCompanion(document.getElementById('companionBubble'), activeCompanion);

    renderRobotsGrid(viewed);
    renderCompanionsGrid(viewed);

    // Special buttons
    const playBtn = document.getElementById('playBtn');
    playBtn.classList.toggle('hidden', !isOwner);
    playBtn.onclick = async ()=>{
      try{
        if(!activeRobot?._id) return;
        await apiJson('/api/robots/play', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ robotId: activeRobot._id }) });
        sparkle();
        toast('Robotcha o‚Äòynadi!', 'success');
      }catch(e){ toast(e.message,'error'); }
    };

    const gBtn = document.getElementById('toggleGlassesBtn');
    const isShade = (activeRobot?.typeId === 'shade');
    gBtn.classList.toggle('hidden', !(isShade && (isOwner || true)));
    gBtn.onclick = ()=>{
      glassesOff = !glassesOff;
      paint();
    };
  }

  async function loadRobotCatalog(){
    try{
      const j = await apiJson('/api/robots/catalog', { headers: authHeaders(false) });
      catalog = j.catalog || [];
      upgrades = j.upgrades || {};
    }catch(e){
      // ignore for public viewing
    }
  }

  function openRobotShop(){
    // Simple inline shop: replace robotsGrid header portion with catalog cards temporarily
    const grid = document.getElementById('robotsGrid');
    const cards = (catalog||[]).map(it=>{
      const owned = (me?.robots||[]).some(r => r.typeId === it.id);
      const disabled = owned || (me?.coins||0) < (it.price||0);
      return `
        <div class="glass rounded-3xl p-5 border border-white/10 dark:border-slate-700/25">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-black">${escapeHtml(it.name)}</div>
              <div class="text-xs muted2 mt-1">${escapeHtml(it.desc||'')}</div>
              <div class="text-xs muted2 mt-2">Rarity: <span class="font-extrabold">${escapeHtml(it.rarity||'common')}</span> ‚Ä¢ Yoqimtoylik: <span class="font-extrabold">${it.baseCuteness||50}</span></div>
            </div>
            <span class="chip rounded-2xl px-3 py-1 text-xs font-extrabold">${it.price||0} coin</span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            <button data-buyrobot="${it.id}" class="buyRobot glass rounded-2xl px-4 py-2 text-sm font-extrabold ${disabled?'chip':'btn-primary text-white'} glow-ring" ${disabled?'disabled':''}>
              ${owned ? 'Sizda bor' : ((me?.coins||0) < (it.price||0) ? 'Coin yetarli emas' : 'Sotib olish')}
            </button>
          </div>
        </div>
      `;
    }).join('');
    grid.innerHTML = cards + `<div class="md:col-span-2"><button id="closeShop" class="glass rounded-2xl px-5 py-3 text-sm font-extrabold btn-ghost glow-ring w-full"><i class="fa-solid fa-arrow-left mr-2"></i>Kolleksiyaga qaytish</button></div>`;

    grid.querySelectorAll('.buyRobot').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const id = b.getAttribute('data-buyrobot');
        try{
          await apiJson('/api/robots/buy', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ typeId: id }) });
          await refreshSelfAndRepaint();
          toast('Robot sotib olindi!', 'success');
          openRobotShop(); // refresh view
        }catch(e){ toast(e.message,'error'); }
      });
    });
    const close = document.getElementById('closeShop');
    close.onclick = ()=> paint();
  }

  // Public poke interaction (local effect)
  document.getElementById('pokeBtn').addEventListener('click', ()=>{
    sparkle();
    toast('Salom! Robotcha sizni sezdi.', 'success');
  });

  async function init(){
    try{
      await loadMe();
      await loadRobotCatalog();
      await loadViewed();

      isOwner = (viewed?._id && me?._id && String(viewed._id) === String(me._id));
      // owner tools
      document.getElementById('openShopBtn').classList.toggle('hidden', !isOwner);
      document.getElementById('openShopBtn').onclick = openRobotShop;

      // load accurate coin for owner
      if(isOwner){
        document.getElementById('ownerTools').classList.remove('hidden');
      }

      paint();
    } catch (e){
      console.error(e);
      if(String(e?.message||'').toLowerCase().includes('authentication')) goLogin();
      toast(e.message || 'Profilni yuklab bo‚Äòlmadi', 'error');
    }
  }

  init();
</script>
</body>
</html>
