<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dars jadvali • UniConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body{background: radial-gradient(1200px 600px at 12% 12%, rgba(99,102,241,.22), transparent 60%),
                 radial-gradient(900px 520px at 88% 18%, rgba(236,72,153,.16), transparent 60%),
                 radial-gradient(1000px 700px at 50% 92%, rgba(34,197,94,.12), transparent 60%),
                 linear-gradient(180deg, rgba(248,250,252,1), rgba(241,245,249,1));
         background-attachment: fixed;}
  </style>
  <link rel="stylesheet" href="/ui-glass-theme.css" />
</head>
<body class="min-h-screen">
  <nav class="sticky top-0 z-50 bg-white/70 backdrop-blur border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
      <a href="/index.html" class="flex items-center gap-2 font-bold text-gray-800">
        <i class="fa-solid fa-calendar-days text-indigo-600"></i>
        Dars jadvali
      </a>
      <div class="flex items-center gap-3">
        <a href="/lives.html" class="text-sm font-semibold text-gray-700 hover:text-indigo-600"><i class="fa-solid fa-broadcast-tower mr-2"></i>Lives</a>
        <button onclick="logout()" class="text-sm font-semibold text-gray-700 hover:text-rose-600"><i class="fa-solid fa-right-from-bracket mr-2"></i>Chiqish</button>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Kelgusi darslar va rejalashtirilgan jonli darslar</h1>
        <p class="text-gray-600 mt-1">Teacher rejalashtirgan live darslar shu yerda chiqadi. Live boshlangan bo‘lsa “Kirish” tugmasi faollashadi.</p>
      </div>
      <div class="flex gap-2">
        <input id="q" class="w-full md:w-80 px-4 py-2 rounded-xl border border-gray-200 bg-white/80 outline-none focus:ring-4 focus:ring-indigo-200"
               placeholder="Qidirish: matematika, fizika, ..." />
        <button onclick="load()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700">
          <i class="fa-solid fa-magnifying-glass mr-2"></i>Izlash
        </button>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section class="lg:col-span-2">
        <div class="bg-white/70 backdrop-blur border border-gray-200 rounded-2xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="font-extrabold text-gray-900">Jadval</h2>
            <div class="text-sm text-gray-600" id="meta"></div>
          </div>
          <div class="mt-4 space-y-3" id="list"></div>
        </div>
      </section>

      <aside>
        <div class="bg-white/70 backdrop-blur border border-gray-200 rounded-2xl p-4">
          <h2 class="font-extrabold text-gray-900">Ko‘rsatmalar</h2>
          <ul class="mt-3 text-sm text-gray-700 space-y-2">
            <li>• Dars jadvali API: <code class="bg-gray-100 px-2 py-1 rounded">GET /api/lives</code></li>
            <li>• Teacher rejalashtiradi: <code class="bg-gray-100 px-2 py-1 rounded">POST /api/lives</code> (role=teacher)</li>
            <li>• Teacher boshlaydi: <code class="bg-gray-100 px-2 py-1 rounded">POST /api/lives/:id/start</code></li>
            <li>• Student kiradi: <code class="bg-gray-100 px-2 py-1 rounded">POST /api/lives/:id/enter</code></li>
          </ul>
          <div class="mt-4 text-xs text-gray-500">
            Eslatma: bu sahifa “courseId” bo‘yicha filtrni ham qo‘llab-quvvatlaydi (URL: <code>?courseId=...</code>).
          </div>
        </div>
      </aside>
    </div>
  </main>

<script>
  function logout(){
    localStorage.removeItem('token');
    location.href='/login.html';
  }

  function fmt(dt){
    const d = new Date(dt);
    return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }

  function pill(text, cls){
    return `<span class="px-2 py-1 rounded-full text-xs font-extrabold ${cls}">${text}</span>`;
  }

  async function api(path){
    const token = localStorage.getItem('token');
    if(!token){ location.href='/login.html'; return; }
    const res = await fetch(path, { headers: { 'Authorization': 'Bearer ' + token }});
    if(res.status===401 || res.status===403){ localStorage.removeItem('token'); location.href='/login.html'; return; }
    return res;
  }

  async function load(){
    const q = document.getElementById('q').value.trim();
    const courseId = new URLSearchParams(location.search).get('courseId') || '';
    const params = new URLSearchParams();
    // show both scheduled + live (upcoming + currently live)
    // If backend supports single status filter, we just fetch twice.
    const res1 = await api('/api/lives?status=scheduled' + (courseId?'&courseId='+encodeURIComponent(courseId):'') + (q?'&q='+encodeURIComponent(q):''));
    const res2 = await api('/api/lives?status=live' + (courseId?'&courseId='+encodeURIComponent(courseId):'') + (q?'&q='+encodeURIComponent(q):''));
    if(!res1 || !res2) return;
    const a = await res1.json();
    const b = await res2.json();

    const lives = ([]).concat(a.lives||[], b.lives||[]);
    lives.sort((x,y)=> new Date(x.startAt||x.createdAt||0) - new Date(y.startAt||y.createdAt||0));

    document.getElementById('meta').textContent = lives.length + " ta dars";

    const list = document.getElementById('list');
    if(!lives.length){
      list.innerHTML = '<div class="text-gray-500 text-sm p-4 text-center">Hozircha rejalashtirilgan darslar yo‘q.</div>';
      return;
    }

    list.innerHTML = lives.map(l=>{
      const isLive = l.status === 'live';
      const when = l.startAt ? fmt(l.startAt) : (l.createdAt ? fmt(l.createdAt) : '');
      const badges = [
        isLive ? pill('LIVE', 'bg-rose-100 text-rose-700') : pill('Scheduled', 'bg-indigo-100 text-indigo-700'),
        l.type === 'paid' ? pill((l.price||0) + ' coin', 'bg-amber-100 text-amber-700') : pill('Free', 'bg-emerald-100 text-emerald-700')
      ].join(' ');

      const action = isLive
        ? `<a class="px-4 py-2 rounded-xl bg-rose-600 text-white font-bold hover:bg-rose-700" href="/live.html?id=${l._id}">
             <i class="fa-solid fa-door-open mr-2"></i>Kirish
           </a>`
        : `<a class="px-4 py-2 rounded-xl bg-gray-900 text-white font-bold hover:bg-black" href="/lives.html">
             <i class="fa-solid fa-eye mr-2"></i>Batafsil
           </a>`;

      return `
        <div class="p-4 rounded-2xl border border-gray-200 bg-white">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="flex items-center gap-2">${badges}</div>
              <div class="mt-2 text-lg font-extrabold text-gray-900">${(l.title||'Live dars')}</div>
              <div class="text-sm text-gray-600 mt-1">${when ? ('⏰ ' + when) : ''}</div>
              ${l.description ? `<div class="text-sm text-gray-700 mt-2">${l.description}</div>` : ``}
            </div>
            <div class="shrink-0">${action}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  (async function init(){
    const token = localStorage.getItem('token');
    if(!token){ location.href='/login.html'; return; }
    await load();
  })();
</script>
  <script src="/ui-actions-menu.js" defer></script>
</body>
</html>

